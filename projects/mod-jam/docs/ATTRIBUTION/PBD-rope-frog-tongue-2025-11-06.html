
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <title>PBD rope frog tongue</title>
          <style>
            :root {
              --primary-color: #FFF;
              --user-color: #303030;
              --font-size: 16px;
              --font-weight: 600;
              --line-height: 28px;

            }
          
            body {
              font-family: ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica,Apple Color Emoji,Arial,sans-serif,Segoe UI Emoji,Segoe UI Symbol;
              font-size: var(--font-size);
              background-color: #212121;
              color: var(--primary-color);
              padding: 20px;
              margin: 0 auto;
              line-height: 1.5;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px dashed var(--primary-color);
              padding-bottom: 15px;
              max-width: 1200px;
              margin-left: auto;
              margin-right: auto;
            }
            .title {
              font-size: 24px;
              font-weight: bold;
              margin: 0;
              text-transform: uppercase;
              letter-spacing: 2px;
            }
            .timestamp {
              color: #FFF;
              font-size: 14px;
              margin-top: 10px;
            }
            .conversation {
              max-width: 900px;
              margin: 0 auto;
              padding: 20px;
            }
            .message {
              margin-bottom: 20px;
              padding: 10px 20px;
              border-radius: 18px;
              width: fit-content;
              max-width: 80%;
              clear: both;
              overflow: hidden;
            }
            .user-message {
              float: right;
              background-color: #303030;
            }
            .assistant-message {
              float: left;
            }
            .role {
              font-weight: bold;
              margin-bottom: 5px;
              text-transform: uppercase;
            }
            .user-message .role {
              color: #ff3333;
              text-align: right;
            }
            .assistant-message .role {
              color: var(--primary-color);
            }
            .content {
              user-select: text;
              word-wrap: break-word;
            }
            table {
              border-bottom-color: rgba(13, 13, 13, 0.05);
              border-bottom-style: solid;
              border-bottom-width: 0px;
              border-collapse: separate;
              border-image-outset: 0;
              border-image-repeat: stretch;
              border-image-slice: 100%;
              border-image-source: none;
              border-image-width: 1;
              border-left-color: rgba(13, 13, 13, 0.05);
              border-left-style: solid;
              border-left-width: 0px;
              border-right-color: rgba(13, 13, 13, 0.05);
              border-right-style: solid;
              border-right-width: 0px;
              border-spacing: 0px;
              border-top-color: rgba(13, 13, 13, 0.05);
              border-top-style: solid;
              border-top-width: 0px;
              box-sizing: border-box;
              color: rgb(13, 13, 13);
              color-scheme: light;
              font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Helvetica, Apple Color Emoji, Arial, sans-serif, Segoe UI Emoji, Segoe UI Symbol;
              font-feature-settings: normal;
              font-size: 14px;
              font-variation-settings: normal;
              line-height: 24px;
              margin-bottom: 0px;
              margin-left: 0px;
              margin-right: 0px;
              margin-top: 0px;
              min-width: 768px;
              overflow-wrap: break-word;
              padding-bottom: 0px;
              padding-left: 0px;
              padding-right: 0px;
              padding-top: 0px;
              pointer-events: auto;
              scrollbar-color: auto;
              tab-size: 4;
              table-layout: auto;
              text-align: start;
              text-indent: 0px;
              text-wrap-mode: wrap;
              white-space-collapse: collapse;
              width: 768px;
            }
            th, td {
                border: 1px solid var(--primary-color);
                text-align: center;
                height: 30px;
                vertical-align: middle;
                padding: 0 10px;
                border-bottom-color: rgba(255, 255, 255, 0.05);
                border-bottom-style: solid;
                border-bottom-width: 1px;
                border-collapse: separate;
                border-image-outset: 0;
                border-image-repeat: stretch;
                border-image-slice: 100%;
                border-image-source: none;
                border-image-width: 1;
                border-left-color: rgba(255, 255, 255, 0.05);
                border-left-style: solid;
                border-left-width: 0px;
                border-right-color: rgba(255, 255, 255, 0.05);
                border-right-style: solid;
                border-right-width: 0px;
                border-spacing: 0px;
                border-top-color: rgba(255, 255, 255, 0.05);
                border-top-style: solid;
                border-top-width: 0px;
                box-sizing: border-box;
                color: #FFF;
                color-scheme: light;
                font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Helvetica, Apple Color Emoji, Arial, sans-serif, Segoe UI Emoji, Segoe UI Symbol;
                font-feature-settings: normal;
                font-size: 14px;
                font-variation-settings: normal;
                font-weight: 600;
                line-height: 16px;
                margin-bottom: 0px;
                margin-left: 0px;
                margin-right: 0px;
                margin-top: 0px;
                max-width: 192px;
                min-width: 128px;
                overflow-wrap: break-word;
                padding-bottom: 12px;
                padding-inline-end: 24px;
                padding-inline-start: 0px;
                padding-left: 0px;
                padding-right: 24px;
                padding-top: 12px;
                pointer-events: auto;
                scrollbar-color: auto;
                tab-size: 4;
                text-align: start;
                text-indent: 0px;
                text-wrap-mode: wrap;
                vertical-align: bottom;
                white-space-collapse: collapse;
            }
              hr{
                border-bottom-color: rgba(255, 255, 255, 0.05);
                border-bottom-style: solid;
                border-bottom-width: 0px;
                border-image-outset: 0;
                border-image-repeat: stretch;
                border-image-slice: 100%;
                border-image-source: none;
                border-image-width: 1;
                border-left-color: rgba(255, 255, 255, 0.05);
                border-left-style: solid;
                border-left-width: 0px;
                border-right-color: rgba(255, 255, 255, 0.05);
                border-right-style: solid;
                border-right-width: 0px;
                border-top-color: rgba(255, 255, 255, 0.05);
                border-top-style: solid;
                border-top-width: 1px;
                box-sizing: border-box;
                clear: both;
                color: #FFF;
                color-scheme: light;
                font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Helvetica, Apple Color Emoji, Arial, sans-serif, Segoe UI Emoji, Segoe UI Symbol;
                font-feature-settings: normal;
                font-size: 16px;
                font-variation-settings: normal;
                height: 1px;
                line-height: 28px;
                margin-bottom: 28px;
                margin-left: 0px;
                margin-right: 0px;
                margin-top: 28px;
                overflow-wrap: break-word;
                padding-bottom: 0px;
                padding-left: 0px;
                padding-right: 0px;
                padding-top: 0px;
                scrollbar-color: auto;
                tab-size: 4;
                text-align: start;
                text-wrap-mode: wrap;
                white-space-collapse: collapse;
              }
              blockquote{
                border-bottom-color: rgba(13, 13, 13, 0.05);
                border-bottom-style: solid;
                border-bottom-width: 0px;
                border-image-outset: 0;
                border-image-repeat: stretch;
                border-image-slice: 100%;
                border-image-source: none;
                border-image-width: 1;
                border-inline-start-color: oklch(0.928 0.006 264.531);
                border-inline-start-width: 0px;
                border-left-color: oklch(0.928 0.006 264.531);
                border-left-style: solid;
                border-left-width: 0px;
                border-right-color: rgba(13, 13, 13, 0.05);
                border-right-style: solid;
                border-right-width: 0px;
                border-top-color: rgba(13, 13, 13, 0.05);
                border-top-style: solid;
                border-top-width: 0px;
                box-sizing: border-box;
                color: #FFF;
                color-scheme: light;
                font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Helvetica, Apple Color Emoji, Arial, sans-serif, Segoe UI Emoji, Segoe UI Symbol;
                font-feature-settings: normal;
                font-size: 16px;
                font-style: normal;
                font-variation-settings: normal;
                font-weight: 500;
                line-height: 24px;
                margin-bottom: 8px;
                margin-left: 0px;
                margin-right: 0px;
                margin-top: 0px;
                overflow-wrap: break-word;
                padding-bottom: 8px;
                padding-inline-start: 24px;
                padding-left: 24px;
                padding-right: 0px;
                padding-top: 8px;
                position: relative;
                quotes: "‚Äú" "‚Äù" "‚Äò" "‚Äô";
                scrollbar-color: auto;
                tab-size: 4;
                text-align: start;
                text-wrap-mode: wrap;
                white-space-collapse: collapse;
            }
            .content h1 { font-size: 24px; margin: 0.67em 0; }
            .content h2 { font-size: 20px; margin: 0.75em 0; }
            .content h3 { font-size: 18px; margin: 0.83em 0; }
            .content h4 { font-size: 16px; margin: 1.12em 0; }
            .content h5 { font-size: 14px; margin: 1.5em 0; }
            .content h6 { font-size: 12px; margin: 1.67em 0; }
            .code-block {
              background-color: #2a2a2a !important;
              color: #fff !important;
              padding: 15px !important;
              margin: 10px 0 !important;
              border-radius: 5px !important;
              border: 1px solid var(--primary-color) !important;
              font-family: "Courier New", monospace !important;
              overflow-x: auto !important;
              width: auto !important;
              max-width: 100% !important;
              box-sizing: border-box !important;
            }
            li{
              margin:15px 0;
            }
            .inline-code{
              background: #303030;
              color: #FFF;
              padding:2px 5px;
            }
            code{
              background: #303030;
              color: #FFF;
              padding:2px 5px;
              border-radius: .25rem;
            }
            /* Basic highlight.js theme */
            .hljs {
              background: transparent;
              color: #fff;
            }
            .hljs-keyword { color: #ff79c6; }
            .hljs-string { color: #f1fa8c; }
            .hljs-number { color: #bd93f9; }
            .hljs-function { color: #50fa7b; }
            .hljs-comment { color: #6272a4; }
            .hljs-title { color: #50fa7b; }
            .hljs-params { color: #f8f8f2; }
            .hljs-built_in { color: #8be9fd; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1 class="title">PBD rope frog tongue</h1>
            <div class="timestamp">[2025-11-05, 10:05:16 p.m.]</div>
          </div>
          <div class="conversation">
    
        <div class="message user-message">
          <div class="content">Can you implement a Position-Based Dynamics (PBD) rope in p5js?
The goal is to simulate a frog tongue</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Heck yes üê∏‚Äîhere‚Äôs a clean, fast Position-Based Dynamics (PBD) rope in p5.js set up as a frog tongue. It uses Verlet integration, iterative constraint solving (stretch + soft bending), optional collisions, and a ‚Äústick &amp; retract‚Äù catch mechanic.</p>
<ul>
<li>
<p>Click anywhere to aim.</p>
</li>
<li>
<p>Press <strong>Space</strong> to shoot the tongue (extend).</p>
</li>
<li>
<p>Press <strong>R</strong> to retract (or it retracts automatically after sticking).</p>
</li>
<li>
<p>Toggle <strong>B</strong> to show the constraint/bone debug.</p>
</li>
<li>
<p>Resize window works.</p>
</li>
</ul>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js
 * -------------------------------------------------------
 * Controls:
 *  - Click: aim target
 *  - Space: shoot / extend tongue toward target
 *  - R: retract (manual)
 *  - B: toggle debug bones
 *
 * Mechanics:
 *  - Verlet integration for particles
 *  - Distance constraints (stretch) + soft bend (2nd neighbor)
 *  - Pin constraint at "mouth"
 *  - Length scaling for extend/retract
 *  - Optional collision + sticky catch (bring prey back)
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;      <span class="hljs-comment">// pin position</span>
<span class="hljs-keyword">let</span> target;         <span class="hljs-comment">// where we shoot</span>
<span class="hljs-keyword">let</span> fly;            <span class="hljs-comment">// prey object (circle)</span>
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// improves consistency across displays &amp; perf</span>
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  <span class="hljs-comment">// Create the rope with N segments</span>
  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,            <span class="hljs-comment">// base segment length (before scaling)</span>
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,     <span class="hljs-comment">// 0..1 (PBD positional stiffness)</span>
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,       <span class="hljs-comment">// 0..1 (soft bending via 2nd-neighbor)</span>
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,             <span class="hljs-comment">// constraint solver iterations per substep</span>
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,               <span class="hljs-comment">// integration/solve substeps per frame</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,             <span class="hljs-comment">// 0..1 damping for Verlet velocity</span>
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,             <span class="hljs-comment">// max extension multiplier</span>
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,       <span class="hljs-comment">// per frame scale shrink</span>
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,         <span class="hljs-comment">// per frame scale growth when shooting</span>
  });

  <span class="hljs-comment">// A fly we can catch</span>
  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>,
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);

  <span class="hljs-comment">// Aim line to the mouse for convenience</span>
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  <span class="hljs-comment">// Drive rope (extend/retract + simulate)</span>
  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-comment">// Handle collision/catch with the fly</span>
  <span class="hljs-title function_">handleFlyCatch</span>();

  <span class="hljs-comment">// Draw everything</span>
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-comment">// Keep the mouth roughly in the same relative place</span>
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-comment">// -------------------------------------------------------</span>
<span class="hljs-comment">// Input</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    rope.<span class="hljs-title function_">shootToward</span>(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'R'</span> || key === <span class="hljs-string">'r'</span>) {
    rope.<span class="hljs-title function_">startRetract</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// -------------------------------------------------------</span>
<span class="hljs-comment">// Simple prey that can get stuck to the tongue tip</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// if currently stuck</span>
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Minimal floating motion when not stuck</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-comment">// bounce off walls</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// -------------------------------------------------------</span>
<span class="hljs-comment">// Rope (PBD)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-comment">// Particles</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = []; <span class="hljs-comment">// 0 for pinned, 1 for free</span>
    <span class="hljs-comment">// Build a straight rope from mouth</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// State</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.22</span>;             <span class="hljs-comment">// start short (coiled tongue)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetScale</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>; <span class="hljs-comment">// smoothed toward desired</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// Catch state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;      <span class="hljs-comment">// how long we stay stuck before retract</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// pin tip to fly position when caught</span>
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }

  <span class="hljs-comment">// Public controls</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-comment">// Extend fast toward a direction; we only lengthen rope, constraints do the rest</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetScale</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>;
  }
  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetScale</span> = <span class="hljs-number">0.22</span>;
  }

  <span class="hljs-comment">// High level per-frame driver</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-comment">// Smoothly approach target scale based on shooting/retracting flags</span>
    <span class="hljs-keyword">const</span> speed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>;
    <span class="hljs-keyword">const</span> dir = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> += dir * speed;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-number">0.12</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);

    <span class="hljs-comment">// Auto retract if we‚Äôre stuck to something</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }

    <span class="hljs-comment">// Stop shooting when fully extended</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span> * <span class="hljs-number">0.999</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// Stop retracting when short</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.13</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// PBD simulate</span>
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> substeps = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; substeps; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// pinned</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// Verlet step</span>
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// Keep mouth pinned to frogMouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

    <span class="hljs-comment">// If tip is pinned to a caught object, enforce it pre-solve</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
      <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> stretchK = <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>;
    <span class="hljs-keyword">const</span> bendK = <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) Pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 2) Stretch constraints (distance between neighbors)</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, stretchK);
      }

      <span class="hljs-comment">// 3) Soft bend (keep second-neighbor distance ~ 2 * segRest)</span>
      <span class="hljs-comment">//    This is a simple way to resist hairpin bends without angle math.</span>
      <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, bendK);
      }

      <span class="hljs-comment">// Re-apply pins</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
      }
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>();
  }

  <span class="hljs-comment">// Attach tip to a world-space point (e.g., fly)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params">p</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = p.<span class="hljs-title function_">copy</span>();
    <span class="hljs-comment">// set invMass=0 for the tip while pinned</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>] = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// Release tip pin</span>
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>] = <span class="hljs-number">1</span>;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// tongue body (triangle strip-ish look)</span>
    <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>; <span class="hljs-comment">// visual thickness</span>
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();

    <span class="hljs-comment">// Draw as quads per segment with soft hue gradient</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> t = i / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-comment">// pinkish to red</span>
      <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

      <span class="hljs-comment">// local normal</span>
      <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
      <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
      <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

      <span class="hljs-title function_">quad</span>(
        a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
        a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
      );

      <span class="hljs-keyword">if</span> (debugBones) {
        <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
        <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
        <span class="hljs-title function_">noStroke</span>();
      }
    }

    <span class="hljs-comment">// tip ‚Äústicky‚Äù bulb</span>
    <span class="hljs-keyword">const</span> tip = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>];
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

    <span class="hljs-comment">// mouth</span>
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// -------------------------------------------------------</span>
<span class="hljs-comment">// Fly Catch Logic</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-comment">// If already stuck, keep the fly on the tongue tip, pulled home</span>
  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipPinnedTo</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(rope.<span class="hljs-title function_">tipPos</span>());
    <span class="hljs-comment">// When retract completes, release fly near mouth (simulate swallow)</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.15</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Check collision between tip and fly</span>
    <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipPinnedTo</span>) {
      <span class="hljs-comment">// stick!</span>
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>(fly.<span class="hljs-property">p</span>);
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      <span class="hljs-comment">// start retract immediately upon catch</span>
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  }
}

<span class="hljs-comment">// -------------------------------------------------------</span>
<span class="hljs-comment">// Scene/UX helpers</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground plane</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// draw rope last so it‚Äôs on top</span>
  rope.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// draw fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">280</span>, <span class="hljs-number">92</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue"</span>,
      <span class="hljs-string">"Click: Aim   Space: Shoot   R: Retract   B: Debug"</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>How it works (quick gist)</h3>
<ul>
<li>
<p><strong>Particles:</strong> one per node; the mouth is pinned (invMass=0), the rest are free.</p>
</li>
<li>
<p><strong>Verlet integration:</strong> stable, cheap; airDrag damps velocity.</p>
</li>
<li>
<p><strong>Constraints:</strong> distance constraints enforce segment lengths (scaled by <code>scale</code>), and a 2nd-neighbor distance enforces a soft bend stiffness.</p>
</li>
<li>
<p><strong>Extend/Retraction:</strong> we scale the rope‚Äôs <strong>rest length</strong> (<code>restSegLen * scale</code>). Shooting ramps <code>scale</code> up; retracting ramps it down.</p>
</li>
<li>
<p><strong>Sticky catch:</strong> when the tip overlaps the fly, the tip becomes pinned to the fly for <code>maxStickFrames</code>, then we auto-retract.</p>
</li>
<li>
<p><strong>Robustness:</strong> multiple solver iterations and substeps keep things snappy without exploding.</p>
</li>
</ul>
<p>If you want features like <strong>collisions with walls</strong> or <strong>maximum curvature clamps</strong> or <strong>distance-to-target motors</strong> (for really snappy lash), say the word and I‚Äôll add them.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, that's a pretty awesome start.
There are a few major things to fix:

1. The tongue does not shoot towards the clicked target (always straight up or down)
2. The tongue flips over the y axis from the starting point after being launched a first time, and from then on it only launches down.</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>You‚Äôre totally right‚Äîtwo bugs:</p>
<ol>
<li>
<p>the chain had no ‚Äúaim‚Äù motor, so it always extended along its initial build axis;</p>
</li>
<li>
<p>the first launch left residual velocities that made the rope mirror/flip and bias downward.</p>
</li>
</ol>
<p>Here‚Äôs a drop-in replacement that fixes both by:</p>
<ul>
<li>
<p>computing an <code>aimDir</code> when you press Space,</p>
</li>
<li>
<p>instantly realigning the rope along that ray (and zeroing velocities) so it actually points where you clicked,</p>
</li>
<li>
<p>adding a gentle <strong>alignment motor</strong> during extension that keeps the rope oriented toward the aim direction, then fades out so it behaves like a free rope again.</p>
</li>
</ul>
<p>Same controls: Click to aim, Space to shoot, R to retract, B to debug.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Aimed + No-Flip
 * Fixes:
 *  1) Tongue now shoots toward clicked target (aimDir + alignment motor)
 *  2) No Y-axis flip after first launch (reinitialize shape + zero velocities)
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,

    <span class="hljs-comment">// NEW: aiming motor parameters</span>
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,          <span class="hljs-comment">// how strongly to pull segments onto the ray during shoot</span>
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,       <span class="hljs-comment">// per-frame fade while extending (-&gt; frees rope as it finishes)</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>,
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    rope.<span class="hljs-title function_">shootToward</span>(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'R'</span> || key === <span class="hljs-string">'r'</span>) {
    rope.<span class="hljs-title function_">startRetract</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.22</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// NEW: aiming state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// decays while extending</span>
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-comment">// keep first particle pinned exactly</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }

  <span class="hljs-comment">// ----- NEW: compute aim direction + reset rope shape to ray -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// reinitialize chain *on the aim ray* at current scale</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-comment">/*zeroVel=*/</span><span class="hljs-literal">true</span>);

    <span class="hljs-comment">// engage aim motor and start extending</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- NEW: rebuild shape on the ray; optional zero velocity to prevent flip -----</span>
  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]); <span class="hljs-comment">// zero verlet velocity =&gt; prevents post-launch flip</span>
      }
    }
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-comment">// scale motor</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-comment">// fade the alignment motor while extending so it ‚Äúlets go‚Äù smoothly</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span> * <span class="hljs-number">0.999</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.12</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.13</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// if tip is stuck, auto-retract after a short hold</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// re-pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

    <span class="hljs-comment">// keep tip pinned if stuck</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
      <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 2) stretch</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
      }

      <span class="hljs-comment">// 3) soft bend (2nd neighbor)</span>
      <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
      }

      <span class="hljs-comment">// 4) NEW: aim alignment motor while extending (gentle projection to ray)</span>
      <span class="hljs-comment">//    Pull each free particle toward its ray goal: mouth + aimDir * i * segRest</span>
      <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> &gt; <span class="hljs-number">0.01</span>) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
          <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
        }
      }

      <span class="hljs-comment">// re-apply pins</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
      }
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params">p</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = p.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>] = <span class="hljs-number">0</span>;
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>] = <span class="hljs-number">1</span>;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> t = i / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
      <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

      <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
      <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
      <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

      <span class="hljs-title function_">quad</span>(
        a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
        a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
      );

      <span class="hljs-keyword">if</span> (debugBones) {
        <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
        <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
        <span class="hljs-title function_">noStroke</span>();
      }
    }

    <span class="hljs-keyword">const</span> tip = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>];
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();
  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipPinnedTo</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(rope.<span class="hljs-title function_">tipPos</span>());
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.15</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipPinnedTo</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>(fly.<span class="hljs-property">p</span>);
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  rope.<span class="hljs-title function_">draw</span>();
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">330</span>, <span class="hljs-number">92</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî aimed"</span>,
      <span class="hljs-string">"Click: Aim   Space: Shoot   R: Retract   B: Debug"</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Why this fixes it</h3>
<ul>
<li>
<p>On <strong>Space</strong>, we compute <code>aimDir = normalize(target - mouth)</code> and <strong>rebuild</strong> the rope along that ray while <strong>zeroing velocities</strong>. That kills the residual momentum that caused the mirror/flip.</p>
</li>
<li>
<p>While extending, each point is <strong>softly projected</strong> toward <code>mouth + aimDir * (i * segRest)</code> using <code>_alignGain</code> (a small positional motor). <code>_alignGain</code> fades (multiply by <code>alignFade</code>) so the rope transitions from ‚Äúlaser-straight toward target‚Äù to normal rope behavior as the shot completes.</p>
</li>
</ul>
<p>If you want a snappier lash, increase <code>alignK</code> (e.g., 0.5). If you want more natural slack during flight, lower it to ~0.2 or increase <code>alignFade</code> so it decays faster.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, this indeed fixes both issues.
Now the next issue is that when the tongue reaches a fly, after latching it simply resets to its original position rather than pulling back (shortening back).</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Good catch ‚Äî the ‚Äúsnap back‚Äù happens because we‚Äôre <strong>pinning both ends</strong>: the mouth is pinned (invMass=0) <em>and</em> the tip gets pinned to the fly. When we then shorten the rope (shrink <code>scale</code>), the solver can‚Äôt bring the endpoints together (both fixed), so it just compresses internally and looks like a reset.</p>
<p>Fix: <strong>don‚Äôt pin the tip to the fly</strong>. Instead, keep the tip <strong>free</strong> and simply ‚Äúcarry‚Äù the fly by setting the fly‚Äôs position to the tip each frame while stuck. As the rope shortens, constraints will naturally pull the <strong>tip (and fly)</strong> back to the mouth.</p>
<p>Below are drop-in changes (small diff) to your current code.</p>
<hr>
<h3>1) Don‚Äôt hard-pin the tip ‚Äî make it a soft attachment</h3>
<p><strong>Replace</strong> the <code>pinTipTo</code> / <code>unpinTip</code> and tip pin logic with a boolean ‚Äúattached‚Äù flag:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// --- Rope class: fields ---</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;   <span class="hljs-comment">// instead of storing a point &amp; pinning the tip</span>
<span class="hljs-comment">// (keep this.tipPinnedTo around if you want, but we won't use it to pin)</span>
</code></pre>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// --- Rope class: remove hard pinning ---</span>
<span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"><span class="hljs-comment">/*p*/</span></span>) {
  <span class="hljs-comment">// do NOT set invMass=0 and do NOT lock to world point</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// optional: zero out tip's velocity for stability</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
}

<span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
}
</code></pre>
<h3>2) Stop overwriting the tip position in integration</h3>
<p><strong>Delete</strong> this block from <code>integrate()</code>:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// REMOVE this block</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
  <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
}
</code></pre>
<p>And in <code>solveConstraints()</code> also remove the ‚Äúre-apply tip pin‚Äù block:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// REMOVE this too</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>) {
  <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipPinnedTo</span>.<span class="hljs-property">y</span>);
}
</code></pre>
<h3>3) Keep only the mouth pinned</h3>
<p>Leave the mouth pinning as-is:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
<span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
</code></pre>
<h3>4) Make the fly follow the tip while attached</h3>
<p>Update <code>handleFlyCatch()</code> so the fly <strong>tracks the tip</strong> (not the other way around):</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// drag the fly with the tongue tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// when retraction completes, release</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.15</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// check first contact</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();   <span class="hljs-comment">// no args now, just mark attached</span>
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      rope.<span class="hljs-title function_">startRetract</span>(); <span class="hljs-comment">// begin shortening immediately</span>
    }
  }
}
</code></pre>
<h3>5) (Optional) Add a gentle <strong>retract motor</strong> for snap</h3>
<p>If you want a crisper pull during retract (especially with low iterations), add this tiny ‚Äútip pull‚Äù in <code>solveConstraints()</code> after stretch/bend:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// ---- OPTIONAL: tip retract motor ----</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
  <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
  <span class="hljs-comment">// project tip slightly toward mouth each solver iteration</span>
  <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>; <span class="hljs-comment">// 0..~0.15 feels good</span>
  <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
  <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
}
</code></pre>
<p>This isn‚Äôt a pin ‚Äî it‚Äôs a small positional nudge that cooperates with the rest-length shrink and keeps things stable.</p>
<hr>
<h2>Why this works</h2>
<ul>
<li>
<p>With <strong>only the mouth pinned</strong>, shrinking <code>restSegLen * scale</code> gives the chain an easy way to satisfy constraints: it shortens by <strong>bringing the (free) tip toward the mouth</strong>.</p>
</li>
<li>
<p>The fly is just visual cargo: we ‚Äústick‚Äù it to the <strong>tip</strong> (set fly to tip each frame), so it gets hauled back as the rope retracts.</p>
</li>
<li>
<p>No teleport, no flip ‚Äî just a clean retract motion.</p>
</li>
</ul>
<p>If you want the fly to have <strong>mass</strong> and tug back, we can model it as another PBD particle and add a <strong>distance constraint</strong> between the tip and a ‚Äúfly particle‚Äù (instead of teleporting the fly to the tip). That gives satisfying slack and jiggle on impact. Want that version next?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Provide the full updated, runnable code</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Awesome ‚Äî here‚Äôs the <strong>full, runnable p5.js sketch</strong> with the fixed <strong>retract behavior</strong> (no tip pinning), plus the earlier aim + no-flip fixes. Paste it into an HTML file that loads p5, or run in the p5 web editor.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Aimed + Clean Retract (no tip pinning)
 * Controls:
 *  - Click: aim target
 *  - Space: shoot / extend toward target
 *  - R: retract
 *  - B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,   <span class="hljs-comment">// aim alignment strength while extending</span>
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span> <span class="hljs-comment">// alignment fade per frame (lets rope go natural)</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    rope.<span class="hljs-title function_">shootToward</span>(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'R'</span> || key === <span class="hljs-string">'r'</span>) {
    rope.<span class="hljs-title function_">startRetract</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// when true, we ride on the tongue tip</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we'll realign on first shot)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.22</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// catch state (no tip pinning; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// optional: small hold time before auto-retract after catch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + shoot -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// rebuild along ray at current scale and zero velocities to avoid flip</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// ----- control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>; <span class="hljs-comment">// alignment motor fades out</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span> * <span class="hljs-number">0.999</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.12</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.13</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// gentle auto-retract after a short stick if desired</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// pinned mouth only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// re-pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 2) stretch (neighbor distances)</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
      }

      <span class="hljs-comment">// 3) soft bend (2nd neighbor)</span>
      <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
      }

      <span class="hljs-comment">// 4) alignment motor while extending (gently project onto the aim ray)</span>
      <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> &gt; <span class="hljs-number">0.01</span>) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
          <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
        }
      }

      <span class="hljs-comment">// 5) OPTIONAL: add a tiny pull on the tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>; <span class="hljs-comment">// tweak 0..0.15</span>
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" API (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> t = i / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
      <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

      <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
      <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
      <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

      <span class="hljs-title function_">quad</span>(
        a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
        a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
      );

      <span class="hljs-keyword">if</span> (debugBones) {
        <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
        <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
        <span class="hljs-title function_">noStroke</span>();
      }
    }

    <span class="hljs-comment">// tip bulb</span>
    <span class="hljs-keyword">const</span> tip = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>];
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

    <span class="hljs-comment">// mouth</span>
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip during retract</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// when retract finishes (short length), release</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.15</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// first contact -&gt; stick and retract</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();     <span class="hljs-comment">// marks attachment only (no pinning)</span>
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      rope.<span class="hljs-title function_">startRetract</span>(); <span class="hljs-comment">// begin shortening immediately</span>
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  rope.<span class="hljs-title function_">draw</span>();
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">360</span>, <span class="hljs-number">92</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî aimed + clean retract"</span>,
      <span class="hljs-string">"Click: Aim   Space: Shoot   R: Retract   B: Debug"</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p><strong>What changed vs previous:</strong></p>
<ul>
<li>
<p>No more <strong>tip pinning</strong> to the fly. We just set <code>fly.p = tip</code> while attached.</p>
</li>
<li>
<p><code>Rope.tipAttached</code> is a boolean; <code>pinTipTo()</code> no longer freezes the tip (invMass unchanged).</p>
</li>
<li>
<p>Removed any ‚Äúforce-set tip position‚Äù blocks.</p>
</li>
<li>
<p>Optional <strong>tip pull</strong> during retract keeps the haul snappy without violating PBD.</p>
</li>
</ul>
<p>Want me to make the fly a <em>proper PBD particle</em> connected by a constraint (for massy jiggle), or add <strong>wall/obstacle collisions</strong> for the tongue?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, that's better. However when the fly is caught and brought back to the mouth, the tongue tip is pinned to the fly position (the mouth), and when launched the segments are launched, but not the tip, which makes some weird loops</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Nice catch. The tip was staying ‚Äúattached‚Äù after the swallow, so on the next shot it behaved like it was still pinned at the mouth. I‚Äôve made three fixes:</p>
<ol>
<li>
<p>On <strong>Space</strong>, we now forcibly clear any lingering attachment (<code>rope.unpinTip(); fly.sticky=false;</code>).</p>
</li>
<li>
<p><code>shootToward()</code> also clears <code>tipAttached</code> (belt-and-suspenders).</p>
</li>
<li>
<p>When shooting from a fully retracted state, we seed a <strong>minimum initial scale</strong> so the chain starts with a tiny length along the aim ray (prevents segments from all starting at the exact mouth point).</p>
</li>
</ol>
<p>Here‚Äôs the full, runnable sketch:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Aimed + Clean Retract + No-stuck-tip
 * Controls:
 *  - Click: aim target
 *  - Space: shoot / extend toward target
 *  - R: retract
 *  - B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// NEW: ensure nothing remains attached from previous catch</span>
    rope.<span class="hljs-title function_">unpinTip</span>();
    fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;

    rope.<span class="hljs-title function_">shootToward</span>(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'R'</span> || key === <span class="hljs-string">'r'</span>) {
    rope.<span class="hljs-title function_">startRetract</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// when true, we ride on the tongue tip</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we'll realign on first shot)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.22</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// catch state (no tip pinning; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// optional: small hold time before auto-retract after catch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-comment">// minimum scale to seed an initial chain on shoot (prevents all-at-mouth)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span> = <span class="hljs-number">0.20</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + shoot -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// NEW: doubly ensure we are not attached anymore</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// Seed a small initial scale so segments aren't all stacked at the mouth</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// rebuild along ray at current scale and zero velocities to avoid flip</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// ----- control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>; <span class="hljs-comment">// alignment motor fades out</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span> * <span class="hljs-number">0.999</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.12</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.13</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// gentle auto-retract after a short stick if desired</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// pinned mouth only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// re-pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 2) stretch (neighbor distances)</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
      }

      <span class="hljs-comment">// 3) soft bend (2nd neighbor)</span>
      <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
      }

      <span class="hljs-comment">// 4) alignment motor while extending (gently project onto the aim ray)</span>
      <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> &gt; <span class="hljs-number">0.01</span>) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
          <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
        }
      }

      <span class="hljs-comment">// 5) OPTIONAL: tiny pull on the tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>; <span class="hljs-comment">// tweak 0..0.15</span>
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" API (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> t = i / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
      <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

      <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
      <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
      <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

      <span class="hljs-title function_">quad</span>(
        a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
        a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
      );

      <span class="hljs-keyword">if</span> (debugBones) {
        <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
        <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
        <span class="hljs-title function_">noStroke</span>();
      }
    }

    <span class="hljs-comment">// tip bulb</span>
    <span class="hljs-keyword">const</span> tip = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>];
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

    <span class="hljs-comment">// mouth</span>
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip during retract</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// when retract finishes (short length), release</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.15</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// first contact -&gt; stick and retract</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();     <span class="hljs-comment">// marks attachment only (no pinning)</span>
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      rope.<span class="hljs-title function_">startRetract</span>(); <span class="hljs-comment">// begin shortening immediately</span>
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  rope.<span class="hljs-title function_">draw</span>();
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">400</span>, <span class="hljs-number">92</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî aimed + clean retract + no-stuck-tip"</span>,
      <span class="hljs-string">"Click: Aim   Space: Shoot   R: Retract   B: Debug"</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>If you still see odd loops, set <code>rope.minShootScale</code> to ~<code>0.28</code> for a little more initial separation, or bump <code>iterations</code> to 10‚Äì12 for a stiffer chain on launch.</p>1/2</div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, that's fantastic. Now note that the tongue sticks to the fly as the fly falls even if not in 'launch' mode. So the tongue shouldn't be sticky unless it is in the process of being launched or retracted.</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Got it ‚Äî we‚Äôll only allow the tongue to <strong>stick</strong> while it‚Äôs actively <strong>shooting or retracting</strong>. When idle, collisions won‚Äôt attach.</p>
<p>Here‚Äôs the full updated, runnable sketch (tiny change in <code>handleFlyCatch()</code>‚Äîsee the <code>if (d &lt; ‚Ä¶ &amp;&amp; (rope.shooting || rope.retracting))</code> line):</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Aimed + Clean Retract + No-stuck-tip
 * Only sticky while shooting or retracting.
 * Controls:
 *  - Click: aim target
 *  - Space: shoot / extend toward target
 *  - R: retract
 *  - B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// ensure nothing remains attached from previous catch</span>
    rope.<span class="hljs-title function_">unpinTip</span>();
    fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
    rope.<span class="hljs-title function_">shootToward</span>(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'R'</span> || key === <span class="hljs-string">'r'</span>) {
    rope.<span class="hljs-title function_">startRetract</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// when true, we ride on the tongue tip</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we'll realign on first shot)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.22</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// catch state (no tip pinning; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// optional: small hold time before auto-retract after catch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-comment">// minimum scale to seed an initial chain on shoot (prevents all-at-mouth)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span> = <span class="hljs-number">0.20</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + shoot -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure we are not attached anymore</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// Seed a small initial scale so segments aren't all stacked at the mouth</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// rebuild along ray at current scale and zero velocities to avoid flip</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// ----- control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>; <span class="hljs-comment">// alignment motor fades out</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span> * <span class="hljs-number">0.999</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.12</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.13</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// gentle auto-retract after a short stick if desired</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// pinned mouth only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// re-pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 2) stretch (neighbor distances)</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
      }

      <span class="hljs-comment">// 3) soft bend (2nd neighbor)</span>
      <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
      }

      <span class="hljs-comment">// 4) alignment motor while extending (gently project onto the aim ray)</span>
      <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> &gt; <span class="hljs-number">0.01</span>) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
          <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
        }
      }

      <span class="hljs-comment">// 5) OPTIONAL: tiny pull on the tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>; <span class="hljs-comment">// tweak 0..0.15</span>
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" API (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> t = i / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
      <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

      <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
      <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
      <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

      <span class="hljs-title function_">quad</span>(
        a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
        a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
      );

      <span class="hljs-keyword">if</span> (debugBones) {
        <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
        <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
        <span class="hljs-title function_">noStroke</span>();
      }
    }

    <span class="hljs-comment">// tip bulb</span>
    <span class="hljs-keyword">const</span> tip = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>];
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

    <span class="hljs-comment">// mouth</span>
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip during retract</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// when retract finishes (short length), release</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= <span class="hljs-number">0.15</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Only allow NEW sticky contact while shooting or retracting</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();     <span class="hljs-comment">// marks attachment only (no pinning)</span>
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      rope.<span class="hljs-title function_">startRetract</span>(); <span class="hljs-comment">// begin shortening immediately</span>
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  rope.<span class="hljs-title function_">draw</span>();
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">420</span>, <span class="hljs-number">92</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî aimed + clean retract + sticky only when active"</span>,
      <span class="hljs-string">"Click: Aim   Space: Shoot   R: Retract   B: Debug"</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>If you want an ‚Äúauto-shoot‚Äù state (e.g., click instantly fires) or a cooldown window before sticking again, we can add those too.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Can you make the tongue retract to have a length of zero, instead of a pile of segments with a total length n?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Absolutely ‚Äî here‚Äôs a version where the tongue <strong>fully collapses to zero length at the mouth</strong>. When retraction crosses a tiny threshold, we hard-collapse all particles to the mouth and zero their velocities, so there‚Äôs no ‚Äúpile of segments‚Äù.</p>
<p>Changes vs last build:</p>
<ul>
<li>
<p>New <code>epsilonScale</code> and <code>collapseToMouth()</code> in <code>Rope</code>.</p>
</li>
<li>
<p>During retract, when <code>scale &lt;= epsilonScale</code>, we snap everything to the mouth, clear attachments, and stop retracting.</p>
</li>
<li>
<p>Shooting still seeds a small <code>minShootScale</code> so launch starts clean.</p>
</li>
</ul>
<p>Paste this whole sketch into your p5 editor:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Zero-Length Retract
 * - Clean collapse: rope collapses to exact zero length at mouth
 * - Sticky only when active (shooting/retracting)
 * Controls:
 *  Click: set aim  |  Space: shoot  |  R: retract  |  B: debug bones
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-comment">// NEW: exact collapse control</span>
    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// threshold to snap to zero length</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span> <span class="hljs-comment">// seed on shoot so segments aren't all at mouth</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// make sure nothing remains attached from previous catch</span>
    rope.<span class="hljs-title function_">unpinTip</span>();
    fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
    rope.<span class="hljs-title function_">shootToward</span>(target);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'R'</span> || key === <span class="hljs-string">'r'</span>) {
    rope.<span class="hljs-title function_">startRetract</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// when true, we ride on the tongue tip</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we'll realign on first shot)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// start fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// catch state (no tip pinning; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-comment">// keep collapsed particles at mouth if fully collapsed</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + shoot -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure we are not attached anymore</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// Seed a small initial scale so segments aren't all stacked at the mouth</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// rebuild along ray at current scale and zero velocities to avoid flip</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// ----- NEW: hard collapse to zero length at mouth -----</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>; <span class="hljs-comment">// alignment motor fades out</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span> * <span class="hljs-number">0.999</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-comment">// when very short, snap to true zero</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// idle: if we're effectively zero-length, keep collapsed (numerical safety)</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      }
    }

    <span class="hljs-comment">// gentle auto-retract after a short stick if desired</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// pinned mouth only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// re-pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 2) stretch (neighbor distances)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 3) soft bend (2nd neighbor)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// 4) alignment motor while extending (gently project onto the aim ray)</span>
      <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> &gt; <span class="hljs-number">0.01</span>) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
          <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
        }
      }

      <span class="hljs-comment">// 5) optional: tiny pull on the tip during retract</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>; <span class="hljs-comment">// tweak 0..0.15</span>
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" API (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();

    <span class="hljs-comment">// If collapsed, just draw the bulb at the mouth</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
      <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
      <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
      <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
      <span class="hljs-title function_">pop</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
      <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> t = i / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
      <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

      <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
      <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
      <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

      <span class="hljs-title function_">quad</span>(
        a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
        a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
        b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
      );

      <span class="hljs-keyword">if</span> (debugBones) {
        <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
        <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
        <span class="hljs-title function_">noStroke</span>();
      }
    }

    <span class="hljs-comment">// tip bulb</span>
    <span class="hljs-keyword">const</span> tip = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>];
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

    <span class="hljs-comment">// mouth</span>
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip during retract</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// when retract finishes (full collapse), release</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Only allow NEW sticky contact while shooting or retracting</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();     <span class="hljs-comment">// marks attachment only (no pinning)</span>
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
      rope.<span class="hljs-title function_">startRetract</span>(); <span class="hljs-comment">// begin shortening immediately</span>
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  rope.<span class="hljs-title function_">draw</span>();
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">460</span>, <span class="hljs-number">92</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî zero-length retract"</span>,
      <span class="hljs-string">"Click: Aim   Space: Shoot   R: Retract   B: Debug"</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>Tweak <code>epsilonScale</code> if you ever see a stray pixel of length before collapse (e.g., try <code>0.03</code>). If you want the collapse to play a tiny ‚Äúsnap‚Äù animation instead of an instant snap, we can add a brief springy pull toward the mouth just before hitting zero.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, that works!
Now can you make it such that the tongue can stick to the fly on the expansion phase, not just on the retraction phase? 
Take this opportunity to split the expansion and retraction into two space bar inputs (space -&gt; launch, space -&gt; retracts). If the tongue latches to the fly while expanding, it should stop expansion</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Absolutely! Here‚Äôs a full, runnable sketch with:</p>
<ul>
<li>
<p><strong>Two-stage Spacebar</strong>:</p>
<ul>
<li>
<p>First <strong>Space</strong> = <strong>launch (expand)</strong></p>
</li>
<li>
<p>Second <strong>Space</strong> = <strong>retract</strong></p>
</li>
</ul>
</li>
<li>
<p><strong>Sticky on expand</strong>: if the tip hits the fly <strong>while expanding</strong>, it <strong>immediately stops expanding</strong> and starts <strong>retracting</strong>.</p>
</li>
<li>
<p>Still collapses to <strong>true zero length</strong> on full retract.</p>
</li>
</ul>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Two-Stage Space (Launch -&gt; Retract)
 * - Sticky allowed during expansion AND retraction
 * - If sticky happens during expansion, expansion stops and retraction begins
 * - Fully collapses to zero length at mouth on retract
 *
 * Controls:
 *  Click: set aim
 *  Space: first press launches (expand), second press retracts
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span> <span class="hljs-comment">// seed length for clean launch</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Two-stage Space:</span>
    <span class="hljs-comment">// - If idle/collapsed/not expanding -&gt; LAUNCH</span>
    <span class="hljs-comment">// - If expanding -&gt; RETRACT</span>
    <span class="hljs-comment">// - If already retracting -&gt; keep retracting</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      <span class="hljs-comment">// fresh launch: clear sticky state</span>
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ride on the tongue tip when true</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we realign on first launch)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// start fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// expanding</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// sticky state (tip free; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + launch -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure not attached</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// seed length for clean launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// lay the rope along the aim ray and zero velocities</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// collapse to exact zero length at mouth</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- per-frame control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-comment">// note: now we do NOT auto-switch to retract at max; user presses space to retract</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// idle collapse safety</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-comment">// optional auto-retract after holding a stuck fly for a moment</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// mouth pinned only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// stretch</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// soft bend</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor only while expanding and tip not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// release when fully collapsed</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Allow NEW sticky contact during expansion OR retraction</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();

      <span class="hljs-comment">// If we latched while expanding, STOP expanding and start retract</span>
      <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span>) {
        <span class="hljs-comment">// if already retracting, keep retracting; if idle (edge-case), start retract</span>
        rope.<span class="hljs-title function_">startRetract</span>();
      }

      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// rope</span>
  <span class="hljs-title function_">drawRope</span>();

  <span class="hljs-comment">// fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
    <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(
      a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
      a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
    );

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
      <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip bulb</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth</span>
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">circle</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">520</span>, <span class="hljs-number">110</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî expand+stick, then space to retract"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${rope.shooting ? <span class="hljs-string">"Expanding"</span> : (rope.retracting ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>)}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>Tweak notes:</p>
<ul>
<li>
<p>If you want expansion to auto-stop at max length (without pressing space), add a cap check in <code>driveToward</code> and set <code>this.shooting=false</code> there (but per your spec, we leave it under user control).</p>
</li>
<li>
<p>If you‚Äôd like a brief ‚Äúhold‚Äù on the fly before retracting, increase <code>maxStickFrames</code>.</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, that is fantastic!
Now I'd like you to add angular velocity support (the mouth has an angular velocity, and that angular velocity should affect the bones of the rope when launched/retracting).
For now set the angular velocity of the mouth to be a constant</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Heck yeah ‚Äî here‚Äôs a <strong>full, runnable</strong> sketch with <strong>angular velocity</strong> on the mouth. While the tongue is <strong>expanding or retracting</strong>, the mouth‚Äôs constant angular velocity imparts a tangential velocity to every bone (classic <code>v = œâ √ó r</code>), so the rope curls/whips accordingly. When idle, there‚Äôs no spin advection so it rests nicely.</p>
<ul>
<li>
<p><strong>Space</strong> = launch; <strong>Space again</strong> = retract</p>
</li>
<li>
<p><strong>Sticky</strong> works during expand or retract</p>
</li>
<li>
<p><strong>Zero-length</strong> collapse on full retract</p>
</li>
<li>
<p><strong>Angular velocity</strong> is a constant you can tweak: <code>mouthOmega</code></p>
</li>
</ul>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Two-Stage, Sticky on Expand, Zero-Length Retract,
 * with Mouth Angular Velocity coupling (spin advection while active).
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// --- NEW: Angular velocity of the mouth (radians per frame) ---</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.035</span>,      <span class="hljs-comment">// try 0.02..0.08; sign controls spin direction</span>
    <span class="hljs-attr">spinCoupling</span>: <span class="hljs-number">0.8</span>       <span class="hljs-comment">// 0..1: how strongly œâ√ór is applied to particles</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Two-stage Space:</span>
    <span class="hljs-comment">// - If idle -&gt; LAUNCH</span>
    <span class="hljs-comment">// - If expanding -&gt; RETRACT</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ride on the tongue tip when true</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we realign on first launch)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// expanding</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// sticky state (tip free; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + launch -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure not attached</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// seed length for clean launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// lay the rope along the aim ray and zero velocities</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// collapse to exact zero length at mouth</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- per-frame control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-comment">// no auto-switch to retract at max; second Space does that</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// idle collapse safety</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-comment">// optional auto-retract after holding a stuck fly for a moment</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-comment">// Verlet + gravity</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// mouth pinned only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// --- NEW: angular advection from mouth spin while active ---</span>
    <span class="hljs-comment">// v_spin = œâ √ó r  (2D: r=(rx,ry), œâ along +z =&gt; v=( -œâ*ry, œâ*rx ))</span>
    <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
      <span class="hljs-keyword">const</span> omega = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
      <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">const</span> cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinCoupling</span>; <span class="hljs-comment">// scale factor (0..1)</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth (pinned)</span>
        <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
        <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx;
        <span class="hljs-keyword">const</span> ry = p.<span class="hljs-property">y</span> - cy;
        <span class="hljs-keyword">const</span> vxSpin = -omega * ry * k;
        <span class="hljs-keyword">const</span> vySpin =  omega * rx * k;
        p.<span class="hljs-property">x</span> += vxSpin;
        p.<span class="hljs-property">y</span> += vySpin;
      }
    }

    <span class="hljs-comment">// pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// stretch</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// soft bend</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor only while expanding and tip not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// release when fully collapsed</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Allow sticky contact during expansion OR retraction</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();

      <span class="hljs-comment">// If we latched while expanding, stop expanding and start retract</span>
      <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      }

      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// rope</span>
  <span class="hljs-title function_">drawRope</span>();

  <span class="hljs-comment">// fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
    <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(
      a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
      a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
    );

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
      <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip bulb</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth (draw a small rotation indicator arc)</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-comment">// simple spinner dot to hint at rotation direction</span>
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>;
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = (frameCount * rope.<span class="hljs-property">mouthOmega</span>) % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">560</span>, <span class="hljs-number">128</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî mouth angular velocity coupling"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`Mouth œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span> rad/frame   Spin Coupling: <span class="hljs-subst">${rope.spinCoupling}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Notes &amp; Tweaks</h3>
<ul>
<li>
<p><strong><code>mouthOmega</code></strong> controls how fast the mouth ‚Äúspins‚Äù (radians/frame). Flip the sign to reverse direction.</p>
</li>
<li>
<p><strong><code>spinCoupling</code></strong> scales how much the angular velocity affects the rope. Lower it (e.g., <code>0.4</code>) for a subtler effect; raise it (e.g., <code>1.2</code>) for a wild whip.</p>
</li>
<li>
<p>The spin advection is only applied <strong>while expanding or retracting</strong>, which keeps the rope calm when idle/collapsed.</p>
</li>
<li>
<p>If you want the <strong>aim direction to rotate with the mouth</strong>, we can modulate <code>aimDir</code> by a rotating basis during expansion; right now aim is the straight line to your click, and the spin influences the rope dynamics via <code>œâ√ór</code>.</p>
</li>
</ul>
<p>Want me to add <strong>linear mouth motion</strong> (e.g., the frog hopping) and make the rope inherit both linear and angular velocities?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Ok, this doesn't work, the angular velocity makes the tongue spin around the root extremely fast.
Can you investigate and propose a fix?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Totally‚Äîmy bad. I injected spin as a <strong>position-only</strong> shove (<code>p += œâ√ór</code>), which <em>adds energy</em> every frame (and per substep), so it quickly explodes.</p>
<h3>The fix</h3>
<p>Treat the mouth‚Äôs rotation as a <strong>kinematic frame rotation</strong>: each substep, <strong>rotate both <code>x</code> and <code>xPrev</code></strong> around the mouth by a tiny angle <code>dŒ∏ = œâ * dt</code>, optionally scaled by a coupling factor. That way you advect the rope consistently without injecting relative velocity.</p>
<p>Below is the full, runnable sketch with the corrected angular coupling (rotation of <code>x</code> <strong>and</strong> <code>xPrev</code>). Tweak <code>mouthOmega</code> and <code>spinCoupling</code> for feel; defaults are tame.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Two-Stage, Sticky on Expand,
 * Zero-Length Retract, with Stable Mouth Angular Velocity (kinematic rotation).
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.01</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Stable angular coupling parameters (rotation-based)</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,   <span class="hljs-comment">// radians/frame (try 0.01..0.04)</span>
    <span class="hljs-attr">spinCoupling</span>: <span class="hljs-number">0.7</span>   <span class="hljs-comment">// 0..1 scales the rotation angle applied to the rope</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">55</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Two-stage Space:</span>
    <span class="hljs-comment">// - If idle -&gt; LAUNCH</span>
    <span class="hljs-comment">// - If expanding -&gt; RETRACT</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ride on the tongue tip when true</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.06</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-number">0.98</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">0.9</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">constrain</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>, height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we realign on first launch)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// expanding</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// sticky state (tip free; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + launch -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure not attached</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// seed length for clean launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// lay the rope along the aim ray and zero velocities</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// collapse to exact zero length at mouth</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- per-frame control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-comment">// user triggers retract</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationKinematics</span>(); <span class="hljs-comment">// &lt;&lt;&lt; stable angular coupling</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-comment">// Verlet + gravity</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// mouth pinned only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      p.<span class="hljs-property">y</span> += vy + <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;
    }

    <span class="hljs-comment">// pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// ---------- NEW: stable rotation advection ----------</span>
  <span class="hljs-title function_">applyMouthRotationKinematics</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Only apply while active and non-zero length</span>
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Small rotation per substep</span>
    <span class="hljs-keyword">const</span> dtheta = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinCoupling</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-6</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta);
    <span class="hljs-keyword">const</span> s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);

    <span class="hljs-comment">// Rotate BOTH current and previous positions around the mouth.</span>
    <span class="hljs-comment">// This keeps relative velocities unchanged -&gt; no artificial energy injection.</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth (pinned)</span>
      <span class="hljs-comment">// current</span>
      <span class="hljs-keyword">const</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">const</span> py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-comment">// previous</span>
      <span class="hljs-keyword">const</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">const</span> qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// stretch</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// soft bend</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor only while expanding and tip not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// release when fully collapsed</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Allow sticky contact during expansion OR retraction</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();

      <span class="hljs-comment">// If we latched while expanding, stop expanding and start retract</span>
      <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      }

      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ground</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">140</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">0</span>, height - <span class="hljs-number">60</span>, width, <span class="hljs-number">60</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// lily pad</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">ellipse</span>(frogMouth.<span class="hljs-property">x</span> + <span class="hljs-number">8</span>, frogMouth.<span class="hljs-property">y</span> + <span class="hljs-number">25</span>, <span class="hljs-number">160</span>, <span class="hljs-number">34</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// rope</span>
  <span class="hljs-title function_">drawRope</span>();

  <span class="hljs-comment">// fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
    <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(
      a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
      a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
    );

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
      <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip bulb</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth (draw a small rotation indicator arc)</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-comment">// spinner dot to hint at rotation direction</span>
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>;
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = (frameCount * rope.<span class="hljs-property">mouthOmega</span>) % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">580</span>, <span class="hljs-number">128</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî stable mouth angular velocity (kinematic rotation)"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`Mouth œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span> rad/frame   Spin Coupling: <span class="hljs-subst">${rope.spinCoupling}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Why this fixes the spin blow-up</h3>
<ul>
<li>
<p>We <strong>rotate both</strong> <code>x</code> and <code>xPrev</code> by a tiny angle each substep. That preserves the Verlet ‚Äúvelocity‚Äù (the <code>x - xPrev</code> difference) and doesn‚Äôt inject energy.</p>
</li>
<li>
<p>Rotation is scaled by <code>1 / substeps</code>, so it‚Äôs stable regardless of solver substeps.</p>
</li>
<li>
<p><code>spinCoupling</code> lets you dial the effect without touching <code>mouthOmega</code>.</p>
</li>
</ul>
<p>If you want the <strong>aim ray</strong> itself to rotate with the mouth during expansion (so it spirals as you launch), I can hook <code>aimDir</code> to the same <code>dŒ∏</code>.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, I'm not sure it worked. Please disable gravity in the simulation to act as if in the vacuum of deep space (no gravity around)</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>You got it‚Äîhere‚Äôs the full, runnable sketch with <strong>zero gravity</strong> and <strong>no air drag</strong> (deep-space vibes). I also removed gravity and damping from the fly so it just coasts unless it hits screen edges (elastic bounce). The mouth angular-velocity coupling remains the <strong>stable kinematic rotation</strong> version.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Deep Space (no gravity, no drag)
 * - Two-stage Space (Launch -&gt; Retract)
 * - Sticky on expand or retract
 * - Zero-length collapse on retract
 * - Stable mouth angular velocity via kinematic rotation of x &amp; xPrev
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// --- Deep space: no gravity, no drag ---</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.0</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Stable angular coupling parameters (rotation-based)</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,   <span class="hljs-comment">// radians/frame (try 0.01..0.04)</span>
    <span class="hljs-attr">spinCoupling</span>: <span class="hljs-number">0.7</span>   <span class="hljs-comment">// 0..1 scales the rotation angle applied to the rope</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Two-stage Space:</span>
    <span class="hljs-comment">// - If idle -&gt; LAUNCH</span>
    <span class="hljs-comment">// - If expanding -&gt; RETRACT</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ride on the tongue tip when true</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-comment">// Deep space: no gravity, no air drag ‚Äî inertial motion</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);

      <span class="hljs-comment">// Keep the fly in-bounds with elastic reflection</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1.0</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1.0</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1.0</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1.0</span>;
      }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we realign on first launch)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// expanding</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// sticky state (tip free; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + launch -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure not attached</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// seed length for clean launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// lay the rope along the aim ray and zero velocities</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// collapse to exact zero length at mouth</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- per-frame control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-comment">// user triggers retract</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationKinematics</span>(); <span class="hljs-comment">// stable angular coupling</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-comment">// Verlet (deep space: no gravity terms)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// mouth pinned only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx; <span class="hljs-comment">// + this.gravity.x (zero here)</span>
      p.<span class="hljs-property">y</span> += vy; <span class="hljs-comment">// + this.gravity.y (zero here)</span>
    }

    <span class="hljs-comment">// pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// ---------- stable rotation advection ----------</span>
  <span class="hljs-title function_">applyMouthRotationKinematics</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Only apply while active and non-zero length</span>
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Small rotation per substep</span>
    <span class="hljs-keyword">const</span> dtheta = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinCoupling</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-6</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta);
    <span class="hljs-keyword">const</span> s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);

    <span class="hljs-comment">// Rotate BOTH current and previous positions around the mouth.</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth (pinned)</span>
      <span class="hljs-comment">// current</span>
      <span class="hljs-keyword">const</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">const</span> py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-comment">// previous</span>
      <span class="hljs-keyword">const</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">const</span> qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// stretch</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// soft bend</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor only while expanding and tip not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" (no pinning)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// release when fully collapsed</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Allow sticky contact during expansion OR retraction</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();

      <span class="hljs-comment">// If we latched while expanding, stop expanding and start retract</span>
      <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      }

      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// starry background hint</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width;
    <span class="hljs-keyword">const</span> y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  }
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// rope</span>
  <span class="hljs-title function_">drawRope</span>();

  <span class="hljs-comment">// fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
    <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(
      a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
      a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
    );

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
      <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip bulb</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth (show rotation indicator)</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>;
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = (frameCount * rope.<span class="hljs-property">mouthOmega</span>) % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">640</span>, <span class="hljs-number">128</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space (no gravity, no drag) + stable mouth spin"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`Mouth œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span> rad/frame   Spin Coupling: <span class="hljs-subst">${rope.spinCoupling}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>If you want <em>true</em> deep-space behavior for the fly (no boundary collisions), I can switch to <strong>wrap-around</strong> edges or let it drift off-screen and add a respawn.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, so on launch the tongue no longer spins crazily - that's good.
Now the issue is that the mouth keeps rotating, but none of that rotation seems to be imparted to the tongue</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>You‚Äôre right ‚Äî rotating both <code>x</code> and <code>xPrev</code> together <em>advects</em> the rope without creating <strong>relative velocity</strong>, so it looks like no spin is being imparted.</p>
<h3>Fix: add a <strong>tangential velocity impulse</strong></h3>
<p>In Verlet, velocity is <code>x - xPrev</code>. To impart angular motion from the mouth, apply a small <strong>impulse</strong> <code>Œîv = œâ √ó r</code> to <strong>velocity</strong> by modifying <code>xPrev</code> (not <code>x</code>):
<code>xPrev -= Œîv * k</code> (scaled per substep). This injects swirl without exploding.</p>
<p>Below is the full, runnable deep-space sketch with the <strong>impulse-based</strong> coupling. Knobs:</p>
<ul>
<li>
<p><code>mouthOmega</code> (rad/frame)</p>
</li>
<li>
<p><code>spinCoupling</code> (strength)</p>
</li>
<li>
<p><code>spinFalloff</code> (0..1, fades impulse toward the tip)</p>
</li>
</ul>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Deep Space + Angular Impulse Coupling
 * - Two-stage Space (Launch -&gt; Retract)
 * - Sticky on expand or retract
 * - Zero-length collapse on retract
 * - Mouth angular velocity imparts *velocity* (impulse) to bones: Œîv = œâ √ó r
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.0</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// --- Angular impulse parameters ---</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,   <span class="hljs-comment">// radians per frame (try 0.01..0.04)</span>
    <span class="hljs-attr">spinCoupling</span>: <span class="hljs-number">0.8</span>,  <span class="hljs-comment">// scales Œîv strength (0..1+)</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.8</span>    <span class="hljs-comment">// 0=no falloff; 1=full fade to 0 at tip</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Two-stage Space:</span>
    <span class="hljs-comment">// - If idle -&gt; LAUNCH</span>
    <span class="hljs-comment">// - If expanding -&gt; RETRACT</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ride on the tongue tip when true</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-comment">// Deep space: inertial motion</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);

      <span class="hljs-comment">// Keep in-bounds with elastic reflection</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1.0</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1.0</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1.0</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1.0</span>;
      }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we realign on first launch)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// expanding</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// sticky state (tip free; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + launch -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure not attached</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// seed length for clean launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// lay the rope along the aim ray and zero velocities</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// collapse to exact zero length at mouth</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- per-frame control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-comment">// user triggers retract</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthAngularImpulse</span>(); <span class="hljs-comment">// &lt;&lt;&lt; key: inject Œîv = œâ √ó r</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-comment">// Verlet (deep space: no gravity terms)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// mouth pinned only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }

    <span class="hljs-comment">// pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// ---------- NEW: Angular impulse (stable) ----------</span>
  <span class="hljs-title function_">applyMouthAngularImpulse</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Only apply while active and non-zero length</span>
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> omega = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(omega) &lt; <span class="hljs-number">1e-6</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// scale per substep so total per-frame impulse is consistent</span>
    <span class="hljs-keyword">const</span> k = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinCoupling</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>);
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth (pinned)</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">const</span> ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-comment">// Œîv = œâ √ó r  (2D: (-œâ*ry, œâ*rx))</span>
      <span class="hljs-keyword">let</span> dvx = -omega * ry * k;
      <span class="hljs-keyword">let</span> dvy =  omega * rx * k;

      <span class="hljs-comment">// falloff toward the tip (optional)</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n; <span class="hljs-comment">// 0 at mouth, 1 at tip</span>
        <span class="hljs-keyword">const</span> w = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t; <span class="hljs-comment">// linear fade</span>
        dvx *= <span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, w);
        dvy *= <span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, w);
      }

      <span class="hljs-comment">// Inject velocity by moving xPrev opposite to Œîv</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// stretch</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// soft bend</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor only while expanding and tip not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" (no hard pin)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// release when fully collapsed</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Allow sticky contact during expansion OR retraction</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();

      <span class="hljs-comment">// If we latched while expanding, stop expanding and start retract</span>
      <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      }

      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// starry bg hint</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width;
    <span class="hljs-keyword">const</span> y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  }
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// rope</span>
  <span class="hljs-title function_">drawRope</span>();

  <span class="hljs-comment">// fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
    <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(
      a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
      a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
    );

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
      <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip bulb</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth (spin indicator)</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>;
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = (frameCount * rope.<span class="hljs-property">mouthOmega</span>) % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">660</span>, <span class="hljs-number">128</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + angular *impulse* coupling"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`Mouth œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span> rad/frame   Spin Coupling: <span class="hljs-subst">${rope.spinCoupling}</span>  Falloff: <span class="hljs-subst">${rope.spinFalloff}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p><strong>Tuning tips</strong></p>
<ul>
<li>
<p>Increase <code>spinCoupling</code> to see more pronounced curl; reduce if it feels too lively.</p>
</li>
<li>
<p>Adjust <code>spinFalloff</code> toward <code>0.0</code> for uniform spin along the chain, or <code>1.0</code> to keep spin strongest near the mouth.</p>
</li>
<li>
<p>If you want an initial ‚Äúwhip‚Äù at the <em>moment of launch</em>, you can add a <strong>one-shot</strong> call to <code>applyMouthAngularImpulse()</code> inside <code>shootToward()</code> right after <code>rebuildAlongAim(true)</code>.</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, we are back to crazy spinning. The tongue seems to max out at around 10œÄ-12œÄ per second</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>You're right ‚Äî the previous ‚Äúimpulse‚Äù version was still injecting too much angular energy per frame.</p>
<p>I‚Äôve switched to a <strong>bounded, physically consistent</strong> approach:</p>
<ol>
<li>
<p><strong>Kinematic advection</strong>: rotate both <code>x</code> and <code>xPrev</code> by the small step <code>dŒ∏ = œâ / substeps</code> around the mouth ‚Üí no energy injection, the rope follows the mouth‚Äôs frame.</p>
</li>
<li>
<p><strong>Controlled swirl impulse</strong>: after advection, apply a <strong>capped</strong> tangential velocity impulse derived from <code>dŒ∏</code> (not œâ), i.e. <code>Œîv = dŒ∏ √ó r</code>. We inject it via <code>xPrev -= Œîv * spinImpulseGain</code>, with:</p>
<ul>
<li>
<p><strong>per-point clamp</strong> on |Œîv| (so it can‚Äôt run away),</p>
</li>
<li>
<p>optional <strong>falloff</strong> toward the tip.</p>
</li>
</ul>
</li>
</ol>
<p>This produces visible swirl that scales with œâ but <strong>won‚Äôt explode</strong> or spin uncontrollably.</p>
<p>Here‚Äôs the full, runnable deep-space sketch with the new coupling:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue (rope) in p5.js ‚Äî Deep Space + Stable Angular Coupling
 * - Two-stage Space (Launch -&gt; Retract)
 * - Sticky on expand or retract
 * - Zero-length collapse on retract
 * - Mouth rotation: kinematic advection + capped swirl impulse (from dŒ∏)
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.0</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>, <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Angular coupling params</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,    <span class="hljs-comment">// rad / frame</span>
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,  <span class="hljs-comment">// 0..1 fraction of dŒ∏ used for kinematic rotation (usually 1)</span>
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.5</span>, <span class="hljs-comment">// scales Œîv from dŒ∏√ór injected into velocity (0..1+)</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,    <span class="hljs-comment">// 0=no falloff; 1=full fade to 0 at tip</span>
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.6</span>    <span class="hljs-comment">// max |Œîv| per substep (pixels per substep)</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Two-stage Space:</span>
    <span class="hljs-comment">// - If idle -&gt; LAUNCH</span>
    <span class="hljs-comment">// - If expanding -&gt; RETRACT</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// ride on the tongue tip when true</span>
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-comment">// Deep space: inertial motion</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);

      <span class="hljs-comment">// Keep in-bounds with elastic reflection</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1.0</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1.0</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1.0</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1.0</span>;
      }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// initial vertical build (we realign on first launch)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>); <span class="hljs-comment">// mouth pinned</span>
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;          <span class="hljs-comment">// fully collapsed</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// expanding</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// aim state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// sticky state (tip free; we only mark attachment)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-comment">// mouth orientation tracker (for UI only)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-comment">// ----- Aim + launch -----</span>
  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-comment">// ensure not attached</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// seed length for clean launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// lay the rope along the aim ray and zero velocities</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
      }
    }
  }

  <span class="hljs-comment">// collapse to exact zero length at mouth</span>
  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// ----- per-frame control -----</span>
  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-comment">// user triggers retract</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
      }
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>(); <span class="hljs-comment">// stable angular coupling</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-comment">// track angle for UI spinner</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-comment">// Verlet (deep space: no gravity terms)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// mouth pinned only</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }

    <span class="hljs-comment">// pin mouth</span>
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// ---------- NEW: Stable rotation advection + capped swirl impulse ----------</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Only apply while active and non-zero length</span>
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// Small rotation per substep</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta);
    <span class="hljs-keyword">const</span> s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);

    <span class="hljs-comment">// 1) Kinematic advection (rotate both x and xPrev by dtheta)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth (pinned)</span>
      <span class="hljs-comment">// current</span>
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">let</span> py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-comment">// previous</span>
      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">let</span> qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) Controlled swirl impulse from dŒ∏: Œîv = dŒ∏ √ó r (per substep)</span>
    <span class="hljs-comment">// Clamp Œîv magnitude per point to avoid runaway.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>; <span class="hljs-comment">// pixels per substep</span>
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx;
      <span class="hljs-keyword">const</span> ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-comment">// dŒ∏ √ó r (2D)</span>
      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-comment">// falloff toward tip</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n; <span class="hljs-comment">// 0 at mouth, 1 at tip</span>
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w;
        dvy *= w;
      }

      <span class="hljs-comment">// clamp magnitude</span>
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) {
        <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>);
        dvx *= k; dvy *= k;
      }

      <span class="hljs-comment">// Inject into velocity: move xPrev opposite to Œîv</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// stretch</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// soft bend</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor only while expanding and tip not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2;
    <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy;
    <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) {
      xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum);
      xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum);
    }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) {
      xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum);
      xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum);
    }
  }

  <span class="hljs-comment">// soft "attach" (no hard pin)</span>
  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// zero tip velocity for stability</span>
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    <span class="hljs-comment">// carry the fly with the tip</span>
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);

    <span class="hljs-comment">// release when fully collapsed</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Allow sticky contact during expansion OR retraction</span>
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (
      d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp;
      !rope.<span class="hljs-property">tipAttached</span> &amp;&amp;
      (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)
    ) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();

      <span class="hljs-comment">// If we latched while expanding, stop expanding and start retract</span>
      <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span>) {
        rope.<span class="hljs-title function_">startRetract</span>();
      }

      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// starry bg hint</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width;
    <span class="hljs-keyword">const</span> y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  }
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target crosshair</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>);
  <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
  <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// rope</span>
  <span class="hljs-title function_">drawRope</span>();

  <span class="hljs-comment">// fly</span>
  fly.<span class="hljs-title function_">draw</span>();

  <span class="hljs-comment">// HUD</span>
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
    <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t);
    <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">const</span> uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(
      a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy,
      a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy,
      b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy
    );

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
      <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>);
      <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip bulb</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth (spin indicator)</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>;
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>);
  <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">720</span>, <span class="hljs-number">128</span>, <span class="hljs-number">10</span>);

  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
  <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>);
  <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + stable angular coupling"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  falloff:<span class="hljs-subst">${rope.spinFalloff}</span>  clamp:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Tuning tips</h3>
<ul>
<li>
<p>Start with <code>mouthOmega=0.02</code>, <code>spinImpulseGain=0.5</code>, <code>spinVelClamp=0.6</code>.
Increase <code>spinImpulseGain</code> for more whip; if it gets unruly, raise <code>spinVelClamp</code> a bit or lower the gain.</p>
</li>
<li>
<p><code>spinAdvection</code> controls how much the rope is <em>carried</em> by the rotating mouth (1.0 = full advection).</p>
</li>
<li>
<p><code>spinFalloff</code> near <code>0.5‚Äì0.8</code> looks natural (stronger swirl near the root, calmer at the tip).</p>
</li>
</ul>
<p>If you want the <strong>aim ray</strong> itself to rotate during expansion (e.g., spiral shot), we can rotate <code>aimDir</code> by <code>dŒ∏</code> each substep while <code>shooting</code>.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Better, but the tongue still spins crazily. Can you add a maximum length constrain per bone of 5 and see if that influences the behaviour?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Got it ‚Äî I added a <strong>per-bone max stretch</strong> constraint: each neighbor segment can be at most <strong><code>restLen + 5</code></strong> pixels long. This caps any runaway elongation caused by spin impulses and should tame the crazy rotations without neutering the motion.</p>
<p>Key change:</p>
<ul>
<li>
<p>New option <code>maxExtraStretchPerBone: 5</code></p>
</li>
<li>
<p>New constraint pass <code>enforceMaxStretch(i, i+1, restLen, maxExtra, stiffness=1)</code> that runs <strong>after</strong> the usual stretch solve each iteration.</p>
</li>
</ul>
<p>Full, runnable sketch (deep space + stable spin + capped stretch):</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Deep Space + Stable Angular Coupling
 * + Per-bone max stretch cap (restLen + 5px)
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.0</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,  <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Angular coupling (stable)</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,      <span class="hljs-comment">// rad/frame</span>
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,    <span class="hljs-comment">// fraction of dŒ∏ used for frame advection</span>
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.35</span>, <span class="hljs-comment">// (conservative) tangential Œîv gain</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,      <span class="hljs-comment">// fade toward tip</span>
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.45</span>,    <span class="hljs-comment">// max |Œîv| per substep (px)</span>

    <span class="hljs-comment">// NEW: per-bone max extra stretch beyond rest (px)</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// Stable frame advection + capped swirl</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) kinematic rotation</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) capped swirl impulse from dŒ∏</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) max-length cap: |i - (i+1)| ‚â§ rest + maxExtra</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretch</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) soft bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor while expanding and not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-comment">// NEW: absolute cap ‚Äî segment cannot exceed (restLen + maxExtra)</span>
  <span class="hljs-title function_">enforceMaxStretch</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// already within cap</span>

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>(); <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">760</span>, <span class="hljs-number">146</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + stable spin + max stretch cap"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clamp:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`Max extra stretch per bone: <span class="hljs-subst">${rope.maxExtraStretchPerBone}</span>px`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Why this helps</h3>
<ul>
<li>
<p>The <strong>max-stretch cap</strong> keeps every segment length ‚â§ <code>restLen + 5</code>, so even if impulses try to fling segments outward, they‚Äôre clamped back each iteration. This prevents the rope from ‚Äúballooning‚Äù and throttles angular runaway.</p>
</li>
<li>
<p>You can try smaller/larger caps (e.g., <code>3</code> or <code>8</code>) to balance stiffness vs. liveliness.</p>
</li>
<li>
<p>If you still see too much spin, reduce <code>spinImpulseGain</code> (e.g., <code>0.25</code>) or <code>spinVelClamp</code> (e.g., <code>0.3</code>).</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">It doesn't seem to have affected the segment length, the tongue goes very long. How many segments are there total?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Short answer: <strong>27 segments</strong> (you set <code>numPoints: 28</code>, so segments = <code>numPoints - 1 = 27</code>).</p>
<p>Why it still gets long: each segment‚Äôs <strong>rest length scales</strong> with <code>scale</code>:</p>
<ul>
<li>
<p><code>restSegLen = 14</code></p>
</li>
<li>
<p><code>maxScale = 3.2</code> ‚áí per-segment rest ‚âà <code>14 √ó 3.2 = 44.8 px</code></p>
</li>
<li>
<p>Total rest length at max scale ‚âà <code>27 √ó 44.8 = 1209.6 px</code></p>
</li>
</ul>
<p>My previous cap was <strong>rest + 5</strong>, which also scales up‚Äîso it doesn‚Äôt truly limit the rope in expansion.</p>
<p>If you want a <strong>hard absolute cap</strong> (e.g., each bone ‚â§ 5 px, regardless of scale), add this:</p>
<ol>
<li>
<p>Add an absolute cap option:</p>
</li>
</ol>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// Rope ctor options (set what you want; example here is 50px)</span>
<span class="hljs-attr">maxBoneLenAbs</span>: <span class="hljs-number">50</span>,
</code></pre>
<ol>
<li>
<p>Change the cap line inside <code>enforceMaxStretch</code>:</p>
</li>
</ol>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">const</span> maxLen = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxBoneLenAbs</span> != <span class="hljs-literal">null</span>
  ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(restLen + maxExtra, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxBoneLenAbs</span>) <span class="hljs-comment">// absolute cap dominates</span>
  : (restLen + maxExtra);
</code></pre>
<p>Now each segment can <strong>never</strong> exceed <code>maxBoneLenAbs</code> (e.g., 50 px), even if <code>scale</code> keeps growing.
If you literally meant <strong>5 px per bone</strong>, set <code>maxBoneLenAbs: 5</code> (note: that will basically prevent visible extension).</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Please add these suggestions to the code and produce the full code output again</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Here‚Äôs the full, runnable sketch with a <strong>hard absolute per-bone cap</strong> added. I set <code>maxBoneLenAbs: 5</code> to match your request (note: 5px is extremely short; bump it if you want visible extension). The cap is enforced <strong>every solver iteration</strong> and dominates over the ‚Äúrest + extra‚Äù cap.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Deep Space + Stable Spin + Max Stretch Caps
 * - Hard absolute per-bone cap (maxBoneLenAbs) ‚Äî e.g. 5px
 * - Also keeps the previous "rest + maxExtra" cap
 *
 * Controls:
 *  Click: set aim
 *  Space: Launch -&gt; Space: Retract
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,                <span class="hljs-comment">// =&gt; 27 segments</span>
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.0</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,  <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Stable angular coupling</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,      <span class="hljs-comment">// rad/frame</span>
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,    <span class="hljs-comment">// fraction of dŒ∏ used for frame advection</span>
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.35</span>, <span class="hljs-comment">// tangential Œîv gain (conservative)</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,      <span class="hljs-comment">// fade toward tip</span>
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.45</span>,    <span class="hljs-comment">// max |Œîv| per substep (px)</span>

    <span class="hljs-comment">// Per-bone stretch caps</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// restLen + 5</span>
    <span class="hljs-attr">maxBoneLenAbs</span>: <span class="hljs-number">5</span>           <span class="hljs-comment">// HARD ABSOLUTE CAP (e.g., 5px per bone)</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// Stable frame advection + capped swirl impulse</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) kinematic rotation (no energy injection)</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) capped swirl impulse from dŒ∏</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) max-length caps (absolute dominates)</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretch</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) soft bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor while expanding and not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-comment">// Absolute cap: segment cannot exceed min(restLen + maxExtra, maxBoneLenAbs)</span>
  <span class="hljs-title function_">enforceMaxStretch</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-comment">// absolute cap dominates if provided</span>
    <span class="hljs-keyword">const</span> capFromRest = restLen + maxExtra;
    <span class="hljs-keyword">const</span> maxLen = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxBoneLenAbs</span> != <span class="hljs-literal">null</span>)
      ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(capFromRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxBoneLenAbs</span>)
      : capFromRest;

    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// within cap</span>

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>(); <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth spinner</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">820</span>, <span class="hljs-number">164</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + stable spin + hard per-bone cap"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clamp:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`Caps: rest+<span class="hljs-subst">${rope.maxExtraStretchPerBone}</span>px  |  ABS per-bone ‚â§ <span class="hljs-subst">${rope.maxBoneLenAbs}</span>px`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>If you want the rope to still reach targets while using a very small absolute cap, increase <strong><code>numPoints</code></strong> (more bones) or relax <strong><code>maxBoneLenAbs</code></strong> (e.g., 20‚Äì50 px) so the total reachable length fits your scene.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, please revert that change. Adding a cap like this result in the rope bouncing back and curling around the mouth in a circle</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Got it‚Äîreverted the <strong>absolute per-bone cap</strong>. We‚Äôre back to the previous setup:</p>
<ul>
<li>
<p>Stable mouth rotation via <strong>kinematic advection</strong> (rotate <code>x</code> &amp; <code>xPrev</code> by <code>dŒ∏</code>)</p>
</li>
<li>
<p>A <strong>capped swirl impulse</strong> from <code>dŒ∏ √ó r</code> (gentle by default)</p>
</li>
<li>
<p>Optional <strong>rest+extra</strong> stretch cap (default <code>+5</code>) to prevent runaway elongation, but no hard absolute cap</p>
</li>
</ul>
<p>I also dialed the swirl a bit tamer by default (<code>spinImpulseGain=0.25</code>, <code>spinVelClamp=0.35</code>). Tweak those to taste.</p>
<p>Paste this whole thing into a p5.js sketch:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Deep Space + Stable Spin
 * (absolute per-bone cap REMOVED)
 *
 * Controls:
 *  Click: Aim
 *  Space: Launch -&gt; Space: Retract
 *  B: Toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,                <span class="hljs-comment">// 27 segments</span>
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.0</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.35</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,  <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Stable angular coupling</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,      <span class="hljs-comment">// rad/frame</span>
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,    <span class="hljs-comment">// fraction of dŒ∏ used for frame advection</span>
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.25</span>, <span class="hljs-comment">// tangential Œîv gain (gentle)</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,      <span class="hljs-comment">// fade toward tip</span>
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.35</span>,    <span class="hljs-comment">// max |Œîv| per substep (px)</span>

    <span class="hljs-comment">// Soft cap only: per-bone max extra beyond rest (no hard absolute cap)</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Space: Idle-&gt;Launch, Launch-&gt;Retract</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-comment">// elastic bounds</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// Stable frame advection + capped swirl impulse (no absolute caps)</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) kinematic rotation (no energy injection)</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) gentle swirl impulse from dŒ∏ (capped)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) soft cap: |i - (i+1)| ‚â§ rest + maxExtra</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) soft bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor while expanding and not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-comment">// Soft cap relative to current rest length</span>
  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>(); <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth spinner</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">760</span>, <span class="hljs-number">146</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + stable spin (no absolute cap)"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clamp:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`Soft cap: per-bone ‚â§ rest + <span class="hljs-subst">${rope.maxExtraStretchPerBone}</span>px`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>If it still ‚Äúwhirls up‚Äù more than you like, nudge either:</p>
<ul>
<li>
<p><code>spinImpulseGain</code> down (e.g., <code>0.15</code>)</p>
</li>
<li>
<p>or <code>spinVelClamp</code> down (e.g., <code>0.25</code>)</p>
</li>
</ul>
<p>‚Ä¶and/or increase <code>iterations</code> to 10‚Äì12 for a stiffer solve.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">What I don't get is, why is the tongue spinning around its root/anchor point faster than the mouth is spinning?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Short version: because our rope isn‚Äôt a rigid body and we‚Äôre injecting + redistributing energy, parts of it can end up with <strong>tangential velocity larger than the mouth‚Äôs</strong>. Four main culprits in this setup:</p>
<ol>
<li>
<p><strong>Impulse &gt; advection:</strong>
We advect (rotate) <code>x</code> &amp; <code>xPrev</code> by <code>dŒ∏</code> (good‚Äîno relative velocity), but then we also add a <strong>tangential impulse</strong> <code>Œîv = dŒ∏ √ó r</code>. That impulse grows with radius (<code>|Œîv| ‚àù r</code>), so distal points get <em>more</em> spin than the mouth‚Äôs frame would give.</p>
</li>
<li>
<p><strong>Constraint projection ‚Äúpumps‚Äù tangential speed:</strong>
PBD stretch/bend solves are <em>position</em> corrections. When a segment over-stretches during rotation, the solver pulls it back radially. With zero damping, those radial corrections plus rotation can convert into extra <strong>tangential velocity</strong> on the next Verlet step (classic PBD energy gain artifact).</p>
</li>
<li>
<p><strong>No (or tiny) damping:</strong>
We set drag to ~0 (deep space). Without velocity damping, every little over-correction or alignment nudge persists and compounds over frames/substeps.</p>
</li>
<li>
<p><strong>Motors while changing length:</strong>
During expansion we run the <strong>alignment motor</strong> toward an aim ray while also rotating the mouth and changing <code>scale</code>. Those goals fight each other and can inject lateral (tangential) components‚Äîanother source of ‚Äúfree energy.‚Äù</p>
</li>
</ol>
<hr>
<h2>Two fixes that tame the overspin (keep the feel, cap the crazy)</h2>
<h3>A) Clamp angular speed per point (rigid-body-aware limit)</h3>
<p>Force the tangential velocity of each point to respect a maximum angular speed relative to the mouth:</p>
<ul>
<li>
<p>Compute current velocity <code>v = x - xPrev</code>.</p>
</li>
<li>
<p>Split into <strong>tangential</strong> (along <code>t = perp(rÃÇ)</code>) and <strong>radial</strong>.</p>
</li>
<li>
<p>Clamp <code>|v_t| ‚â§ œâ_max * |r|</code>.</p>
</li>
<li>
<p>Optionally apply angular friction to bleed extra swirl.</p>
</li>
</ul>
<p>Drop this helper into your Rope class:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// Call this after applyMouthRotationAndSwirl() and before solveConstraints()</span>
<span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// Let the rope swing max at ~k * mouthOmega; tune k down if still wild.</span>
  <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;       <span class="hljs-comment">// e.g., 1.2√ó the mouth</span>
  <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
  <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>; <span class="hljs-comment">// 0..1 (0 = none)</span>

  <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth (pinned)</span>
    <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
    <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

    <span class="hljs-comment">// current velocity</span>
    <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// radial &amp; tangential frame</span>
    <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
    <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) { 
      <span class="hljs-comment">// too close to center; just apply friction and continue</span>
      vx *= (<span class="hljs-number">1</span> - angFric);
      vy *= (<span class="hljs-number">1</span> - angFric);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
    <span class="hljs-keyword">const</span> tx = -ry * invr; <span class="hljs-comment">// unit tangent (perp to radius)</span>
    <span class="hljs-keyword">const</span> ty =  rx * invr;

    <span class="hljs-comment">// decompose</span>
    <span class="hljs-keyword">const</span> vt = vx * tx + vy * ty;                <span class="hljs-comment">// tangential speed (px/frame)</span>
    <span class="hljs-keyword">const</span> vr = vx * (rx * invr) + vy * (ry * invr); <span class="hljs-comment">// radial component</span>

    <span class="hljs-comment">// apply angular friction to tangential part</span>
    <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);

    <span class="hljs-comment">// clamp tangential speed to œâ_max * r</span>
    <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) {
      vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;
    }

    <span class="hljs-comment">// rebuild velocity = radial + clamped tangential</span>
    <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr; <span class="hljs-comment">// unit radial</span>
    <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
    <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

    <span class="hljs-comment">// write back by moving xPrev (Verlet velocity edit)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
  }
}
</code></pre>
<p><strong>Hook it up:</strong> in <code>simulate()</code> right after <code>applyMouthRotationAndSwirl()</code>:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>();
</code></pre>
<p>And add two tunables to your options:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,     <span class="hljs-comment">// &lt;= cap tangential speed to ~120% of mouth rate</span>
<span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.15</span>,   <span class="hljs-comment">// &lt;= bleed swirl a bit each step</span>
</code></pre>
<h3>B) De-energize the sources</h3>
<ul>
<li>
<p>Set <code>spinImpulseGain = 0</code> (or very small like 0.1). You already get ‚Äúcarry‚Äù from kinematic rotation; the impulse is what makes distal points outrun the mouth.</p>
</li>
<li>
<p>Lower <code>alignK</code> during expansion while the mouth is spinning (or temporarily set <code>_alignGain = 0</code> as soon as the rope starts rotating).</p>
</li>
<li>
<p>Add a <strong>tiny</strong> <code>airDrag</code>, e.g. <code>airDrag = 0.02‚Äì0.05</code> to absorb solver-injected energy.</p>
</li>
</ul>
<hr>
<h2>TL;DR recipe that usually ‚Äújust works‚Äù</h2>
<ul>
<li>
<p>Keep advection (rotate <code>x</code> and <code>xPrev</code> by <code>dŒ∏</code>)</p>
</li>
<li>
<p>Set <code>spinImpulseGain = 0</code> (or ‚â§ 0.1), keep <code>spinVelClamp</code> low (‚â§ 0.3)</p>
</li>
<li>
<p>Add <code>applyAngularFrictionAndClamp()</code> with <code>omegaMaxFactor ‚âà 1.1‚Äì1.3</code>, <code>angularFriction ‚âà 0.1‚Äì0.25</code></p>
</li>
<li>
<p>Optionally <code>airDrag = 0.02</code></p>
</li>
<li>
<p>Consider reducing <code>alignK</code> while rotating</p>
</li>
</ul>
<p>If you want, I can drop a full version with these exact changes wired in.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, please regenerate the full code with these additional changes</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Here‚Äôs the full, runnable p5.js sketch with the <strong>angular-speed clamp</strong> and <strong>angular friction</strong> added. I also set a small <strong>airDrag</strong> and made the alignment motor gentler while spinning. The swirl impulse is kept minimal by default.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Deep Space + Stable Spin
 * Angular-speed clamp + angular friction to prevent overspin
 *
 * Controls:
 *  Click: Aim
 *  Space: Launch -&gt; Space: Retract
 *  B: Toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">28</span>,                <span class="hljs-comment">// 27 segments</span>
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space (but with a tiny drag to bleed solver energy)</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.03</span>,                <span class="hljs-comment">// small damping helps stability</span>

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.30</span>,                 <span class="hljs-comment">// a bit gentler base alignment</span>
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">alignWhileSpinningFactor</span>: <span class="hljs-number">0.5</span>,<span class="hljs-comment">// reduce alignment motor while rotating</span>

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,  <span class="hljs-comment">// zero-length collapse threshold</span>
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>, <span class="hljs-comment">// seed length for clean launch</span>

    <span class="hljs-comment">// Stable angular coupling</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,      <span class="hljs-comment">// rad/frame</span>
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,    <span class="hljs-comment">// fraction of dŒ∏ used for frame advection</span>
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.05</span>, <span class="hljs-comment">// minimal tangential Œîv (or set 0 to disable)</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,      <span class="hljs-comment">// fade toward tip</span>
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.25</span>,    <span class="hljs-comment">// cap |Œîv| per substep (px)</span>

    <span class="hljs-comment">// Soft cap only: per-bone max extra beyond rest (no hard absolute cap)</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>,

    <span class="hljs-comment">// NEW: angular-speed clamp + angular friction</span>
    <span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,   <span class="hljs-comment">// cap tangential speed to ~120% of mouth rate</span>
    <span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.18</span>  <span class="hljs-comment">// bleed swirl per step (0..1)</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Space: Idle-&gt;Launch, Launch-&gt;Retract</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-comment">// elastic bounds</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-comment">// alignment motor decays; also reduce it when spinning (to avoid injecting tangential energy)</span>
    <span class="hljs-keyword">const</span> spinning = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>) &gt; <span class="hljs-number">1e-6</span>;
    <span class="hljs-keyword">const</span> spinFactor = spinning ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignWhileSpinningFactor</span> : <span class="hljs-number">1.0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();    <span class="hljs-comment">// kinematic carry + tiny impulse</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>();  <span class="hljs-comment">// NEW: cap angular speed &amp; bleed swirl</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// Stable frame advection + capped swirl impulse (no absolute caps)</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) kinematic rotation (no energy injection)</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) tiny swirl impulse from dŒ∏ (capped)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">if</span> (gain &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-comment">// Edit velocity via xPrev</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-comment">// NEW: clamp angular speed per point and apply angular friction</span>
  <span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;      <span class="hljs-comment">// factor over mouth omega</span>
    <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
    <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// current velocity</span>
      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// vector from mouth</span>
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) {
        <span class="hljs-comment">// too close to center; just apply global friction</span>
        vx *= (<span class="hljs-number">1</span> - angFric);
        vy *= (<span class="hljs-number">1</span> - angFric);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
      <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr; <span class="hljs-comment">// unit radial</span>
      <span class="hljs-keyword">const</span> tx = -ry * invr, ty = rx * invr;  <span class="hljs-comment">// unit tangent</span>

      <span class="hljs-comment">// decompose velocity</span>
      <span class="hljs-keyword">const</span> vr = vx * rxu + vy * ryu;  <span class="hljs-comment">// radial scalar</span>
      <span class="hljs-keyword">const</span> vt = vx * tx  + vy * ty;   <span class="hljs-comment">// tangential scalar</span>

      <span class="hljs-comment">// apply angular friction to tangential part</span>
      <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);

      <span class="hljs-comment">// clamp tangential speed by œâ_max * r</span>
      <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) {
        vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;
      }

      <span class="hljs-comment">// rebuild velocity = radial + clamped tangential</span>
      <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
      <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

      <span class="hljs-comment">// write back via xPrev</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) soft cap: |i - (i+1)| ‚â§ rest + maxExtra</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) soft bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor while expanding and not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-comment">// Soft cap relative to current rest length</span>
  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>); <span class="hljs-comment">// (typo intentionally kept consistent)</span>
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">12</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
    <span class="hljs-title function_">pop</span>(); <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);

  <span class="hljs-comment">// mouth spinner</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">14</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">4</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">780</span>, <span class="hljs-number">160</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + stable spin + angular clamp"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ: <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clamp:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`œâ clamp factor: <span class="hljs-subst">${rope.omegaMaxFactor.toFixed(<span class="hljs-number">2</span>)}</span>  angular friction: <span class="hljs-subst">${rope.angularFriction.toFixed(<span class="hljs-number">2</span>)}</span>  airDrag: <span class="hljs-subst">${rope.airDrag.toFixed(<span class="hljs-number">2</span>)}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p><strong>Tweakables if you still see overspin:</strong></p>
<ul>
<li>
<p>Set <code>spinImpulseGain = 0</code> (pure advection, no added swirl).</p>
</li>
<li>
<p>Increase <code>angularFriction</code> to <code>0.22‚Äì0.28</code>.</p>
</li>
<li>
<p>Lower <code>omegaMaxFactor</code> to <code>1.0‚Äì1.1</code>.</p>
</li>
<li>
<p>Raise <code>airDrag</code> slightly to <code>0.04‚Äì0.06</code>.</p>
</li>
<li>
<p>Bump <code>iterations</code> to <code>10‚Äì12</code> for a stiffer solve.</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">YES that works!
OK, now can you shorten the max length of each segment?
Currently it's about 40px, but I would like a max of 12px. Don't modify the physics of the simulation if possible.</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Excellent ‚Äî that means the angular clamp and friction are doing their job!</p>
<p>To shorten the rope segments to about <strong>12 px max each</strong> while keeping the physics identical, just lower the <strong>rest segment length</strong> (<code>restSegLen</code>) and adjust the number of points so the overall reach feels similar.</p>
<p>In your <code>Rope</code> constructor options near the top of <code>setup()</code>:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes">rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
  <span class="hljs-attr">numPoints</span>: <span class="hljs-number">47</span>,             <span class="hljs-comment">// was 28; more points = same total length</span>
  <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">12</span>,            <span class="hljs-comment">// was 14</span>
  ...
});
</code></pre>
<p>That keeps roughly the same total rope length (<code>14 √ó 27 ‚âà 378 px</code> ‚Üí <code>12 √ó 46 ‚âà 552 px</code>, slightly longer‚Äîtrim numPoints if you want identical reach).
If you want <em>exactly</em> the same total length, use <code>numPoints: 33</code> ‚Üí <code>12 √ó 32 ‚âà 384 px</code>.</p>
<p>Everything else (constraints, stiffness, scaling, etc.) stays the same ‚Äî the rope just becomes denser, with shorter bones that behave more smoothly and can bend more finely.</p>
<p>Would you like me to regenerate the full code with <code>restSegLen = 12</code> and the segment count adjusted for similar total reach (‚âà 380 px)?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, great. I've modified a few parameters:

numPoints: 60
restSegLen: 2
airDrag: 0.1

It smoothens the simulation and makes the tongue feel a bit more realistic.
Now, I'd like you to add the ability to add/remove to mouthOmega by pressing z/x.
I want to stress test the simulation when angular velocity is added in the opposite direction (counterclockwise) of the current angular direction (clockwise)</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Awesome‚Äîthose settings (60 points, 2px bones, a bit of drag) make it feel great.</p>
<p>Below is the full sketch with <strong>runtime angular speed controls</strong>:</p>
<ul>
<li>
<p>Press <strong>X</strong> ‚Üí increase <code>mouthOmega</code></p>
</li>
<li>
<p>Press <strong>Z</strong> ‚Üí decrease <code>mouthOmega</code> (goes negative = counter-clockwise)</p>
</li>
<li>
<p>HUD shows the current œâ in rad/frame</p>
</li>
</ul>
<p>Everything else (PBD, clamp, friction, sticky logic, expand/retract) is unchanged.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Deep Space + Stable Spin + Angular Clamp
 * Now with runtime œâ controls: Z/X to dec/ inc mouthOmega
 *
 * Controls:
 *  Click: Aim
 *  Space: Launch -&gt; Space: Retract
 *  Z: decrease œâ (more negative = faster CCW)
 *  X: increase œâ (more positive = faster CW)
 *  B: Toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> frogMouth;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_STEP</span> = <span class="hljs-number">0.005</span>;   <span class="hljs-comment">// rad/frame per tap (tweak if you want)</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span> = <span class="hljs-number">0.25</span>; <span class="hljs-comment">// safety ceiling; set higher/lower to taste</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  frogMouth = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  <span class="hljs-comment">// Your updated density &amp; damping</span>
  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">60</span>,               <span class="hljs-comment">// ‚Üê user change (was 28)</span>
    <span class="hljs-attr">mouthPos</span>: frogMouth.<span class="hljs-title function_">copy</span>(),

    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">2</span>,               <span class="hljs-comment">// ‚Üê user change (was 14)</span>
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Deep space with a bit more damping</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.1</span>,                <span class="hljs-comment">// ‚Üê user change (was 0.03)</span>

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.30</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">alignWhileSpinningFactor</span>: <span class="hljs-number">0.5</span>,

    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>,

    <span class="hljs-comment">// Angular coupling (unchanged defaults)</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,      <span class="hljs-comment">// initial œâ; adjust with Z/X</span>
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.05</span>, <span class="hljs-comment">// very small; set 0 to disable swirl impulse entirely</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// Soft cap beyond rest</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>,

    <span class="hljs-comment">// Angular clamp &amp; friction</span>
    <span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,
    <span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.18</span>
  });

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  frogMouth.<span class="hljs-title function_">set</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouth</span>(frogMouth);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-comment">// Space: Idle-&gt;Launch, Launch-&gt;Retract</span>
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'x'</span> || key === <span class="hljs-string">'X'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> + <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'z'</span> || key === <span class="hljs-string">'Z'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> - <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-comment">// elastic bounds</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-title function_">copy</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(p.<span class="hljs-title function_">copy</span>());
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(i === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>; }
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">mouthPos</span>(<span class="hljs-params">v</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v; }
  <span class="hljs-title function_">setMouth</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span> = v.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouth</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-comment">// alignment motor decays; reduce it when spinning</span>
    <span class="hljs-keyword">const</span> spinning = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>) &gt; <span class="hljs-number">1e-6</span>;
    <span class="hljs-keyword">const</span> spinFactor = spinning ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignWhileSpinningFactor</span> : <span class="hljs-number">1.0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();    <span class="hljs-comment">// kinematic carry + tiny impulse</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>();  <span class="hljs-comment">// cap angular speed &amp; bleed swirl</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];
      <span class="hljs-keyword">const</span> vx = (p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>) * drag;
      <span class="hljs-keyword">const</span> vy = (p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>) * drag;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx;
      p.<span class="hljs-property">y</span> += vy;
    }
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  }

  <span class="hljs-comment">// Stable frame advection + capped swirl impulse (no absolute caps)</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) kinematic rotation (no energy injection)</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) tiny swirl impulse from dŒ∏ (capped)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">if</span> (gain &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-comment">// Edit velocity via xPrev</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-comment">// Clamp angular speed per point and apply angular friction</span>
  <span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;      <span class="hljs-comment">// factor over mouth omega</span>
    <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
    <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) { <span class="hljs-comment">// skip mouth</span>
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// current velocity</span>
      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// vector from mouth</span>
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) {
        <span class="hljs-comment">// too close to center; just apply global friction</span>
        vx *= (<span class="hljs-number">1</span> - angFric);
        vy *= (<span class="hljs-number">1</span> - angFric);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
      <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr; <span class="hljs-comment">// unit radial</span>
      <span class="hljs-keyword">const</span> tx = -ry * invr, ty = rx * invr;  <span class="hljs-comment">// unit tangent</span>

      <span class="hljs-comment">// decompose velocity</span>
      <span class="hljs-keyword">const</span> vr = vx * rxu + vy * ryu;  <span class="hljs-comment">// radial scalar</span>
      <span class="hljs-keyword">const</span> vt = vx * tx  + vy * ty;   <span class="hljs-comment">// tangential scalar</span>

      <span class="hljs-comment">// apply angular friction to tangential part</span>
      <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);

      <span class="hljs-comment">// clamp tangential speed by œâ_max * r</span>
      <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) {
        vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;
      }

      <span class="hljs-comment">// rebuild velocity = radial + clamped tangential</span>
      <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
      <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

      <span class="hljs-comment">// write back via xPrev</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// pin mouth</span>
      <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthIdx</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);

      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) soft cap: |i - (i+1)| ‚â§ rest + maxExtra</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) soft bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// alignment motor while expanding and not attached</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }

      <span class="hljs-comment">// re-apply mouth pin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[m].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-comment">// Soft cap relative to current rest length</span>
  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">8</span>; <span class="hljs-comment">// thinner for many small bones</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
    <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">10</span>);
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>, <span class="hljs-number">16</span>);
    <span class="hljs-title function_">pop</span>(); <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">10</span>);

  <span class="hljs-comment">// mouth spinner</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">10</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">3</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">880</span>, <span class="hljs-number">178</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî deep space + stable spin + angular clamp"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   Z/X: -/+ œâ   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  RestLen: <span class="hljs-subst">${rope.restSegLen}</span>px  Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ (rad/frame): <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clampŒîv:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`œâ clamp factor: <span class="hljs-subst">${rope.omegaMaxFactor.toFixed(<span class="hljs-number">2</span>)}</span>  angular friction: <span class="hljs-subst">${rope.angularFriction.toFixed(<span class="hljs-number">2</span>)}</span>  airDrag: <span class="hljs-subst">${rope.airDrag.toFixed(<span class="hljs-number">2</span>)}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p>If you want totally unbounded œâ for torture-testing, set <code>OMEGA_HARD_LIMIT</code> higher or remove the <code>constrain</code> calls‚Äîeverything else (friction + clamp) will still keep the rope sane.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, that works very well! We are making significant progress towards a final product.
Now, let's move to the next requirement: Can you add weight to the mouth, and make the rope apply forces to the mouth?
First describe what you intend to do, then provide the updated code</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Love this next step. Here‚Äôs what I‚Äôm going to do‚Äîand why‚Äîbefore dropping the full updated sketch.</p>
<h1>Plan: make the mouth a weighted, reactive body</h1>
<p><strong>Goal:</strong> the rope should ‚Äúpull‚Äù the mouth, and the mouth should have inertia (mass).</p>
<p>How we‚Äôll achieve that in PBD:</p>
<ol>
<li>
<p><strong>Give the mouth mass</strong></p>
<ul>
<li>
<p>Previously the mouth (point <code>0</code>) was <em>pinned</em> (<code>invMass=0</code>).</p>
</li>
<li>
<p>Now it becomes a normal PBD particle with <code>invMass = 1 / mouthMass</code>.</p>
</li>
<li>
<p>This means distance constraints between segment <code>0‚Äì1</code>, <code>1‚Äì2</code>, ‚Ä¶ will now <em>move the mouth too</em>, i.e., reaction forces.</p>
</li>
</ul>
</li>
<li>
<p><strong>Remove pinning code</strong></p>
<ul>
<li>
<p>We stop forcibly setting <code>x[0]</code> to a fixed position in <code>integrate()</code> and <code>solveConstraints()</code>.</p>
</li>
</ul>
</li>
<li>
<p><strong>Add a soft ‚Äúanchor‚Äù spring for the mouth</strong></p>
<ul>
<li>
<p>To keep the frog from drifting across space, we tether the mouth to a <strong>rest anchor</strong> (<code>mouthAnchor</code>) with a damped spring:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! code-block hljs language-abnf" style="display: block;" data-highlighted="yes"><span class="hljs-attribute">F</span> <span class="hljs-operator">=</span> -k * (mouth - mouthAnchor) - c * v
</code></pre>
</li>
<li>
<p>This gives it weight/inertia but keeps it near its home position (like neck muscles).</p>
</li>
</ul>
</li>
<li>
<p><strong>Preserve rotation coupling</strong></p>
<ul>
<li>
<p>We keep the rotation/advection around the <em>current</em> mouth position, so œâ still couples into the rope, even as the mouth moves.</p>
</li>
</ul>
</li>
<li>
<p><strong>Everything else stays the same</strong></p>
<ul>
<li>
<p>Angular clamp + angular friction (to prevent overspin), Z/X to adjust œâ, expand/retract logic, sticky fly.</p>
</li>
</ul>
</li>
</ol>
<hr>
<p>Below is the full, runnable p5.js sketch with those changes. I‚Äôve highlighted notable new options near the top:</p>
<ul>
<li>
<p><code>mouthMass</code> (e.g., 8)</p>
</li>
<li>
<p><code>mouthAnchor</code> (starts at initial mouth position)</p>
</li>
<li>
<p><code>mouthAnchorK</code> (spring stiffness)</p>
</li>
<li>
<p><code>mouthAnchorC</code> (damper coefficient)</p>
</li>
</ul>
<p>Your last tuning (many short bones &amp; more drag) is included:</p>
<ul>
<li>
<p><code>numPoints: 60</code>, <code>restSegLen: 2</code>, <code>airDrag: 0.1</code></p>
</li>
</ul>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Weighted Mouth + Rope Reaction
 * - Mouth is now a mass point (invMass &gt; 0), not pinned
 * - Rope constraints move the mouth (reaction)
 * - Damped spring anchors mouth to a rest pose (mouthAnchor)
 * - Angular clamp + angular friction prevent overspin
 *
 * Controls:
 *  Click: Aim
 *  Space: Launch -&gt; Space: Retract
 *  Z: decrease œâ (CCW), X: increase œâ (CW)
 *  B: Toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_STEP</span> = <span class="hljs-number">0.005</span>;     <span class="hljs-comment">// rad/frame per tap</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span> = <span class="hljs-number">0.25</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-comment">// Start &amp; target</span>
  <span class="hljs-keyword">const</span> mouthStart = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">60</span>,               <span class="hljs-comment">// many short bones</span>
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">2</span>,               <span class="hljs-comment">// ~12px total/6 segments ‚Üí smoother curvature</span>

    <span class="hljs-comment">// Simulation passes</span>
    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Material-ish params</span>
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// Environment (deep space but with damping)</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.1</span>,

    <span class="hljs-comment">// Length driver</span>
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>,

    <span class="hljs-comment">// Alignment ‚Äúmotor‚Äù</span>
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.30</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">alignWhileSpinningFactor</span>: <span class="hljs-number">0.5</span>,

    <span class="hljs-comment">// Angular coupling</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.05</span>,  <span class="hljs-comment">// keep tiny or 0</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// PBD soft cap beyond rest (no absolute cap)</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>,

    <span class="hljs-comment">// Anti-overspin</span>
    <span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,
    <span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.18</span>,

    <span class="hljs-comment">// NEW ‚Äî weighted mouth &amp; anchor spring</span>
    <span class="hljs-attr">mouthMass</span>: <span class="hljs-number">8.0</span>,                 <span class="hljs-comment">// mass of the mouth particle</span>
    <span class="hljs-attr">mouthAnchor</span>: mouthStart.<span class="hljs-title function_">copy</span>(), <span class="hljs-comment">// rest pose (tether target)</span>
    <span class="hljs-attr">mouthAnchorK</span>: <span class="hljs-number">0.25</span>,             <span class="hljs-comment">// spring stiffness</span>
    <span class="hljs-attr">mouthAnchorC</span>: <span class="hljs-number">0.65</span>              <span class="hljs-comment">// damper coefficient</span>
  });

  <span class="hljs-comment">// Place rope initially at the mouth</span>
  rope.<span class="hljs-title function_">initializeMouthAndChain</span>(mouthStart);

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-comment">// Move the anchor to keep relative position similar</span>
  <span class="hljs-keyword">const</span> newAnchor = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouthAnchor</span>(newAnchor);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'x'</span> || key === <span class="hljs-string">'X'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> + <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'z'</span> || key === <span class="hljs-string">'Z'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> - <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-comment">// Allocate arrays; actual initial placement done in initializeMouthAndChain()</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// temporary, set properly in initialize...</span>
    }

    <span class="hljs-comment">// Dynamics state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// Helper to set initial mouth position and lay out chain straight</span>
  <span class="hljs-title function_">initializeMouthAndChain</span>(<span class="hljs-params">mouthStart</span>) {
    <span class="hljs-comment">// Mouth mass (invMass for PBD)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>] = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &gt; <span class="hljs-number">0</span>) ? (<span class="hljs-number">1</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span>) : <span class="hljs-number">0</span>;

    <span class="hljs-comment">// Place mouth at start</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);

    <span class="hljs-comment">// Lay out the rest along -Y from mouth</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(mouthStart, <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] = <span class="hljs-number">1</span>; <span class="hljs-comment">// rope points are movable</span>
    }

    <span class="hljs-comment">// If no anchor provided, anchor to the start</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span> = mouthStart.<span class="hljs-title function_">copy</span>();
    }
  }

  <span class="hljs-comment">// Treat the current mouth position as x[0]</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>]; }

  <span class="hljs-title function_">setMouthAnchor</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-title function_">set</span>(v);
    <span class="hljs-comment">// If collapsed, move mouth directly to anchor</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
    }
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-comment">// keep mouth where it is; place successive points along aim</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">const</span> spinning = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>) &gt; <span class="hljs-number">1e-6</span>;
    <span class="hljs-keyword">const</span> spinFactor = spinning ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignWhileSpinningFactor</span> : <span class="hljs-number">1.0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();                    <span class="hljs-comment">// verlet + forces (including mouth spring)</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();   <span class="hljs-comment">// frame advection + tiny swirl impulse</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>(); <span class="hljs-comment">// anti-overspin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();             <span class="hljs-comment">// stretch/bend (moves mouth too)</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-comment">// per-particle external acceleration</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// Current velocity (Verlet)</span>
      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Base acceleration: gravity</span>
      <span class="hljs-keyword">let</span> ax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> ay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Mouth-only: damped anchor spring</span>
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span>;

        <span class="hljs-comment">// Spring: -k * x</span>
        ax += -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dx;
        ay += -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dy;

        <span class="hljs-comment">// Damper: -c * v</span>
        ax += -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vx;
        ay += -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vy;

        <span class="hljs-comment">// Convert to acceleration by mass: a = F/m = F * invMass</span>
        <span class="hljs-keyword">const</span> invm = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>];
        ax *= invm &gt; <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>; <span class="hljs-comment">// already using Verlet units, so keep as-is</span>
        ay *= invm &gt; <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
      }

      <span class="hljs-comment">// Verlet step with drag and acceleration (dt=1)</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx * drag + ax;
      p.<span class="hljs-property">y</span> += vy * drag + ay;
    }
  }

  <span class="hljs-comment">// Rotate rope around current mouth position and add tiny swirl</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) Kinematic advection (rotate both x and xPrev) ‚Äî skip i=0 (the mouth)</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) Tiny swirl impulse</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">if</span> (gain &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-comment">// Clamp angular speed per point and apply angular friction</span>
  <span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;
    <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
    <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) {
        vx *= (<span class="hljs-number">1</span> - angFric);
        vy *= (<span class="hljs-number">1</span> - angFric);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
      <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr;
      <span class="hljs-keyword">const</span> tx = -ry * invr, ty = rx * invr;

      <span class="hljs-keyword">const</span> vr = vx * rxu + vy * ryu;
      <span class="hljs-keyword">const</span> vt = vx * tx  + vy * ty;

      <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);
      <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;

      <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
      <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) stretch toward rest (moves both endpoints per invMass ‚Äî includes mouth)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) soft cap beyond rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// 4) alignment motor during expansion</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// 5) tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">8</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-comment">// Draw tongue</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// Tip</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">10</span>);

  <span class="hljs-comment">// Mouth (now movable) + spinner showing œâ</span>
  <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">10</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">3</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">920</span>, <span class="hljs-number">196</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî weighted mouth + rope reaction"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   Z/X: -/+ œâ   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  RestLen: <span class="hljs-subst">${rope.restSegLen}</span>px  Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ (rad/frame): <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clampŒîv:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`œâ clamp factor: <span class="hljs-subst">${rope.omegaMaxFactor.toFixed(<span class="hljs-number">2</span>)}</span>  angular friction: <span class="hljs-subst">${rope.angularFriction.toFixed(<span class="hljs-number">2</span>)}</span>  airDrag: <span class="hljs-subst">${rope.airDrag.toFixed(<span class="hljs-number">2</span>)}</span>`</span>,
      <span class="hljs-string">`Mouth mass: <span class="hljs-subst">${rope.mouthMass.toFixed(<span class="hljs-number">2</span>)}</span>  AnchorK: <span class="hljs-subst">${rope.mouthAnchorK.toFixed(<span class="hljs-number">2</span>)}</span>  AnchorC: <span class="hljs-subst">${rope.mouthAnchorC.toFixed(<span class="hljs-number">2</span>)}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Notes &amp; tweaks</h3>
<ul>
<li>
<p><strong>Heavier mouth</strong> ‚Üí increase <code>mouthMass</code>. The rope will tug/lag it less.</p>
</li>
<li>
<p><strong>Looser tether</strong> ‚Üí lower <code>mouthAnchorK</code> (spring) and/or raise <code>mouthAnchorC</code> (damper) to avoid oscillations.</p>
</li>
<li>
<p>Want the frog to <em>drift</em> under repeated swings? Set <code>mouthAnchorK = 0</code> (or very small) and keep <code>mouthAnchorC</code> modest; the rope will slowly ‚Äúwalk‚Äù the mouth around.</p>
</li>
</ul>
<p>If you want the <strong>anchor itself to move</strong> (e.g., arrow keys), we can add that too‚Äîthen you‚Äôd see neck-like dynamics as the mouth chases its anchor while the rope pushes back.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">The mouth always return to the same spot when launching and retracting.
If this was a real physical simulation, would that be the expected result?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Short answer: with how we set it up, yes‚Äîreturning to (roughly) the same spot is expected. In a fully physical model, not necessarily.</p>
<p>Why yours returns:</p>
<ul>
<li>
<p>We gave the mouth a <strong>spring-damper anchor</strong> (<code>mouthAnchorK</code>, <code>mouthAnchorC</code>). That‚Äôs an external ‚Äúneck‚Äù force pulling it back to its rest pose. So after launch/retract, the damper kills velocity and the spring recenters the mouth.</p>
</li>
<li>
<p>The tongue‚Äôs ‚Äúactuation‚Äù is mostly <strong>internal</strong> (changing rest lengths, alignment motor). Internal forces can‚Äôt move the system‚Äôs center of mass in free space. With no other externals, the net effect tends to cancel and the anchor brings the mouth home.</p>
</li>
<li>
<p>Our rotation is partly <strong>kinematic</strong> (advection of rope points). We don‚Äôt apply an equal-and-opposite torque to the mouth from that advection, so there‚Äôs no accumulated drift coming from rotation either. The anchor just recenters.</p>
</li>
</ul>
<p>What a ‚Äúreal‚Äù simulation would do:</p>
<ul>
<li>
<p>If the mouth were <strong>free-floating</strong> (no anchor) and the tongue <strong>interacted with external things</strong> (e.g., stuck to a fly, pushed on an obstacle), the mouth would move to conserve momentum. It would <em>not</em> necessarily return to the same point.</p>
</li>
<li>
<p>If you spin the base in <strong>deep space</strong>, true conservation would couple torques: the tongue spinning up would impart an opposite reaction on the mouth. Our kinematic spin doesn‚Äôt feed that torque back.</p>
</li>
</ul>
<p>If you want more ‚Äúphysical‚Äù behavior:</p>
<ul>
<li>
<p><strong>Reduce or remove the anchor:</strong> lower <code>mouthAnchorK</code> and/or <code>mouthAnchorC</code>. The mouth will wander and settle much less.</p>
</li>
<li>
<p><strong>Let externals matter:</strong> catching a fly (external mass) will tug the mouth; you‚Äôll see a new rest position or drift depending on damping.</p>
</li>
<li>
<p><strong>Motor as forces, not kinematics:</strong> replace the advection spin with a <strong>motorized constraint</strong> that applies equal/opposite impulses to the rope and mouth. Then angular momentum will exchange correctly (the mouth will react to the rope‚Äôs spin).</p>
</li>
<li>
<p><strong>Conserve momentum:</strong> avoid non-physical nudges (e.g., alignment motor) or keep them tiny; otherwise they act like hidden external forces.</p>
</li>
</ul>
<p>If you want, I can convert the current ‚Äúspin advection‚Äù into an impulse-based hinge motor that pushes both the rope and the mouth equally (so the mouth no longer just snaps back by magic, and torques are conserved).</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Assume the mouth to be free floating. Now, even if I lower significantly mouthAnchorK and mouthAnchorC, the mouth moves a lot while retracting, but then once all the particles have returned to the mouth, the mouth is repositionned to its original position. Seems almost like there's an external force that resets the simulation.</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Great catch ‚Äî what you‚Äôre seeing <em>does</em> look like an invisible hand snapping the mouth home. Two things are at play:</p>
<ol>
<li>
<p>You still had a <strong>spring-damper anchor</strong> acting on the mouth. Even if tiny, once the rope stops pulling (when fully retracted), that spring will keep nudging the mouth back toward its original spot.</p>
</li>
<li>
<p>There was a subtle <strong>mass scaling bug</strong> in the anchor force: I wrote a comment about converting force to acceleration via <code>a = F * invMass</code>, but the code only checked <code>invm &gt; 0</code> instead of actually multiplying by <code>invm</code>. That means the mouth‚Äôs ‚Äúmass‚Äù wasn‚Äôt reducing that spring acceleration at all ‚Äî it would return to anchor almost the same regardless of <code>mouthMass</code>.</p>
</li>
</ol>
<h2>What I‚Äôm changing</h2>
<ul>
<li>
<p>Make the anchor truly <strong>optional</strong> (<code>useAnchor: true/false</code>) and add a toggle (<strong>A</strong>) so you can free-float.</p>
</li>
<li>
<p><strong>Fix the mass scaling bug</strong>: multiply the spring/damper force by <code>invMass[0]</code> so a heavier mouth really has more inertia.</p>
</li>
<li>
<p>Everything else stays the same (angular clamp, friction, Z/X to change œâ, your dense short-bone settings, etc.).</p>
</li>
</ul>
<p>Below is the full updated sketch.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Weighted Mouth + Optional Anchor + Correct Mass Scaling
 * - Mouth is a mass point; rope constraints move it (reaction)
 * - Optional spring-damper anchor (toggle with 'A')
 * - FIX: anchor force now scaled by invMass (a = F * invMass)
 * - Angular clamp + angular friction to prevent overspin
 *
 * Controls:
 *  Click: Aim
 *  Space: Launch -&gt; Space: Retract
 *  Z/X: decrease/increase œâ (rad/frame)
 *  A: toggle mouth anchor on/off (free-float when off)
 *  B: Toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> target;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_STEP</span> = <span class="hljs-number">0.005</span>;     <span class="hljs-comment">// rad/frame per tap</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span> = <span class="hljs-number">0.25</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">const</span> mouthStart = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  target = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.65</span>, height * <span class="hljs-number">0.35</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">2</span>,

    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.1</span>,

    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>,

    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.30</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">alignWhileSpinningFactor</span>: <span class="hljs-number">0.5</span>,

    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.05</span>,
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>,

    <span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,
    <span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.18</span>,

    <span class="hljs-comment">// Mouth mass/anchor</span>
    <span class="hljs-attr">mouthMass</span>: <span class="hljs-number">8.0</span>,
    <span class="hljs-attr">useAnchor</span>: <span class="hljs-literal">true</span>,                 <span class="hljs-comment">// ‚Üê toggle with 'A'</span>
    <span class="hljs-attr">mouthAnchor</span>: mouthStart.<span class="hljs-title function_">copy</span>(),  <span class="hljs-comment">// rest target for anchor</span>
    <span class="hljs-attr">mouthAnchorK</span>: <span class="hljs-number">0.25</span>,              <span class="hljs-comment">// spring stiffness</span>
    <span class="hljs-attr">mouthAnchorC</span>: <span class="hljs-number">0.65</span>               <span class="hljs-comment">// damper coefficient</span>
  });

  rope.<span class="hljs-title function_">initializeMouthAndChain</span>(mouthStart);

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (mouseIsPressed) target.<span class="hljs-title function_">set</span>(mouseX, mouseY);

  rope.<span class="hljs-title function_">driveToward</span>(target);
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-keyword">const</span> newAnchor = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouthAnchor</span>(newAnchor);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootToward</span>(target);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'x'</span> || key === <span class="hljs-string">'X'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> + <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'z'</span> || key === <span class="hljs-string">'Z'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> - <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'a'</span> || key === <span class="hljs-string">'A'</span>) {
    rope.<span class="hljs-property">useAnchor</span> = !rope.<span class="hljs-property">useAnchor</span>;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mousePressed</span>(<span class="hljs-params"></span>) {
  target.<span class="hljs-title function_">set</span>(mouseX, mouseY);
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">initializeMouthAndChain</span>(<span class="hljs-params">mouthStart</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>] = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &gt; <span class="hljs-number">0</span>) ? (<span class="hljs-number">1</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span>) : <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(mouthStart, <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span> = mouthStart.<span class="hljs-title function_">copy</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>]; }

  <span class="hljs-title function_">setMouthAnchor</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-title function_">set</span>(v);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
      <span class="hljs-comment">// Only move to anchor automatically if you WANT anchoring on.</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">useAnchor</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
      }
    }
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">shootToward</span>(<span class="hljs-params">worldTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-keyword">const</span> dir = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">sub</span>(worldTarget, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>);
    <span class="hljs-keyword">if</span> (dir.<span class="hljs-title function_">magSq</span>() &lt; <span class="hljs-number">1e-6</span>) dir.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">driveToward</span>(<span class="hljs-params">_target</span>) {
    <span class="hljs-keyword">const</span> spinning = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>) &gt; <span class="hljs-number">1e-6</span>;
    <span class="hljs-keyword">const</span> spinFactor = spinning ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignWhileSpinningFactor</span> : <span class="hljs-number">1.0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();                    <span class="hljs-comment">// Verlet + forces</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();   <span class="hljs-comment">// frame advection + tiny swirl</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>(); <span class="hljs-comment">// anti-overspin</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();             <span class="hljs-comment">// stretch/bend</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// Current velocity</span>
      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Base acceleration</span>
      <span class="hljs-keyword">let</span> ax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> ay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Mouth-only: optional damped anchor spring</span>
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">useAnchor</span>) {
        <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span>;

        <span class="hljs-comment">// Spring force -k*x and damper -c*v</span>
        <span class="hljs-keyword">let</span> <span class="hljs-title class_">Fx</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dx - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vx;
        <span class="hljs-keyword">let</span> <span class="hljs-title class_">Fy</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dy - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vy;

        <span class="hljs-comment">// Convert to acceleration: a = F * invMass</span>
        <span class="hljs-keyword">const</span> invm = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>];
        ax += <span class="hljs-title class_">Fx</span> * invm;
        ay += <span class="hljs-title class_">Fy</span> * invm;
      }

      <span class="hljs-comment">// Verlet step (dt=1)</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx * drag + ax;
      p.<span class="hljs-property">y</span> += vy * drag + ay;
    }
  }

  <span class="hljs-comment">// Rotate around current mouth; tiny swirl impulse</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">if</span> (gain &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-comment">// Clamp angular speed per point and apply angular friction</span>
  <span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;
    <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
    <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) {
        vx *= (<span class="hljs-number">1</span> - angFric);
        vy *= (<span class="hljs-number">1</span> - angFric);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
      <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr;
      <span class="hljs-keyword">const</span> tx = -ry * invr, ty = rx * invr;

      <span class="hljs-keyword">const</span> vr = vx * rxu + vy * ryu;
      <span class="hljs-keyword">const</span> vt = vx * tx  + vy * ty;

      <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);
      <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;

      <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
      <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">0.01</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// simple stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-comment">// target</span>
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">30</span>, <span class="hljs-number">85</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>); <span class="hljs-title function_">noFill</span>();
  <span class="hljs-title function_">circle</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span>, <span class="hljs-number">22</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>, target.<span class="hljs-property">x</span> + <span class="hljs-number">10</span>, target.<span class="hljs-property">y</span>);
  <span class="hljs-title function_">line</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - <span class="hljs-number">10</span>, target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> + <span class="hljs-number">10</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">8</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">10</span>);

  <span class="hljs-comment">// Mouth (movable) + spinner</span>
  <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
  <span class="hljs-comment">// anchor indicator if enabled</span>
  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">useAnchor</span>) { <span class="hljs-title function_">stroke</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>, <span class="hljs-number">120</span>); <span class="hljs-title function_">line</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, rope.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span> - m.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span> - m.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>(); }
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">10</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">3</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">980</span>, <span class="hljs-number">214</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî weighted mouth + optional anchor + proper mass scaling"</span>,
      <span class="hljs-string">"Click: Aim   Space: Launch -&gt; Space: Retract   Z/X: -/+ œâ   A: Toggle Anchor   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  RestLen: <span class="hljs-subst">${rope.restSegLen}</span>px  Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ (rad/frame): <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  gain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  clampŒîv:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`œâ clamp factor: <span class="hljs-subst">${rope.omegaMaxFactor.toFixed(<span class="hljs-number">2</span>)}</span>  angular friction: <span class="hljs-subst">${rope.angularFriction.toFixed(<span class="hljs-number">2</span>)}</span>  airDrag: <span class="hljs-subst">${rope.airDrag.toFixed(<span class="hljs-number">2</span>)}</span>`</span>,
      <span class="hljs-string">`Mouth mass: <span class="hljs-subst">${rope.mouthMass.toFixed(<span class="hljs-number">2</span>)}</span>  Anchor: <span class="hljs-subst">${rope.useAnchor ? <span class="hljs-string">"ON"</span> : <span class="hljs-string">"OFF"</span>}</span>  K:<span class="hljs-subst">${rope.mouthAnchorK.toFixed(<span class="hljs-number">2</span>)}</span>  C:<span class="hljs-subst">${rope.mouthAnchorC.toFixed(<span class="hljs-number">2</span>)}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>How to verify free-float</h3>
<ul>
<li>
<p>Press <strong>A</strong> to toggle the anchor <strong>OFF</strong>.</p>
</li>
<li>
<p>Retract fully a few times. The mouth should <strong>not</strong> snap back to its original spot; it will stay where momentum and the last rope reactions left it (tempered by airDrag).</p>
</li>
<li>
<p>If you re-enable the anchor, it will drift back to the anchor gradually ‚Äî and now the return rate properly depends on <strong>mouthMass</strong> (heavier = slower because we now multiply by <code>invMass</code>).</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Fantastic, we are almost there.

Now I want you to remove the click-to-target feature, and instead let the tongue shoot out starting at the angle at which the mouth is at the moment of launch, and let the physical system handle the trajectory</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Love it ‚Äî moving to a purely physical launch makes the sim feel way more ‚Äúalive.‚Äù</p>
<h1>What I‚Äôm changing</h1>
<ul>
<li>
<p><strong>Remove click-to-aim entirely.</strong> No mouse targeting or crosshair.</p>
</li>
<li>
<p><strong>Launch direction = current mouth angle</strong> at the instant you press Space:</p>
<ul>
<li>
<p>On launch, <code>aimDir = (cos(theta), sin(theta))</code> where <code>theta</code> is the mouth‚Äôs current spin phase.</p>
</li>
<li>
<p>I only use this once to <strong>lay out</strong> the initial extended chain; after that, there‚Äôs <strong>no alignment motor</strong>‚Äîthe trajectory is 100% emergent from the physics (rotation coupling, constraints, damping).</p>
</li>
</ul>
</li>
<li>
<p>Everything else stays: weighted/free-floating mouth, optional anchor (A), œâ controls (Z/X), angular clamp &amp; friction, expand/retract on Space.</p>
</li>
</ul>
<p>Below is the full, runnable p5.js sketch with those changes.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Pure Physical Launch (no click target)
 * - Launch direction is the mouth's instantaneous angle at launch
 * - No alignment-to-target motor after launch; physics governs trajectory
 * - Weighted mouth (optional anchor), angular clamp &amp; friction, œâ controls
 *
 * Controls:
 *  Space: Launch -&gt; Space: Retract
 *  Z / X: decrease / increase œâ (rad/frame)
 *  A: toggle mouth anchor on/off (free-float when off)
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_STEP</span> = <span class="hljs-number">0.005</span>;      <span class="hljs-comment">// rad/frame per tap</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span> = <span class="hljs-number">0.25</span>; <span class="hljs-comment">// safety limit for œâ</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">const</span> mouthStart = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-comment">// Dense rope: your preferred params</span>
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">2</span>,

    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Rope material-ish</span>
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// Deep space with a bit of damping</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.1</span>,

    <span class="hljs-comment">// Length driver</span>
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>,

    <span class="hljs-comment">// (Alignment motor disabled after launch for pure physics)</span>
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.0</span>,                 <span class="hljs-comment">// keep 0; no steering after launch</span>
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">alignWhileSpinningFactor</span>: <span class="hljs-number">0.5</span>,

    <span class="hljs-comment">// Angular coupling</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.05</span>,       <span class="hljs-comment">// tiny swirl; set 0 for strict advection</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// Stretch soft cap</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>,

    <span class="hljs-comment">// Anti-overspin</span>
    <span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,
    <span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.18</span>,

    <span class="hljs-comment">// Mouth mass &amp; optional anchor</span>
    <span class="hljs-attr">mouthMass</span>: <span class="hljs-number">8.0</span>,
    <span class="hljs-attr">useAnchor</span>: <span class="hljs-literal">true</span>,                            <span class="hljs-comment">// toggle with A</span>
    <span class="hljs-attr">mouthAnchor</span>: mouthStart.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">mouthAnchorK</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">mouthAnchorC</span>: <span class="hljs-number">0.65</span>
  });

  rope.<span class="hljs-title function_">initializeMouthAndChain</span>(mouthStart);

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);

  rope.<span class="hljs-title function_">drive</span>();   <span class="hljs-comment">// scale &amp; retract logic (no target needed)</span>
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-keyword">const</span> newAnchor = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouthAnchor</span>(newAnchor);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootFromMouthAngle</span>(); <span class="hljs-comment">// ‚Üê NEW: use current mouth angle as launch direction</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'x'</span> || key === <span class="hljs-string">'X'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> + <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'z'</span> || key === <span class="hljs-string">'Z'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> - <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'a'</span> || key === <span class="hljs-string">'A'</span>) {
    rope.<span class="hljs-property">useAnchor</span> = !rope.<span class="hljs-property">useAnchor</span>;
  }
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-comment">// elastic bounds</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// only used once at launch</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// mouth spin phase</span>
  }

  <span class="hljs-title function_">initializeMouthAndChain</span>(<span class="hljs-params">mouthStart</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>] = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &gt; <span class="hljs-number">0</span>) ? (<span class="hljs-number">1</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span>) : <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(mouthStart, <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span> = mouthStart.<span class="hljs-title function_">copy</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>]; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">setMouthAnchor</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-title function_">set</span>(v);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">useAnchor</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
    }
  }

  <span class="hljs-comment">// NEW: Launch in the direction of the mouth's current angle</span>
  <span class="hljs-title function_">shootFromMouthAngle</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-comment">// Direction from current spin phase</span>
    <span class="hljs-keyword">const</span> theta = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span>;
    <span class="hljs-keyword">const</span> dir = <span class="hljs-title function_">createVector</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta), <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta));
    dir.<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir;

    <span class="hljs-comment">// Lay out initial pose along this direction</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// Disable any alignment motor for pure physical evolution</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
    }
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// No external target; just handle extend/retract &amp; stick timers</span>
  <span class="hljs-title function_">drive</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>; <span class="hljs-comment">// stays 0.0</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// Current velocity</span>
      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Acceleration</span>
      <span class="hljs-keyword">let</span> ax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> ay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Mouth-only: optional damped anchor spring</span>
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">useAnchor</span>) {
        <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span>;

        <span class="hljs-keyword">let</span> <span class="hljs-title class_">Fx</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dx - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vx;
        <span class="hljs-keyword">let</span> <span class="hljs-title class_">Fy</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dy - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vy;

        <span class="hljs-keyword">const</span> invm = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>];
        ax += <span class="hljs-title class_">Fx</span> * invm;
        ay += <span class="hljs-title class_">Fy</span> * invm;
      }

      <span class="hljs-comment">// Verlet step (dt=1)</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx * drag + ax;
      p.<span class="hljs-property">y</span> += vy * drag + ay;
    }
  }

  <span class="hljs-comment">// Rotate around current mouth; tiny swirl impulse</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) Kinematic advection</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) Tiny swirl impulse</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">if</span> (gain &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-comment">// Clamp angular speed per point and apply angular friction</span>
  <span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;
    <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
    <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) {
        vx *= (<span class="hljs-number">1</span> - angFric);
        vy *= (<span class="hljs-number">1</span> - angFric);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
      <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr;
      <span class="hljs-keyword">const</span> tx = -ry * invr, ty = rx * invr;

      <span class="hljs-keyword">const</span> vr = vx * rxu + vy * ryu;
      <span class="hljs-keyword">const</span> vt = vx * tx  + vy * ty;

      <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);
      <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;

      <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
      <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {
      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) soft cap beyond rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// 4) tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">8</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">10</span>);

  <span class="hljs-comment">// mouth (movable) + spinner showing Œ∏</span>
  <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">useAnchor</span>) {
    <span class="hljs-title function_">stroke</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>, <span class="hljs-number">120</span>);
    <span class="hljs-title function_">line</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, rope.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span> - m.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span> - m.<span class="hljs-property">y</span>);
    <span class="hljs-title function_">noStroke</span>();
  }
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">10</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">3</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">860</span>, <span class="hljs-number">178</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî pure physical launch (no target)"</span>,
      <span class="hljs-string">"Space: Launch -&gt; Space: Retract   Z/X: -/+ œâ   A: Toggle Anchor   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  RestLen: <span class="hljs-subst">${rope.restSegLen}</span>px  Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ (rad/frame): <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  swirlGain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  swirlClampŒîv:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`œâ clamp factor: <span class="hljs-subst">${rope.omegaMaxFactor.toFixed(<span class="hljs-number">2</span>)}</span>  angular friction: <span class="hljs-subst">${rope.angularFriction.toFixed(<span class="hljs-number">2</span>)}</span>  airDrag: <span class="hljs-subst">${rope.airDrag.toFixed(<span class="hljs-number">2</span>)}</span>`</span>,
      <span class="hljs-string">`Mouth mass: <span class="hljs-subst">${rope.mouthMass.toFixed(<span class="hljs-number">2</span>)}</span>  Anchor: <span class="hljs-subst">${rope.useAnchor ? <span class="hljs-string">"ON"</span> : <span class="hljs-string">"OFF"</span>}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<h3>Notes</h3>
<ul>
<li>
<p>If you want the launch to use the <strong>instantaneous angular velocity direction</strong> instead (i.e., tangent to the spin), set:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">const</span> dir = <span class="hljs-title function_">createVector</span>(-<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta), <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta)); <span class="hljs-comment">// tangent to rotation</span>
</code></pre>
<p>That makes the tongue ‚Äúlead‚Äù its spin rather than point along the spinner dot.</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">That change broke the simulation, can you modify to reintegrate the alignment motor, but instead of aiming to a target specified by click, create a virtual target at the max length for the tongue in the direction of the angle at moment of launch?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Love it ‚Äî we‚Äôll bring the <strong>alignment motor</strong> back, but aim it at a <strong>virtual target</strong> defined at launch:</p>
<h3>What I‚Äôm changing</h3>
<ul>
<li>
<p>On <strong>launch</strong>, capture the mouth‚Äôs current angle <code>Œ∏</code> and set:</p>
<ul>
<li>
<p><code>aimDir = (cos Œ∏, sin Œ∏)</code> (fixed until retract or next launch)</p>
</li>
<li>
<p>a <strong>virtual target ray</strong> from the current mouth position along <code>aimDir</code></p>
</li>
</ul>
</li>
<li>
<p>During <strong>expansion</strong>, the alignment motor pulls each segment toward positions along that ray with length equal to the <strong>current intended rope length</strong> (<code>scale * restSegLen * i</code>) ‚Äî i.e., it behaves as if there‚Äôs a target at <strong>max reach direction</strong> while the rope extends.</p>
</li>
<li>
<p>No mouse targeting; trajectory is still physical, just guided into a straight ray during expansion (and stops aligning once attached or when retracting finishes).</p>
</li>
</ul>
<p>Everything else stays: weighted/free-floating mouth (optional anchor), œâ controls (Z/X), angular clamp &amp; friction, sticky fly logic, Space: launch‚Üíretract.</p>
<hr>
<h3>Full runnable p5.js sketch</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-javascript code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment">/**
 * PBD Frog Tongue ‚Äî Virtual Launch Target + Alignment Motor (no click)
 * - On launch, aim along mouth's instantaneous angle (Œ∏) toward a virtual max-length target
 * - Alignment motor pulls chain along that ray during expansion (stops on attach/retract)
 * - Weighted mouth (optional anchor), angular clamp &amp; friction, œâ controls
 *
 * Controls:
 *  Space: Launch -&gt; Space: Retract
 *  Z / X: decrease / increase œâ (rad/frame)
 *  A: toggle mouth anchor on/off (free-float when off)
 *  B: toggle bone debug
 */</span>

<span class="hljs-keyword">let</span> rope;
<span class="hljs-keyword">let</span> fly;
<span class="hljs-keyword">let</span> debugBones = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_STEP</span> = <span class="hljs-number">0.005</span>;      <span class="hljs-comment">// rad/frame per tap</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span> = <span class="hljs-number">0.25</span>; <span class="hljs-comment">// safety limit for œâ</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">pixelDensity</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">createCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-title function_">colorMode</span>(<span class="hljs-variable constant_">HSB</span>, <span class="hljs-number">360</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">const</span> mouthStart = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);

  rope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rope</span>({
    <span class="hljs-comment">// Dense rope as per your tuning</span>
    <span class="hljs-attr">numPoints</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">restSegLen</span>: <span class="hljs-number">2</span>,

    <span class="hljs-attr">iterations</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">substeps</span>: <span class="hljs-number">2</span>,

    <span class="hljs-comment">// Rope ‚Äúmaterial‚Äù</span>
    <span class="hljs-attr">stretchStiffness</span>: <span class="hljs-number">0.9</span>,
    <span class="hljs-attr">bendStiffness</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// Deep space with a bit of damping</span>
    <span class="hljs-attr">gravity</span>: <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-attr">airDrag</span>: <span class="hljs-number">0.1</span>,

    <span class="hljs-comment">// Length driver</span>
    <span class="hljs-attr">maxScale</span>: <span class="hljs-number">3.2</span>,
    <span class="hljs-attr">extendSpeed</span>: <span class="hljs-number">0.14</span>,
    <span class="hljs-attr">retractSpeed</span>: <span class="hljs-number">0.035</span>,
    <span class="hljs-attr">epsilonScale</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">minShootScale</span>: <span class="hljs-number">0.20</span>,

    <span class="hljs-comment">// Alignment motor (re-enabled)</span>
    <span class="hljs-attr">alignK</span>: <span class="hljs-number">0.30</span>,
    <span class="hljs-attr">alignFade</span>: <span class="hljs-number">0.86</span>,
    <span class="hljs-attr">alignWhileSpinningFactor</span>: <span class="hljs-number">0.5</span>,

    <span class="hljs-comment">// Angular coupling</span>
    <span class="hljs-attr">mouthOmega</span>: <span class="hljs-number">0.02</span>,
    <span class="hljs-attr">spinAdvection</span>: <span class="hljs-number">1.0</span>,
    <span class="hljs-attr">spinImpulseGain</span>: <span class="hljs-number">0.05</span>,  <span class="hljs-comment">// tiny; set 0 if you want strict advection</span>
    <span class="hljs-attr">spinFalloff</span>: <span class="hljs-number">0.6</span>,
    <span class="hljs-attr">spinVelClamp</span>: <span class="hljs-number">0.25</span>,

    <span class="hljs-comment">// Stretch soft cap</span>
    <span class="hljs-attr">maxExtraStretchPerBone</span>: <span class="hljs-number">5</span>,

    <span class="hljs-comment">// Anti-overspin</span>
    <span class="hljs-attr">omegaMaxFactor</span>: <span class="hljs-number">1.2</span>,
    <span class="hljs-attr">angularFriction</span>: <span class="hljs-number">0.18</span>,

    <span class="hljs-comment">// Mouth mass &amp; optional anchor</span>
    <span class="hljs-attr">mouthMass</span>: <span class="hljs-number">8.0</span>,
    <span class="hljs-attr">useAnchor</span>: <span class="hljs-literal">true</span>,                            <span class="hljs-comment">// toggle with A</span>
    <span class="hljs-attr">mouthAnchor</span>: mouthStart.<span class="hljs-title function_">copy</span>(),
    <span class="hljs-attr">mouthAnchorK</span>: <span class="hljs-number">0.25</span>,
    <span class="hljs-attr">mouthAnchorC</span>: <span class="hljs-number">0.65</span>
  });

  rope.<span class="hljs-title function_">initializeMouthAndChain</span>(mouthStart);

  fly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fly</span>({
    <span class="hljs-attr">pos</span>: <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.7</span>, height * <span class="hljs-number">0.35</span>),
    <span class="hljs-attr">radius</span>: <span class="hljs-number">12</span>
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">background</span>(<span class="hljs-number">260</span>, <span class="hljs-number">30</span>, <span class="hljs-number">8</span>, <span class="hljs-number">100</span>);

  rope.<span class="hljs-title function_">drive</span>();   <span class="hljs-comment">// scale &amp; retract logic</span>
  rope.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-title function_">handleFlyCatch</span>();
  <span class="hljs-title function_">drawScene</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">windowResized</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">resizeCanvas</span>(windowWidth, windowHeight);
  <span class="hljs-keyword">const</span> newAnchor = <span class="hljs-title function_">createVector</span>(width * <span class="hljs-number">0.35</span>, height * <span class="hljs-number">0.65</span>);
  rope.<span class="hljs-title function_">setMouthAnchor</span>(newAnchor);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">keyPressed</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">' '</span>) {
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">shooting</span> &amp;&amp; !rope.<span class="hljs-property">retracting</span>) {
      rope.<span class="hljs-title function_">unpinTip</span>();
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">shootFromMouthAngleWithVirtualTarget</span>(); <span class="hljs-comment">// ‚Üê NEW</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">shooting</span>) {
      rope.<span class="hljs-title function_">startRetract</span>();
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'B'</span> || key === <span class="hljs-string">'b'</span>) {
    debugBones = !debugBones;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'x'</span> || key === <span class="hljs-string">'X'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> + <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'z'</span> || key === <span class="hljs-string">'Z'</span>) {
    rope.<span class="hljs-property">mouthOmega</span> = <span class="hljs-title function_">constrain</span>(rope.<span class="hljs-property">mouthOmega</span> - <span class="hljs-variable constant_">OMEGA_STEP</span>, -<span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>, <span class="hljs-variable constant_">OMEGA_HARD_LIMIT</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'a'</span> || key === <span class="hljs-string">'A'</span>) {
    rope.<span class="hljs-property">useAnchor</span> = !rope.<span class="hljs-property">useAnchor</span>;
  }
}

<span class="hljs-comment">// --------------------- Fly ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fly</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ pos, radius }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = pos.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> = radius;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>);
      <span class="hljs-comment">// elastic bounds</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> &gt; width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span> = width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">x</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> &gt; height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span> = height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">v</span>.<span class="hljs-property">y</span> *= -<span class="hljs-number">1</span>; }
    }
  }
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">push</span>();
    <span class="hljs-title function_">noStroke</span>();
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">200</span>, <span class="hljs-number">80</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sticky</span> ? <span class="hljs-number">40</span> : <span class="hljs-number">70</span>);
    <span class="hljs-title function_">circle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">y</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span> * <span class="hljs-number">2</span>);
    <span class="hljs-title function_">pop</span>();
  }
}

<span class="hljs-comment">// --------------------- Rope (PBD) ---------------------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rope</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opts</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>, opts);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// Alignment state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// set on launch and held during expansion</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// Virtual "max length" target direction captured at launch (for HUD/debug if needed)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">virtualTargetDir</span> = <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> = <span class="hljs-number">30</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// mouth spin phase</span>
  }

  <span class="hljs-title function_">initializeMouthAndChain</span>(<span class="hljs-params">mouthStart</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>] = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span> &gt; <span class="hljs-number">0</span>) ? (<span class="hljs-number">1</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthMass</span>) : <span class="hljs-number">0</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(mouthStart);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(mouthStart, <span class="hljs-title function_">createVector</span>(<span class="hljs-number">0</span>, -i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span> = mouthStart.<span class="hljs-title function_">copy</span>();
  }

  <span class="hljs-keyword">get</span> <span class="hljs-title function_">mouthPos</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>]; }
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tipIdx</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; }
  <span class="hljs-title function_">tipPos</span>(<span class="hljs-params"></span>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>].<span class="hljs-title function_">copy</span>(); }

  <span class="hljs-title function_">setMouthAnchor</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-title function_">set</span>(v);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">useAnchor</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">set</span>(v);
    }
  }

  <span class="hljs-comment">// NEW: Launch using current mouth angle; set alignment toward virtual max-length ray</span>
  <span class="hljs-title function_">shootFromMouthAngleWithVirtualTarget</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minShootScale</span>);

    <span class="hljs-comment">// Direction from current spin phase</span>
    <span class="hljs-keyword">const</span> theta = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span>;
    <span class="hljs-keyword">const</span> dir = <span class="hljs-title function_">createVector</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta), <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta)).<span class="hljs-title function_">normalize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span> = dir.<span class="hljs-title function_">copy</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">virtualTargetDir</span> = dir.<span class="hljs-title function_">copy</span>(); <span class="hljs-comment">// for reference; motor uses aimDir</span>

    <span class="hljs-comment">// Lay out initial pose along this direction (seed pose)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// Enable alignment motor (it will use aimDir and current segRest)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">startRetract</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">true</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> = <span class="hljs-literal">false</span>; }

  <span class="hljs-title function_">rebuildAlongAim</span>(<span class="hljs-params">zeroVel = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> goal = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>, p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">mult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>, segRest * i));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(goal);
    }
    <span class="hljs-keyword">if</span> (zeroVel) <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i]);
  }

  <span class="hljs-title function_">collapseToMouth</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> m = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// No mouse target; just extend/retract &amp; alignment gain fading</span>
  <span class="hljs-title function_">drive</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> spinning = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>) &gt; <span class="hljs-number">1e-6</span>;
    <span class="hljs-keyword">const</span> spinFactor = spinning ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignWhileSpinningFactor</span> : <span class="hljs-number">1.0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">extendSpeed</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxScale</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">retractSpeed</span>, <span class="hljs-number">0.0</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> = <span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * spinFactor);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collapseToMouth</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span> *= <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignFade</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span>++;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">stickFrames</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStickFrames</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startRetract</span>();
    }
  }

  <span class="hljs-title function_">simulate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> s = <span class="hljs-number">0</span>; s &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>; s++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">integrate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyMouthRotationAndSwirl</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyAngularFrictionAndClamp</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">solveConstraints</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_theta</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>;
  }

  <span class="hljs-title function_">integrate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> drag = <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">airDrag</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-comment">// Current velocity</span>
      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Acceleration</span>
      <span class="hljs-keyword">let</span> ax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> ay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gravity</span>.<span class="hljs-property">y</span>;

      <span class="hljs-comment">// Mouth-only: optional damped anchor spring</span>
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">useAnchor</span>) {
        <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span>;

        <span class="hljs-keyword">let</span> <span class="hljs-title class_">Fx</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dx - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vx;
        <span class="hljs-keyword">let</span> <span class="hljs-title class_">Fy</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorK</span> * dy - <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthAnchorC</span> * vy;

        <span class="hljs-keyword">const</span> invm = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[<span class="hljs-number">0</span>];
        ax += <span class="hljs-title class_">Fx</span> * invm;
        ay += <span class="hljs-title class_">Fy</span> * invm;
      }

      <span class="hljs-comment">// Verlet step (dt=1)</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>);
      p.<span class="hljs-property">x</span> += vx * drag + ax;
      p.<span class="hljs-property">y</span> += vy * drag + ay;
    }
  }

  <span class="hljs-comment">// Rotate around current mouth; tiny swirl impulse</span>
  <span class="hljs-title function_">applyMouthRotationAndSwirl</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">epsilonScale</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> sub = <span class="hljs-variable language_">this</span>.<span class="hljs-property">substeps</span>;
    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-comment">// 1) Kinematic advection</span>
    <span class="hljs-keyword">const</span> dtheta = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinAdvection</span>) / sub;
    <span class="hljs-keyword">const</span> c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(dtheta), s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(dtheta);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">let</span> px = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> - cx, py = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> = cx + (c * px - s * py);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> = cy + (s * px + c * py);

      <span class="hljs-keyword">let</span> qx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> - cx, qy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> - cy;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> = cx + (c * qx - s * qy);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> = cy + (s * qx + c * qy);
    }

    <span class="hljs-comment">// 2) Tiny swirl impulse</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dtheta) &lt; <span class="hljs-number">1e-8</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> gain = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinImpulseGain</span> / sub;
    <span class="hljs-keyword">if</span> (gain &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> vmax = <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinVelClamp</span>;
    <span class="hljs-keyword">const</span> n = <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;

      <span class="hljs-keyword">let</span> dvx = -dtheta * ry * gain;
      <span class="hljs-keyword">let</span> dvy =  dtheta * rx * gain;

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = i / n;
        <span class="hljs-keyword">const</span> w = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">spinFalloff</span> * t);
        dvx *= w; dvy *= w;
      }
      <span class="hljs-keyword">const</span> mag = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dvx, dvy);
      <span class="hljs-keyword">if</span> (mag &gt; vmax) { <span class="hljs-keyword">const</span> k = vmax / (mag + <span class="hljs-number">1e-9</span>); dvx *= k; dvy *= k; }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">x</span> -= dvx;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-property">y</span> -= dvy;
    }
  }

  <span class="hljs-comment">// Clamp angular speed per point and apply angular friction</span>
  <span class="hljs-title function_">applyAngularFrictionAndClamp</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> k = <span class="hljs-variable language_">this</span>.<span class="hljs-property">omegaMaxFactor</span> ?? <span class="hljs-number">1.2</span>;
    <span class="hljs-keyword">const</span> omegaMax = k * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>);
    <span class="hljs-keyword">const</span> angFric = <span class="hljs-variable language_">this</span>.<span class="hljs-property">angularFriction</span> ?? <span class="hljs-number">0.15</span>;

    <span class="hljs-keyword">const</span> cx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span>, cy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
      <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i];
      <span class="hljs-keyword">const</span> prev = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i];

      <span class="hljs-keyword">let</span> vx = p.<span class="hljs-property">x</span> - prev.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">let</span> vy = p.<span class="hljs-property">y</span> - prev.<span class="hljs-property">y</span>;

      <span class="hljs-keyword">const</span> rx = p.<span class="hljs-property">x</span> - cx, ry = p.<span class="hljs-property">y</span> - cy;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(rx, ry);
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">1e-6</span>) {
        vx *= (<span class="hljs-number">1</span> - angFric);
        vy *= (<span class="hljs-number">1</span> - angFric);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vx, p.<span class="hljs-property">y</span> - vy);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">const</span> invr = <span class="hljs-number">1</span> / r;
      <span class="hljs-keyword">const</span> rxu = rx * invr, ryu = ry * invr;
      <span class="hljs-keyword">const</span> tx = -ry * invr, ty = rx * invr;

      <span class="hljs-keyword">const</span> vr = vx * rxu + vy * ryu;
      <span class="hljs-keyword">const</span> vt = vx * tx  + vy * ty;

      <span class="hljs-keyword">let</span> vtNew = vt * (<span class="hljs-number">1</span> - angFric);
      <span class="hljs-keyword">const</span> vtMax = omegaMax * r;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(vtNew) &gt; vtMax) vtNew = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(vtNew) * vtMax;

      <span class="hljs-keyword">const</span> vxNew = vr * rxu + vtNew * tx;
      <span class="hljs-keyword">const</span> vyNew = vr * ryu + vtNew * ty;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[i].<span class="hljs-title function_">set</span>(p.<span class="hljs-property">x</span> - vxNew, p.<span class="hljs-property">y</span> - vyNew);
    }
  }

  <span class="hljs-title function_">solveConstraints</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> iters = <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>;
    <span class="hljs-keyword">const</span> segRest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">restSegLen</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>;
    <span class="hljs-keyword">const</span> maxExtra = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxExtraStretchPerBone</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; iters; k++) {

      <span class="hljs-comment">// 1) stretch toward rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">1</span>, segRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stretchStiffness</span>);
        }
      }

      <span class="hljs-comment">// 2) soft cap beyond rest</span>
      <span class="hljs-keyword">if</span> (segRest &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceMaxStretchRestPlus</span>(i, i + <span class="hljs-number">1</span>, segRest, maxExtra, <span class="hljs-number">1.0</span>);
        }
      }

      <span class="hljs-comment">// 3) bend (second neighbors)</span>
      <span class="hljs-keyword">if</span> (segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> bendRest = <span class="hljs-number">2</span> * segRest;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span> - <span class="hljs-number">2</span>; i++) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enforceDistance</span>(i, i + <span class="hljs-number">2</span>, bendRest, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bendStiffness</span>);
        }
      }

      <span class="hljs-comment">// 4) ALIGNMENT MOTOR during expansion, aiming along the launch ray</span>
      <span class="hljs-comment">//    For each point i, the goal is mouthPos + aimDir * (i * segRest)</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shooting</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">let</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_alignGain</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthOmega</span>) &gt; <span class="hljs-number">1e-6</span>) {
          g = <span class="hljs-title function_">min</span>(g, <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignK</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">alignWhileSpinningFactor</span>);
        }
        <span class="hljs-keyword">if</span> (g &gt; <span class="hljs-number">1e-4</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">numPoints</span>; i++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i] === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">const</span> goalX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">x</span> * segRest * i;
            <span class="hljs-keyword">const</span> goalY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">aimDir</span>.<span class="hljs-property">y</span> * segRest * i;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span> += (goalX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">x</span>) * g;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span> += (goalY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i].<span class="hljs-property">y</span>) * g;
          }
        }
      }

      <span class="hljs-comment">// 5) tiny pull on tip during retract for crispness</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">retracting</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> &amp;&amp; segRest &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
        <span class="hljs-keyword">const</span> pull = <span class="hljs-number">0.08</span>;
        <span class="hljs-keyword">const</span> dx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> dy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mouthPos</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">x</span> += dx * pull;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t].<span class="hljs-property">y</span> += dy * pull;
      }
    }
  }

  <span class="hljs-title function_">enforceDistance</span>(<span class="hljs-params">i, j, restLen, stiffness</span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);
    <span class="hljs-keyword">const</span> diff = (d - restLen) / d;

    <span class="hljs-keyword">const</span> corrX = stiffness * diff * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * diff * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">enforceMaxStretchRestPlus</span>(<span class="hljs-params">i, j, restLen, maxExtra, stiffness = <span class="hljs-number">1.0</span></span>) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[i], xj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[j];
    <span class="hljs-keyword">const</span> w1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[i], w2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">invMass</span>[j];
    <span class="hljs-keyword">const</span> wsum = w1 + w2; <span class="hljs-keyword">if</span> (wsum === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> dx = xj.<span class="hljs-property">x</span> - xi.<span class="hljs-property">x</span>, dy = xj.<span class="hljs-property">y</span> - xi.<span class="hljs-property">y</span>;
    <span class="hljs-keyword">const</span> d2 = dx*dx + dy*dy; <span class="hljs-keyword">if</span> (d2 === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> d = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d2);

    <span class="hljs-keyword">const</span> maxLen = restLen + maxExtra;
    <span class="hljs-keyword">if</span> (d &lt;= maxLen) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> excess = (d - maxLen) / d;
    <span class="hljs-keyword">const</span> corrX = stiffness * excess * dx;
    <span class="hljs-keyword">const</span> corrY = stiffness * excess * dy;

    <span class="hljs-keyword">if</span> (w1 &gt; <span class="hljs-number">0</span>) { xi.<span class="hljs-property">x</span> += corrX * (w1 / wsum); xi.<span class="hljs-property">y</span> += corrY * (w1 / wsum); }
    <span class="hljs-keyword">if</span> (w2 &gt; <span class="hljs-number">0</span>) { xj.<span class="hljs-property">x</span> -= corrX * (w2 / wsum); xj.<span class="hljs-property">y</span> -= corrY * (w2 / wsum); }
  }

  <span class="hljs-title function_">pinTipTo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">const</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipIdx</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xPrev</span>[t].<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>[t]);
  }
  <span class="hljs-title function_">unpinTip</span>(<span class="hljs-params"></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipAttached</span> = <span class="hljs-literal">false</span>; }
}

<span class="hljs-comment">// --------------------- Catch logic ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFlyCatch</span>(<span class="hljs-params"></span>) {
  fly.<span class="hljs-title function_">simulate</span>();

  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-title function_">tipPos</span>();

  <span class="hljs-keyword">if</span> (fly.<span class="hljs-property">sticky</span> &amp;&amp; rope.<span class="hljs-property">tipAttached</span>) {
    fly.<span class="hljs-property">p</span>.<span class="hljs-title function_">set</span>(tip);
    <span class="hljs-keyword">if</span> (!rope.<span class="hljs-property">retracting</span> &amp;&amp; rope.<span class="hljs-property">scale</span> &lt;= rope.<span class="hljs-property">epsilonScale</span>) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">false</span>;
      rope.<span class="hljs-title function_">unpinTip</span>();
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> d = p5.<span class="hljs-property">Vector</span>.<span class="hljs-title function_">dist</span>(tip, fly.<span class="hljs-property">p</span>);
    <span class="hljs-keyword">if</span> (d &lt; fly.<span class="hljs-property">r</span> + <span class="hljs-number">10</span> &amp;&amp; !rope.<span class="hljs-property">tipAttached</span> &amp;&amp; (rope.<span class="hljs-property">shooting</span> || rope.<span class="hljs-property">retracting</span>)) {
      fly.<span class="hljs-property">sticky</span> = <span class="hljs-literal">true</span>;
      rope.<span class="hljs-title function_">pinTipTo</span>();
      rope.<span class="hljs-title function_">startRetract</span>();
      rope.<span class="hljs-property">stickFrames</span> = <span class="hljs-number">0</span>;
    }
  }
}

<span class="hljs-comment">// --------------------- Scene / UI ---------------------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawScene</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// stars</span>
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    <span class="hljs-keyword">const</span> x = (i * <span class="hljs-number">73</span>) % width, y = (i * <span class="hljs-number">131</span>) % height;
    <span class="hljs-title function_">fill</span>(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, <span class="hljs-number">90</span>, <span class="hljs-number">70</span>); <span class="hljs-title function_">circle</span>(x, y, <span class="hljs-number">1.5</span>);
  } <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">drawRope</span>();
  fly.<span class="hljs-title function_">draw</span>();
  <span class="hljs-title function_">drawHUD</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawRope</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> w = <span class="hljs-number">8</span>;
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-keyword">const</span> a = rope.<span class="hljs-property">x</span>[i], b = rope.<span class="hljs-property">x</span>[i + <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> t = i / (rope.<span class="hljs-property">numPoints</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> hue = <span class="hljs-title function_">lerp</span>(<span class="hljs-number">350</span>, <span class="hljs-number">5</span>, t); <span class="hljs-title function_">fill</span>(hue, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">95</span>);

    <span class="hljs-keyword">const</span> nx = b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>, ny = -(b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>);
    <span class="hljs-keyword">const</span> nlen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(nx, ny) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> ux = (nx / nlen) * w * <span class="hljs-number">0.5</span>, uy = (ny / nlen) * w * <span class="hljs-number">0.5</span>;

    <span class="hljs-title function_">quad</span>(a.<span class="hljs-property">x</span> - ux, a.<span class="hljs-property">y</span> - uy, a.<span class="hljs-property">x</span> + ux, a.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> + ux, b.<span class="hljs-property">y</span> + uy, b.<span class="hljs-property">x</span> - ux, b.<span class="hljs-property">y</span> - uy);

    <span class="hljs-keyword">if</span> (debugBones) {
      <span class="hljs-title function_">stroke</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">strokeWeight</span>(<span class="hljs-number">1.5</span>);
      <span class="hljs-title function_">line</span>(a.<span class="hljs-property">x</span>, a.<span class="hljs-property">y</span>, b.<span class="hljs-property">x</span>, b.<span class="hljs-property">y</span>); <span class="hljs-title function_">noStroke</span>();
    }
  }

  <span class="hljs-comment">// tip</span>
  <span class="hljs-keyword">const</span> tip = rope.<span class="hljs-property">x</span>[rope.<span class="hljs-property">tipIdx</span>];
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">5</span>, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">circle</span>(tip.<span class="hljs-property">x</span>, tip.<span class="hljs-property">y</span>, <span class="hljs-number">10</span>);

  <span class="hljs-comment">// mouth (movable) + spinner showing Œ∏</span>
  <span class="hljs-keyword">const</span> m = rope.<span class="hljs-property">mouthPos</span>;
  <span class="hljs-title function_">push</span>();
  <span class="hljs-title function_">translate</span>(m.<span class="hljs-property">x</span>, m.<span class="hljs-property">y</span>);
  <span class="hljs-keyword">if</span> (rope.<span class="hljs-property">useAnchor</span>) {
    <span class="hljs-title function_">stroke</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>, <span class="hljs-number">120</span>);
    <span class="hljs-title function_">line</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, rope.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">x</span> - m.<span class="hljs-property">x</span>, rope.<span class="hljs-property">mouthAnchor</span>.<span class="hljs-property">y</span> - m.<span class="hljs-property">y</span>);
    <span class="hljs-title function_">noStroke</span>();
  }
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">110</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-title function_">circle</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> r = <span class="hljs-number">10</span>; <span class="hljs-title function_">fill</span>(<span class="hljs-number">40</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>);
  <span class="hljs-keyword">const</span> theta = rope.<span class="hljs-property">_theta</span> % (<span class="hljs-variable constant_">TWO_PI</span>);
  <span class="hljs-title function_">circle</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * r, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * r, <span class="hljs-number">3</span>);
  <span class="hljs-title function_">pop</span>();

  <span class="hljs-title function_">pop</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHUD</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">push</span>(); <span class="hljs-title function_">noStroke</span>();
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">90</span>); <span class="hljs-title function_">rect</span>(<span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">920</span>, <span class="hljs-number">196</span>, <span class="hljs-number">10</span>);
  <span class="hljs-title function_">fill</span>(<span class="hljs-number">230</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>); <span class="hljs-title function_">textSize</span>(<span class="hljs-number">13</span>); <span class="hljs-title function_">textLeading</span>(<span class="hljs-number">18</span>);
  <span class="hljs-keyword">const</span> state = rope.<span class="hljs-property">shooting</span> ? <span class="hljs-string">"Expanding"</span> : (rope.<span class="hljs-property">retracting</span> ? <span class="hljs-string">"Retracting"</span> : <span class="hljs-string">"Idle"</span>);
  <span class="hljs-title function_">text</span>(
    [
      <span class="hljs-string">"PBD Frog Tongue ‚Äî virtual-target launch + alignment motor"</span>,
      <span class="hljs-string">"Space: Launch -&gt; Space: Retract   Z/X: -/+ œâ   A: Toggle Anchor   B: Debug"</span>,
      <span class="hljs-string">`State: <span class="hljs-subst">${state}</span>`</span>,
      <span class="hljs-string">`Segments: <span class="hljs-subst">${rope.numPoints - <span class="hljs-number">1</span>}</span>  RestLen: <span class="hljs-subst">${rope.restSegLen}</span>px  Scale: <span class="hljs-subst">${rope.scale.toFixed(<span class="hljs-number">2</span>)}</span>  Iter: <span class="hljs-subst">${rope.iterations}</span>  Sub: <span class="hljs-subst">${rope.substeps}</span>`</span>,
      <span class="hljs-string">`œâ (rad/frame): <span class="hljs-subst">${rope.mouthOmega.toFixed(<span class="hljs-number">3</span>)}</span>  adv:<span class="hljs-subst">${rope.spinAdvection}</span>  swirlGain:<span class="hljs-subst">${rope.spinImpulseGain}</span>  swirlClampŒîv:<span class="hljs-subst">${rope.spinVelClamp}</span>`</span>,
      <span class="hljs-string">`œâ clamp factor: <span class="hljs-subst">${rope.omegaMaxFactor.toFixed(<span class="hljs-number">2</span>)}</span>  angular friction: <span class="hljs-subst">${rope.angularFriction.toFixed(<span class="hljs-number">2</span>)}</span>  airDrag: <span class="hljs-subst">${rope.airDrag.toFixed(<span class="hljs-number">2</span>)}</span>`</span>,
      <span class="hljs-string">`Mouth mass: <span class="hljs-subst">${rope.mouthMass.toFixed(<span class="hljs-number">2</span>)}</span>  Anchor: <span class="hljs-subst">${rope.useAnchor ? <span class="hljs-string">"ON"</span> : <span class="hljs-string">"OFF"</span>}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
    <span class="hljs-number">24</span>, <span class="hljs-number">34</span>
  );
  <span class="hljs-title function_">pop</span>();
}
</code></pre>
<p><strong>Notes / tuning</strong></p>
<ul>
<li>
<p>If you want the virtual ‚Äúray‚Äù to be exactly the <strong>max</strong> length regardless of current scale, keep <code>aimDir</code> fixed but you can optionally compute goals with <code>goal = mouthPos + aimDir * (i * restSegLen * maxScale)</code>; I used <code>i * restSegLen * scale</code> so it grows naturally as the tongue extends (feels better), but I can switch to hard-max if you prefer.</p>
</li>
</ul></div>
        </div>
      
          </div>
        </body>
      </html>
    