
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <title>ChatGPT Conversation Log</title>
          <style>
            :root {
              --primary-color: #FFF;
              --user-color: #ff3333;
              --font-size: 16px;
            }
          
            body {
              font-family: ui-sans-serif,-apple-system,system-ui,Segoe UI,Helvetica,Apple Color Emoji,Arial,sans-serif,Segoe UI Emoji,Segoe UI Symbol;
              font-size: var(--font-size);
              background-color: #212121;
              color: var(--primary-color);
              padding: 20px;
              margin: 0 auto;
              line-height: 1.5;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px dashed var(--primary-color);
              padding-bottom: 15px;
              max-width: 1200px;
              margin-left: auto;
              margin-right: auto;
            }
            .title {
              font-size: 24px;
              font-weight: bold;
              margin: 0;
              text-transform: uppercase;
              letter-spacing: 2px;
            }
            .timestamp {
              color: #00cc00;
              font-size: 14px;
              margin-top: 10px;
            }
            .conversation {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
            }
            .message {
              margin-bottom: 20px;
              padding: 10px 20px;
              border-radius: 18px;
              width: fit-content;
              max-width: 80%;
              clear: both;
              overflow: hidden;
            }
            .user-message {
              float: right;
              background-color: #303030;
            }
            .assistant-message {
              float: left;
            }
            .role {
              font-weight: bold;
              margin-bottom: 5px;
              text-transform: uppercase;
            }
            .user-message .role {
              color: #ff3333;
              text-align: right;
            }
            .assistant-message .role {
              color: var(--primary-color);
            }
            .content {
              user-select: text;
              word-wrap: break-word;
            }
            table {
              border: 1px solid var(--primary-color);
              border-collapse: collapse;
              width: 100%;
              margin: 1em 0;
              table-layout: fixed;
            }
            th, td {
                border: 1px solid var(--primary-color);
                text-align: center;
                height: 30px;
                vertical-align: middle;
                padding: 0 10px;
            }
            .content h1 { font-size: 2em; margin: 0.67em 0; }
            .content h2 { font-size: 1.5em; margin: 0.75em 0; }
            .content h3 { font-size: 1.17em; margin: 0.83em 0; }
            .content h4 { font-size: 1em; margin: 1.12em 0; }
            .content h5 { font-size: 0.83em; margin: 1.5em 0; }
            .content h6 { font-size: 0.75em; margin: 1.67em 0; }
            .code-block {
              background-color: #2a2a2a !important;
              color: #fff !important;
              padding: 15px !important;
              margin: 10px 0 !important;
              border-radius: 5px !important;
              border: 1px solid var(--primary-color) !important;
              font-family: "Courier New", monospace !important;
              overflow-x: auto !important;
              width: auto !important;
              max-width: 100% !important;
              box-sizing: border-box !important;
            }
            li{
              margin:15px 0;
            }
            .inline-code{
              background: var(--primary-color);
              color:#000;
              padding:2px 5px;
            }
            /* Basic highlight.js theme */
            .hljs {
              background: transparent;
              color: #fff;
            }
            .hljs-keyword { color: #ff79c6; }
            .hljs-string { color: #f1fa8c; }
            .hljs-number { color: #bd93f9; }
            .hljs-function { color: #50fa7b; }
            .hljs-comment { color: #6272a4; }
            .hljs-title { color: #50fa7b; }
            .hljs-params { color: #f8f8f2; }
            .hljs-built_in { color: #8be9fd; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1 class="title">== ChatGPT Log ==</h1>
            <div class="timestamp">[2025-09-21, 2:55:27 p.m.]</div>
          </div>
          <div class="conversation">
    
        <div class="message user-message">
          <div class="content">I want to make a p5 element that can accept a setup and draw function, but also setups the canvas automatically.
I'm using @p5-wrapper/react, and their default example is as follows:

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactP5Wrapper</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@p5-wrapper/react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sketch</span>(<span class="hljs-params">p5</span>) {
  p5.<span class="hljs-property">setup</span> = <span class="hljs-function">() =&gt;</span> p5.<span class="hljs-title function_">createCanvas</span>(<span class="hljs-number">600</span>, <span class="hljs-number">400</span>, p5.<span class="hljs-property">WEBGL</span>);

  p5.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {
    p5.<span class="hljs-title function_">background</span>(<span class="hljs-number">250</span>);
    p5.<span class="hljs-title function_">normalMaterial</span>();
    p5.<span class="hljs-title function_">push</span>();
    p5.<span class="hljs-title function_">rotateZ</span>(p5.<span class="hljs-property">frameCount</span> * <span class="hljs-number">0.01</span>);
    p5.<span class="hljs-title function_">rotateX</span>(p5.<span class="hljs-property">frameCount</span> * <span class="hljs-number">0.01</span>);
    p5.<span class="hljs-title function_">rotateY</span>(p5.<span class="hljs-property">frameCount</span> * <span class="hljs-number">0.01</span>);
    p5.<span class="hljs-title function_">plane</span>(<span class="hljs-number">100</span>);
    p5.<span class="hljs-title function_">pop</span>();
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ReactP5Wrapper</span> <span class="hljs-attr">sketch</span>=<span class="hljs-string">{sketch}</span> /&gt;</span></span>;
}</code></pre>


But I would like my interface to be as follows

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-javascript">&lt;<span class="hljs-variable constant_">P5</span>
    height={<span class="hljs-title class_">Number</span>}
    width={<span class="hljs-title class_">Number</span>}
    renderer={<span class="hljs-title class_">String</span>} <span class="hljs-comment">// Enum: ["P2D", "WEBGL"]</span>
&gt;
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{}</span> <span class="hljs-attr">arg1</span>=<span class="hljs-string">{}</span> <span class="hljs-attr">arg2</span>=<span class="hljs-string">{}</span> /&gt;</span></span> <span class="hljs-comment">/* Deletes the canvas if the props change; arg1...argN are placeholder names and the components can take any name really. These are passed to the function as secondary arguments after p5. Canvas creation is done in a wrapper function that passes props to the fn

    &lt;P5.Draw fn={} arg1={} arg2={} /&gt; /* Draw function can be changed dynamically, and arg1...argN are placeholder names and the components can take any name really. These are passed to the function as secondary arguments after p5. */</span>
&lt;/<span class="hljs-variable constant_">P5</span>&gt;</code></pre>
Optionally, I think it could be cool to expose useP5 instead of passing P5 directly to the function, to respect React conventions

What I want from you is to review the design, and tell me its pros and cons. Then once we've honed in on a final interface, tell me how to implement it
</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Love this idea. You’re basically trying to make p5 feel <em>declarative</em> in React: the canvas becomes a controlled child of your component tree, <code>setup</code> is a “(re)create” boundary, and <code>draw</code> is hot-swappable.</p>
<p>Here’s a crisp review, a couple of small tweaks I’d recommend, and a full implementation you can drop in.</p>

<h1>Design review</h1>
<h2>What’s great</h2>
<ul>
<li>
<p><strong>Declarative canvas lifecycle.</strong> Tying canvas creation to <code>&lt;P5.Setup&gt;</code> props is a clean line in the sand: when those change, you want a fresh canvas (esp. renderer changes / initial state).</p>
</li>
<li>
<p><strong>Hot-swappable draw.</strong> Making <code>&lt;P5.Draw&gt;</code> update without tearing down the canvas fits how people experiment with p5.</p>
</li>
<li>
<p><strong>Arguments separate from p5.</strong> Passing “secondary args” keeps user code pure and testable.</p>
</li>
<li>
<p><strong>Optional hook.</strong> <code>useP5()</code> lets advanced users escape the DSL when needed.</p>
</li>
</ul>
<h2>Friction / tradeoffs</h2>
<ul>
<li>
<p><strong>Children-as-API complexity.</strong> It’s nice ergonomically, but you’ll need a small internal registry so <code>&lt;P5.Setup&gt;</code> and <code>&lt;P5.Draw&gt;</code> can talk to their parent.</p>
</li>
<li>
<p><strong>Canvas teardown flicker.</strong> Recreating the instance (required for renderer changes) will briefly blank the canvas. It’s usually fine; just manage cleanup carefully.</p>
</li>
<li>
<p><strong>p5 contract quirks.</strong> Calling <code>createCanvas</code> more than once on the same instance is dicey. Recreating the <strong>instance</strong> (not just the canvas) when “setup props” change is the safe path.</p>
</li>
<li>
<p><strong>Args as positional.</strong> Passing “arg1, arg2, …” as separate parameters makes typing and ref stability awkward. Passing a single <code>params</code> object is easier to type, memoize, and evolve.</p>
</li>
<li>
<p><strong>SSR.</strong> You’ll want to guard against server rendering (<code>window</code> / <code>document</code>).</p>
</li>
<li>
<p><strong>@p5-wrapper/react overlap.</strong> Since you need fine control over re-creation and dynamic <code>draw</code>, it’s simpler to manage the p5 instance yourself instead of going through <code>ReactP5Wrapper</code>.</p>
</li>
</ul>

<h1>Proposed API (very close to yours)</h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-tsx code-block hljs language-typescript" style="display: block;" data-highlighted="yes">&lt;<span class="hljs-variable constant_">P5</span> width={<span class="hljs-built_in">number</span>} height={<span class="hljs-built_in">number</span>} renderer=<span class="hljs-string">"P2D"</span> | <span class="hljs-string">"WEBGL"</span>&gt;
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> <span class="hljs-attr">params</span>) =&gt;</span> { /* one-time init */ }} params={{...}} /&gt;</span>
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>  <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> <span class="hljs-attr">params</span>) =&gt;</span> { /* runs every frame */ }} params={{...}} /&gt;</span>
&lt;/<span class="hljs-variable constant_">P5</span>&gt;
</code></pre>
<ul>
<li>
<p><code>renderer</code> defaults to <code>"P2D"</code>.</p>
</li>
<li>
<p>Changing <strong><code>width</code>, <code>height</code>, <code>renderer</code>, or <code>&lt;P5.Setup&gt;</code>’s <code>fn/params</code></strong> will <strong>recreate</strong> the p5 instance (clean tear-down + new canvas).</p>
</li>
<li>
<p>Changing <strong><code>&lt;P5.Draw&gt;</code>’s <code>fn/params</code></strong> will <strong>not</strong> recreate the instance; we just swap the callback.</p>
</li>
<li>
<p><code>useP5()</code> hook returns <code>{ p5, canvas, ready, size }</code>.</p>
</li>
</ul>
<p>If you really want positional args, you still can: treat <code>params</code> as an array and spread it when you call the user fn. Object is just nicer.</p>

<h1>Implementation (TypeScript, minimal &amp; robust)</h1>
<blockquote>
<p>This does <strong>not</strong> use <code>@p5-wrapper/react</code> so we can control lifecycle precisely.
If you must keep that dependency, I can show that variant too—but this is cleaner.</p>
</blockquote>
<pre class="overflow-visible!"><code class="whitespace-pre! language-tsx code-block hljs language-typescript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// P5.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  createContext,
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useRef,
  useState,
  <span class="hljs-title class_">PropsWithChildren</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> p5js <span class="hljs-keyword">from</span> <span class="hljs-string">"p5"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Renderer</span> = <span class="hljs-string">"P2D"</span> | <span class="hljs-string">"WEBGL"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">SetupFn</span>&lt;P = <span class="hljs-built_in">any</span>&gt; = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">p5</span>: p5js, <span class="hljs-attr">params</span>: P</span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DrawFn</span>&lt;P = <span class="hljs-built_in">any</span>&gt;  = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">p5</span>: p5js, <span class="hljs-attr">params</span>: P</span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">SetupProps</span>&lt;P = <span class="hljs-built_in">any</span>&gt; = {
  <span class="hljs-attr">fn</span>: <span class="hljs-title class_">SetupFn</span>&lt;P&gt;;
  params?: P;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">DrawProps</span>&lt;P = <span class="hljs-built_in">any</span>&gt; = {
  <span class="hljs-attr">fn</span>: <span class="hljs-title class_">DrawFn</span>&lt;P&gt;;
  params?: P;
};

<span class="hljs-keyword">type</span> P5RootProps = <span class="hljs-title class_">PropsWithChildren</span>&lt;{
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
  renderer?: <span class="hljs-title class_">Renderer</span>;
  className?: <span class="hljs-built_in">string</span>;
  style?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;
}&gt;;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CtxShape</span> = {
  <span class="hljs-comment">/** the live p5 instance (null until mounted) */</span>
  <span class="hljs-attr">p5Ref</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">MutableRefObject</span>&lt;p5js | <span class="hljs-literal">null</span>&gt;;
  <span class="hljs-comment">/** current canvas HTML element (p5 returns a p5.Element, we keep DOM node too) */</span>
  <span class="hljs-attr">canvasRef</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">MutableRefObject</span>&lt;<span class="hljs-title class_">HTMLCanvasElement</span> | <span class="hljs-literal">null</span>&gt;;
  <span class="hljs-comment">/** called by &lt;P5.Draw&gt; to set the draw function (hot-swappable) */</span>
  <span class="hljs-attr">setDraw</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">fn</span>: <span class="hljs-title class_">DrawFn</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** called by &lt;P5.Setup&gt; to register desired setup + params */</span>
  <span class="hljs-attr">setSetupSpec</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">spec</span>: { fn: SetupFn&lt;<span class="hljs-built_in">any</span>&gt;; params: <span class="hljs-built_in">any</span> }</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** bump the instance key to force a full re-creation (used when setup spec changes) */</span>
  <span class="hljs-attr">recreate</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">ready</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">size</span>: { <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> };
};

<span class="hljs-keyword">const</span> P5Context = createContext&lt;<span class="hljs-title class_">CtxShape</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">rendererConst</span>(<span class="hljs-params"><span class="hljs-attr">p5</span>: p5js, renderer?: <span class="hljs-title class_">Renderer</span></span>) {
  <span class="hljs-keyword">if</span> (renderer === <span class="hljs-string">"WEBGL"</span>) <span class="hljs-keyword">return</span> p5.<span class="hljs-property">WEBGL</span>;
  <span class="hljs-keyword">return</span> p5.<span class="hljs-property">P2D</span>; <span class="hljs-comment">// default</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">P5</span>(<span class="hljs-params"><span class="hljs-attr">props</span>: P5RootProps</span>) {
  <span class="hljs-keyword">const</span> { width, height, renderer = <span class="hljs-string">"P2D"</span>, className, style, children } = props;
  <span class="hljs-keyword">const</span> hostRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> p5Ref = useRef&lt;p5js | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> canvasRef = useRef&lt;<span class="hljs-title class_">HTMLCanvasElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// store the current setup+params desired by &lt;P5.Setup&gt;</span>
  <span class="hljs-keyword">const</span> setupSpecRef = useRef&lt;{ <span class="hljs-attr">fn</span>: <span class="hljs-title class_">SetupFn</span>&lt;<span class="hljs-built_in">any</span>&gt;; <span class="hljs-attr">params</span>: <span class="hljs-built_in">any</span> } | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// store the current draw+params desired by &lt;P5.Draw&gt;</span>
  <span class="hljs-keyword">const</span> drawSpecRef = useRef&lt;{ <span class="hljs-attr">fn</span>: <span class="hljs-title class_">DrawFn</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-literal">null</span>; <span class="hljs-attr">params</span>: <span class="hljs-built_in">any</span> }&gt;({
    <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span>,
  });

  <span class="hljs-keyword">const</span> [ready, setReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [instanceKey, setInstanceKey] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> recreate = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setInstanceKey</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> k + <span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">const</span> setDraw = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">fn</span>: <span class="hljs-title class_">DrawFn</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    drawSpecRef.<span class="hljs-property">current</span> = { fn, params };
    <span class="hljs-comment">// if instance exists, swap immediately</span>
    <span class="hljs-keyword">const</span> inst = p5Ref.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (inst) {
      <span class="hljs-keyword">if</span> (fn) {
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(inst, drawSpecRef.<span class="hljs-property">current</span>.<span class="hljs-property">params</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// pause draw loop</span>
        inst.<span class="hljs-title function_">noLoop</span>();
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
      }
      <span class="hljs-keyword">if</span> (fn) inst.<span class="hljs-title function_">loop</span>();
    }
  }, []);

  <span class="hljs-keyword">const</span> setSetupSpec = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">spec</span>: { fn: SetupFn&lt;<span class="hljs-built_in">any</span>&gt;; params: <span class="hljs-built_in">any</span> }</span>) =&gt;</span> {
    setupSpecRef.<span class="hljs-property">current</span> = spec;
  }, []);

  <span class="hljs-comment">// Create p5 instance (or recreate) when key/size/renderer changes</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!hostRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">let</span> destroyed = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sketch</span> = (<span class="hljs-params"><span class="hljs-attr">p</span>: p5js</span>) =&gt; {
      <span class="hljs-comment">// save instance early</span>
      p5Ref.<span class="hljs-property">current</span> = p;

      p.<span class="hljs-property">setup</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// create canvas</span>
        <span class="hljs-keyword">const</span> cnv = p.<span class="hljs-title function_">createCanvas</span>(width, height, <span class="hljs-title function_">rendererConst</span>(p, renderer));
        <span class="hljs-comment">// get DOM node for convenience</span>
        canvasRef.<span class="hljs-property">current</span> = cnv.<span class="hljs-property">elt</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLCanvasElement</span>;

        <span class="hljs-comment">// perform user setup if provided</span>
        <span class="hljs-keyword">const</span> spec = setupSpecRef.<span class="hljs-property">current</span>;
        <span class="hljs-keyword">if</span> (spec?.<span class="hljs-property">fn</span>) {
          <span class="hljs-comment">// allow async setup, but draw will start anyway unless user stops it inside setup</span>
          <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(spec.<span class="hljs-title function_">fn</span>(p, spec.<span class="hljs-property">params</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
        }

        <span class="hljs-comment">// initial draw binding</span>
        <span class="hljs-keyword">const</span> d = drawSpecRef.<span class="hljs-property">current</span>;
        <span class="hljs-keyword">if</span> (d.<span class="hljs-property">fn</span>) {
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> d.<span class="hljs-property">fn</span>!(p, d.<span class="hljs-property">params</span>);
          p.<span class="hljs-title function_">loop</span>();
        } <span class="hljs-keyword">else</span> {
          p.<span class="hljs-title function_">noLoop</span>();
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
        }

        <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">true</span>);
      };
    };

    <span class="hljs-comment">// instantiate into host</span>
    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title function_">p5js</span>(sketch, hostRef.<span class="hljs-property">current</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      destroyed = <span class="hljs-literal">true</span>;
      <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">false</span>);
      <span class="hljs-keyword">try</span> {
        inst.<span class="hljs-title function_">remove</span>(); <span class="hljs-comment">// this cleans DOM + event handlers</span>
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// ignore</span>
      }
      <span class="hljs-keyword">if</span> (p5Ref.<span class="hljs-property">current</span> === inst) p5Ref.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      canvasRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [instanceKey, width, height, renderer]);

  <span class="hljs-keyword">const</span> ctxValue = useMemo&lt;<span class="hljs-title class_">CtxShape</span>&gt;(
    <span class="hljs-function">() =&gt;</span> ({
      p5Ref,
      canvasRef,
      setDraw,
      setSetupSpec,
      recreate,
      ready,
      <span class="hljs-attr">size</span>: { width, height },
    }),
    [recreate, setDraw, setSetupSpec, ready, width, height]
  );

  <span class="hljs-comment">// Recreate instance if the root size/renderer change (that’s the intent of your API)</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// changing these should trigger a full recreate</span>
    <span class="hljs-title function_">recreate</span>();
    <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> this effect runs once on mount as well; that’s fine</span>
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [width, height, renderer]);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{ctxValue}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{hostRef}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>
        <span class="hljs-attr">suppressHydrationWarning</span>
      /&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5Context.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// --- Child components --------------------------------------------------------</span>

<span class="hljs-variable constant_">P5</span>.<span class="hljs-property">Setup</span> = <span class="hljs-keyword">function</span> P5Setup&lt;P = <span class="hljs-built_in">any</span>&gt;({ fn, params }: <span class="hljs-title class_">SetupProps</span>&lt;P&gt;) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(P5Context);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Setup&gt; must be used inside &lt;P5&gt;."</span>);

  <span class="hljs-comment">// register the desired setup spec</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setSetupSpec</span>({ fn, params });
    <span class="hljs-comment">// recreate instance on any change to setup fn/params</span>
    ctx.<span class="hljs-title function_">recreate</span>();
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-variable constant_">P5</span>.<span class="hljs-property">Draw</span> = <span class="hljs-keyword">function</span> P5Draw&lt;P = <span class="hljs-built_in">any</span>&gt;({ fn, params }: <span class="hljs-title class_">DrawProps</span>&lt;P&gt;) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(P5Context);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Draw&gt; must be used inside &lt;P5&gt;."</span>);

  <span class="hljs-comment">// hot-swap draw on change</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setDraw</span>(fn, params);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// if this component unmounts and it's the active drawer, pause</span>
      ctx.<span class="hljs-title function_">setDraw</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>);
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">// --- Hook --------------------------------------------------------------------</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(P5Context);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5 must be used inside &lt;P5&gt;."</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">p5</span>: ctx.<span class="hljs-property">p5Ref</span>.<span class="hljs-property">current</span>,
    <span class="hljs-attr">canvas</span>: ctx.<span class="hljs-property">canvasRef</span>.<span class="hljs-property">current</span>,
    <span class="hljs-attr">ready</span>: ctx.<span class="hljs-property">ready</span>,
    <span class="hljs-attr">size</span>: ctx.<span class="hljs-property">size</span>,
  };
}
</code></pre>
<h2>Usage examples</h2>
<h3>1) Simple WEBGL plane (close to your original)</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-tsx code-block hljs language-typescript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span>
        <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5)</span> =&gt;</span> {
          // anything one-time (lights, textures, etc.)
        }}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
        <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5)</span> =&gt;</span> {
          p5.background(250);
          p5.normalMaterial();
          p5.push();
          p5.rotateZ(p5.frameCount * 0.01);
          p5.rotateX(p5.frameCount * 0.01);
          p5.rotateY(p5.frameCount * 0.01);
          p5.plane(100);
          p5.pop();
        }}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5</span>&gt;</span></span>
  );
}
</code></pre>
<h3>2) Dynamic arguments without tearing the canvas</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-tsx code-block hljs language-typescript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SpinningShape</span>(<span class="hljs-params">{ speed = <span class="hljs-number">0.01</span>, size = <span class="hljs-number">100</span> }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
        <span class="hljs-attr">params</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">speed</span>, <span class="hljs-attr">size</span> }}
        <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> { <span class="hljs-attr">speed</span>, <span class="hljs-attr">size</span> }) =&gt;</span> {
          p5.background(240);
          p5.normalMaterial();
          p5.push();
          p5.rotateZ(p5.frameCount * speed);
          p5.rotateX(p5.frameCount * speed);
          p5.rotateY(p5.frameCount * speed);
          p5.box(size);
          p5.pop();
        }}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5</span>&gt;</span></span>
  );
}
</code></pre>
<h3>3) Using the hook</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-tsx code-block hljs language-typescript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SnapshotButton</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { p5, canvas, ready } = <span class="hljs-title function_">useP5</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">save</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">if</span> (!ready || !p5) <span class="hljs-keyword">return</span>;
    p5.<span class="hljs-title function_">saveCanvas</span>(canvas!, <span class="hljs-string">"frame"</span>, <span class="hljs-string">"png"</span>);
  };

  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{save}</span>&gt;</span>Save PNG<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<p>Mount both inside the same <code>&lt;P5&gt;</code> to share the instance.</p>

<h1>Notes &amp; pitfalls</h1>
<ul>
<li>
<p><strong>StrictMode double mount:</strong> React 18 might create/destroy your p5 instance twice in dev. We tear down via <code>inst.remove()</code> so you won’t leak handlers. If you see duplicate canvases in dev only, that’s why.</p>
</li>
<li>
<p><strong>Resizing:</strong> Changing <code>width</code>/<code>height</code> currently <strong>recreates</strong> the instance (your stated intent). If you’d rather avoid flicker for size-only changes, detect size changes and call <code>p5.resizeCanvas(width, height)</code> instead of <code>recreate()</code>.</p>
</li>
<li>
<p><strong>Renderer changes:</strong> Must recreate the instance; WEBGL ↔ P2D isn’t switchable at runtime.</p>
</li>
<li>
<p><strong>Perf:</strong> Keep your <code>fn</code> props stable with <code>useCallback</code> if parent re-renders a lot. Params as an object are memo-friendly.</p>
</li>
<li>
<p><strong>Async setup:</strong> Allowed—just keep in mind <code>draw</code> starts right away; if you need to block drawing until something loads, call <code>p5.noLoop()</code> in setup and <code>p5.loop()</code> when ready.</p>
</li>
</ul>

<h1>Want it on top of <code>@p5-wrapper/react</code>?</h1>
<p>Totally doable: you’d pass a stable <code>sketch</code> and use <code>updateWithProps</code> to hot-swap <code>draw</code> and to trigger rebuilds. The direct approach above is smaller and gives you full control, but if you prefer the wrapper, say the word and I’ll show that version too.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">I use JS, not TS; can you rewrite in JS?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Absolutely—here’s a straight JavaScript version (no TypeScript), matching the API we discussed. Drop this in <code>P5.jsx</code>.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// P5.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  createContext,
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useRef,
  useState,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> p5js <span class="hljs-keyword">from</span> <span class="hljs-string">"p5"</span>;

<span class="hljs-keyword">const</span> P5Context = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">rendererConst</span>(<span class="hljs-params">p5, renderer</span>) {
  <span class="hljs-keyword">return</span> renderer === <span class="hljs-string">"WEBGL"</span> ? p5.<span class="hljs-property">WEBGL</span> : p5.<span class="hljs-property">P2D</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">P5</span>(<span class="hljs-params">{ width, height, renderer = <span class="hljs-string">"P2D"</span>, className, style, children }</span>) {
  <span class="hljs-keyword">const</span> hostRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> p5Ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> canvasRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// current desired setup/draw specs (set by child components)</span>
  <span class="hljs-keyword">const</span> setupSpecRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> drawSpecRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });

  <span class="hljs-keyword">const</span> [ready, setReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [instanceKey, setInstanceKey] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> recreate = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setInstanceKey</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> k + <span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">const</span> setDraw = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">fn, params</span>) =&gt;</span> {
    drawSpecRef.<span class="hljs-property">current</span> = { fn, params };
    <span class="hljs-keyword">const</span> inst = p5Ref.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (inst) {
      <span class="hljs-keyword">if</span> (fn) {
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(inst, drawSpecRef.<span class="hljs-property">current</span>.<span class="hljs-property">params</span>);
        inst.<span class="hljs-title function_">loop</span>();
      } <span class="hljs-keyword">else</span> {
        inst.<span class="hljs-title function_">noLoop</span>();
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
      }
    }
  }, []);

  <span class="hljs-keyword">const</span> setSetupSpec = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">spec</span>) =&gt;</span> {
    setupSpecRef.<span class="hljs-property">current</span> = spec;
  }, []);

  <span class="hljs-comment">// Create / recreate p5 instance when key/size/renderer change</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!hostRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sketch</span> = (<span class="hljs-params">p</span>) =&gt; {
      p5Ref.<span class="hljs-property">current</span> = p;

      p.<span class="hljs-property">setup</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> cnv = p.<span class="hljs-title function_">createCanvas</span>(width, height, <span class="hljs-title function_">rendererConst</span>(p, renderer));
        canvasRef.<span class="hljs-property">current</span> = cnv.<span class="hljs-property">elt</span>;

        <span class="hljs-keyword">const</span> spec = setupSpecRef.<span class="hljs-property">current</span>;
        <span class="hljs-keyword">if</span> (spec &amp;&amp; spec.<span class="hljs-property">fn</span>) {
          <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(spec.<span class="hljs-title function_">fn</span>(p, spec.<span class="hljs-property">params</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
        }

        <span class="hljs-keyword">const</span> d = drawSpecRef.<span class="hljs-property">current</span>;
        <span class="hljs-keyword">if</span> (d.<span class="hljs-property">fn</span>) {
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> d.<span class="hljs-title function_">fn</span>(p, d.<span class="hljs-property">params</span>);
          p.<span class="hljs-title function_">loop</span>();
        } <span class="hljs-keyword">else</span> {
          p.<span class="hljs-title function_">noLoop</span>();
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
        }

        <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">true</span>);
      };
    };

    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title function_">p5js</span>(sketch, hostRef.<span class="hljs-property">current</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">false</span>);
      <span class="hljs-keyword">try</span> {
        inst.<span class="hljs-title function_">remove</span>();
      } <span class="hljs-keyword">catch</span> (_) {}
      <span class="hljs-keyword">if</span> (p5Ref.<span class="hljs-property">current</span> === inst) p5Ref.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      canvasRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [instanceKey, width, height, renderer]);

  <span class="hljs-comment">// Recreate when root props change (your chosen contract)</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">recreate</span>();
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [width, height, renderer]);

  <span class="hljs-keyword">const</span> ctxValue = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> ({
      p5Ref,
      canvasRef,
      setDraw,
      setSetupSpec,
      recreate,
      ready,
      <span class="hljs-attr">size</span>: { width, height },
    }),
    [setDraw, setSetupSpec, recreate, ready, width, height]
  );

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{ctxValue}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{hostRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> <span class="hljs-attr">suppressHydrationWarning</span> /&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5Context.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// --- Child components --------------------------------------------------------</span>

<span class="hljs-variable constant_">P5</span>.<span class="hljs-property">Setup</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">P5Setup</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(P5Context);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Setup&gt; must be used inside &lt;P5&gt;."</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setSetupSpec</span>({ fn, params });
    ctx.<span class="hljs-title function_">recreate</span>(); <span class="hljs-comment">// change in setup =&gt; rebuild instance</span>
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-variable constant_">P5</span>.<span class="hljs-property">Draw</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">P5Draw</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(P5Context);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Draw&gt; must be used inside &lt;P5&gt;."</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setDraw</span>(fn, params);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> ctx.<span class="hljs-title function_">setDraw</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>);
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">// --- Hook --------------------------------------------------------------------</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(P5Context);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5 must be used inside &lt;P5&gt;."</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">p5</span>: ctx.<span class="hljs-property">p5Ref</span>.<span class="hljs-property">current</span>,
    <span class="hljs-attr">canvas</span>: ctx.<span class="hljs-property">canvasRef</span>.<span class="hljs-property">current</span>,
    <span class="hljs-attr">ready</span>: ctx.<span class="hljs-property">ready</span>,
    <span class="hljs-attr">size</span>: ctx.<span class="hljs-property">size</span>,
  };
}
</code></pre>
<h2>Usage examples</h2>
<h3>1) Close to your original WEBGL demo</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./P5"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
        <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5)</span> =&gt;</span> {
          p5.background(250);
          p5.normalMaterial();
          p5.push();
          p5.rotateZ(p5.frameCount * 0.01);
          p5.rotateX(p5.frameCount * 0.01);
          p5.rotateY(p5.frameCount * 0.01);
          p5.plane(100);
          p5.pop();
        }}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5</span>&gt;</span></span>
  );
}
</code></pre>
<h3>2) Live params without tearing down the canvas</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SpinningBox</span>(<span class="hljs-params">{ speed = <span class="hljs-number">0.01</span>, size = <span class="hljs-number">100</span> }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
        <span class="hljs-attr">params</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">speed</span>, <span class="hljs-attr">size</span> }}
        <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> { <span class="hljs-attr">speed</span>, <span class="hljs-attr">size</span> }) =&gt;</span> {
          p5.background(240);
          p5.normalMaterial();
          p5.push();
          p5.rotateZ(p5.frameCount * speed);
          p5.rotateX(p5.frameCount * speed);
          p5.rotateY(p5.frameCount * speed);
          p5.box(size);
          p5.pop();
        }}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5</span>&gt;</span></span>
  );
}
</code></pre>
<h3>3) Using the hook</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { useP5 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./P5"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { p5, canvas, ready } = <span class="hljs-title function_">useP5</span>();
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
        if (ready &amp;&amp; p5 &amp;&amp; canvas) p5.saveCanvas(canvas, "frame", "png");
      }}
    &gt;
      Save PNG
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<h3>Notes</h3>
<ul>
<li>
<p>In React 18 dev, StrictMode mounts/unmounts once extra; we call <code>inst.remove()</code> so you won’t leak canvases.</p>
</li>
<li>
<p>Resizing: by design, changing <code>width</code>/<code>height</code>/<code>renderer</code> rebuilds the instance. If you’d rather avoid flicker for size-only changes, I can show a resize-only variant that calls <code>p5.resizeCanvas</code> instead of <code>recreate()</code>.</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Dude, that's pretty fantastic! I love the fact that p5 can be used outside of the draw function to add to onClick events. That's pretty dope</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Exactly 😄 — that’s one of the coolest parts of treating the p5 instance as a proper React context.</p>
<p>Since <code>useP5()</code> just hands you the live instance + canvas reference, you can hook into <em>any</em> DOM event or React interaction and still use p5 API calls there:</p>
<ul>
<li>
<p>Save/export buttons (<code>p5.saveCanvas</code>, <code>p5.saveFrames</code>)</p>
</li>
<li>
<p>Custom UI toggles (switch shaders, swap draw functions, change blend modes)</p>
</li>
<li>
<p>Mouse/keyboard events controlled from React UI instead of relying on p5’s global event loop</p>
</li>
<li>
<p>Integrations with other libs (e.g. feeding data from D3 or Three.js back into your p5 canvas)</p>
</li>
</ul>
<p>So instead of the classic “everything must live in <code>draw</code>”, you can think of <code>draw</code> as just <em>one consumer</em> of the p5 instance. React owns the orchestration, p5 is just a rendering engine.</p>
<p>👉 Do you want me to show you an example where you combine <strong>React state</strong> + <strong>button click</strong> + <strong>p5 draw</strong> so that you can toggle shapes or colors from your UI? That’s usually the “aha!” moment with this pattern.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, let's rename P5 as P5.ContextProvider, and have a new component, P5.Canvas that takes the height, width, renderer, etc props and renders the Canvas. That way we can:
1. Use P5ContextProvider more as a global provider rather than an element (that way we can have buttons or other React components within the context provider and it won't look weird)
2. directly target the component with css classes or emotion/styled css, and possibly even through js.

Is that a good idea?2/2</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Short answer: yes—splitting into a <strong>global provider</strong> + a <strong>canvas host</strong> is a good idea. It gives you cleaner layout/styling control, makes the context feel “React-y,” and keeps your buttons/UI siblings of the canvas instead of children of a canvas element.</p>
<h2>Pros</h2>
<ul>
<li>
<p><strong>Cleaner layout &amp; styling:</strong> <code>&lt;P5.Canvas&gt;</code> is a normal DOM node you can target with className/emotion/styled. The provider renders nothing by itself.</p>
</li>
<li>
<p><strong>Composability:</strong> Put any React UI anywhere under the provider and still access <code>useP5()</code>.</p>
</li>
<li>
<p><strong>Clear ownership:</strong> The canvas lifecycle belongs to <code>&lt;P5.Canvas&gt;</code>; setup/draw can live anywhere under the provider.</p>
</li>
<li>
<p><strong>Future-proof:</strong> If you later want multiple controls panels around one canvas, you don’t have to nest them awkwardly.</p>
</li>
</ul>
<h2>Cons / gotchas</h2>
<ul>
<li>
<p><strong>One canvas per provider (for now):</strong> Easiest to implement and reason about. If you ever want multiple canvases, you’ll likely want <strong>one provider per canvas</strong> or a provider that manages an ID-keyed registry of canvases.</p>
</li>
<li>
<p><strong>Mount order:</strong> <code>&lt;P5.Setup&gt;</code> / <code>&lt;P5.Draw&gt;</code> might mount before <code>&lt;P5.Canvas&gt;</code>. You need to buffer their specs and apply them when the canvas mounts. (Handled below.)</p>
</li>
<li>
<p><strong>No-op provider:</strong> If you render the provider without a <code>&lt;P5.Canvas&gt;</code>, nothing happens—fine, but worth noting.</p>
</li>
</ul>

<h2>Drop-in JS implementation</h2>
<p>Usage:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes">&lt;<span class="hljs-variable constant_">P5</span>.<span class="hljs-property">ContextProvider</span>&gt;
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"toolbar"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SaveButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SpeedSlider</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"myCanvas"</span> /&gt;</span></span>

  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5)</span> =&gt;</span> { /* one-time init */ }} /&gt;</span>
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
    <span class="hljs-attr">params</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">speed:</span> <span class="hljs-attr">0.01</span>, <span class="hljs-attr">size:</span> <span class="hljs-attr">100</span> }}
    <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> { <span class="hljs-attr">speed</span>, <span class="hljs-attr">size</span> }) =&gt;</span> {
      p5.background(240);
      p5.normalMaterial();
      p5.push();
      p5.rotateZ(p5.frameCount * speed);
      p5.rotateX(p5.frameCount * speed);
      p5.rotateY(p5.frameCount * speed);
      p5.box(size);
      p5.pop();
    }}
  /&gt;</span>
&lt;/<span class="hljs-variable constant_">P5</span>.<span class="hljs-property">ContextProvider</span>&gt;
</code></pre>
<h3><code>P5.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// P5.jsx (JavaScript)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  createContext,
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useRef,
  useState,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> p5js <span class="hljs-keyword">from</span> <span class="hljs-string">"p5"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Ctx</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// Helpers</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rendererConst</span>(<span class="hljs-params">p5, renderer</span>) {
  <span class="hljs-keyword">return</span> renderer === <span class="hljs-string">"WEBGL"</span> ? p5.<span class="hljs-property">WEBGL</span> : p5.<span class="hljs-property">P2D</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeP5Sketch</span>(<span class="hljs-params">env</span>) {
  <span class="hljs-comment">// env: { width, height, renderer, applySetup, applyDraw, onReady }</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sketch</span>(<span class="hljs-params">p</span>) {
    env.<span class="hljs-property">p5Ref</span>.<span class="hljs-property">current</span> = p;

    p.<span class="hljs-property">setup</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> cnv = p.<span class="hljs-title function_">createCanvas</span>(env.<span class="hljs-property">width</span>, env.<span class="hljs-property">height</span>, <span class="hljs-title function_">rendererConst</span>(p, env.<span class="hljs-property">renderer</span>));
      env.<span class="hljs-property">canvasRef</span>.<span class="hljs-property">current</span> = cnv.<span class="hljs-property">elt</span>;

      env.<span class="hljs-title function_">applySetup</span>(p); <span class="hljs-comment">// runs user setup (possibly async)</span>
      env.<span class="hljs-title function_">applyDraw</span>(p);  <span class="hljs-comment">// binds current draw (or disables)</span>

      env.<span class="hljs-title function_">onReady</span>(<span class="hljs-literal">true</span>);
    };
  };
}

<span class="hljs-comment">// Provider (renders nothing; owns p5 instance)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ContextProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> p5Ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> canvasRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// Canvas host + config (set by &lt;P5.Canvas&gt;)</span>
  <span class="hljs-keyword">const</span> hostRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> canvasCfgRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">renderer</span>: <span class="hljs-string">"P2D"</span> });

  <span class="hljs-keyword">const</span> [ready, setReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [instanceKey, setInstanceKey] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [hasCanvas, setHasCanvas] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// Buffered specs (set by &lt;P5.Setup&gt;/&lt;P5.Draw&gt;)</span>
  <span class="hljs-keyword">const</span> setupSpecRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });
  <span class="hljs-keyword">const</span> drawSpecRef  = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });

  <span class="hljs-keyword">const</span> recreate = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setInstanceKey</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> k + <span class="hljs-number">1</span>), []);

  <span class="hljs-keyword">const</span> setCanvasHostAndConfig = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">host, cfg</span>) =&gt;</span> {
    hostRef.<span class="hljs-property">current</span> = host;
    canvasCfgRef.<span class="hljs-property">current</span> = cfg;
    <span class="hljs-title function_">setHasCanvas</span>(!!host);
    <span class="hljs-comment">// Create/recreate when host first mounts or cfg changes</span>
    <span class="hljs-title function_">recreate</span>();
  }, [recreate]);

  <span class="hljs-keyword">const</span> applySetup = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> spec = setupSpecRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (spec.<span class="hljs-property">fn</span>) <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(spec.<span class="hljs-title function_">fn</span>(p, spec.<span class="hljs-property">params</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
  }, []);

  <span class="hljs-keyword">const</span> applyDraw = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> d = drawSpecRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (d.<span class="hljs-property">fn</span>) {
      p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> d.<span class="hljs-title function_">fn</span>(p, d.<span class="hljs-property">params</span>);
      p.<span class="hljs-title function_">loop</span>();
    } <span class="hljs-keyword">else</span> {
      p.<span class="hljs-title function_">noLoop</span>();
      p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
    }
  }, []);

  <span class="hljs-keyword">const</span> setSetupSpec = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">spec</span>) =&gt;</span> {
    setupSpecRef.<span class="hljs-property">current</span> = spec || { <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> };
    <span class="hljs-comment">// By your contract, changing setup -&gt; full recreate</span>
    <span class="hljs-keyword">if</span> (hasCanvas) <span class="hljs-title function_">recreate</span>();
  }, [hasCanvas, recreate]);

  <span class="hljs-keyword">const</span> setDraw = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">fn, params</span>) =&gt;</span> {
    drawSpecRef.<span class="hljs-property">current</span> = { fn, params };
    <span class="hljs-keyword">const</span> inst = p5Ref.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (inst) {
      <span class="hljs-keyword">if</span> (fn) {
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(inst, drawSpecRef.<span class="hljs-property">current</span>.<span class="hljs-property">params</span>);
        inst.<span class="hljs-title function_">loop</span>();
      } <span class="hljs-keyword">else</span> {
        inst.<span class="hljs-title function_">noLoop</span>();
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
      }
    }
  }, []);

  <span class="hljs-comment">// Create / recreate p5 instance when host/config/instanceKey change</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> host = hostRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!host) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> { width, height, renderer } = canvasCfgRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> env = {
      width, height, renderer,
      p5Ref, canvasRef,
      applySetup, applyDraw,
      <span class="hljs-attr">onReady</span>: setReady,
    };

    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title function_">p5js</span>(<span class="hljs-title function_">makeP5Sketch</span>(env), host);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">false</span>);
      <span class="hljs-keyword">try</span> { inst.<span class="hljs-title function_">remove</span>(); } <span class="hljs-keyword">catch</span> (_) {}
      <span class="hljs-keyword">if</span> (p5Ref.<span class="hljs-property">current</span> === inst) p5Ref.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      canvasRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [instanceKey]);

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-comment">// exposed</span>
    p5Ref,
    canvasRef,
    ready,
    <span class="hljs-attr">size</span>: { <span class="hljs-attr">width</span>: canvasCfgRef.<span class="hljs-property">current</span>.<span class="hljs-property">width</span>, <span class="hljs-attr">height</span>: canvasCfgRef.<span class="hljs-property">current</span>.<span class="hljs-property">height</span> },

    <span class="hljs-comment">// canvas host/config control</span>
    setCanvasHostAndConfig,

    <span class="hljs-comment">// user APIs</span>
    setSetupSpec,
    setDraw,
    recreate,
  }), [ready, setSetupSpec, setDraw, recreate]);

  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Ctx.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Ctx.Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// Canvas host (creates the actual canvas under this div)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Canvas</span>(<span class="hljs-params">{ width, height, renderer = <span class="hljs-string">"P2D"</span>, className, style }</span>) {
  <span class="hljs-keyword">const</span> hostDivRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Ctx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Canvas&gt; must be used inside &lt;P5.ContextProvider&gt;."</span>);

  <span class="hljs-comment">// inform provider about host + cfg</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!hostDivRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
    ctx.<span class="hljs-title function_">setCanvasHostAndConfig</span>(hostDivRef.<span class="hljs-property">current</span>, { width, height, renderer });
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// on unmount, remove host</span>
      ctx.<span class="hljs-title function_">setCanvasHostAndConfig</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">renderer</span>: <span class="hljs-string">"P2D"</span> });
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [width, height, renderer]);

  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{hostDivRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> <span class="hljs-attr">suppressHydrationWarning</span> /&gt;</span></span>;
}

<span class="hljs-comment">// Setup + Draw remain as before, now they just need the provider present</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Setup</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Ctx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Setup&gt; must be used inside &lt;P5.ContextProvider&gt;."</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setSetupSpec</span>({ fn, params });
    <span class="hljs-comment">// full recreate per contract</span>
    ctx.<span class="hljs-title function_">recreate</span>();
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Ctx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Draw&gt; must be used inside &lt;P5.ContextProvider&gt;."</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setDraw</span>(fn, params);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> ctx.<span class="hljs-title function_">setDraw</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>);
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Ctx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5 must be used inside &lt;P5.ContextProvider&gt;."</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">p5</span>: ctx.<span class="hljs-property">p5Ref</span>.<span class="hljs-property">current</span>,
    <span class="hljs-attr">canvas</span>: ctx.<span class="hljs-property">canvasRef</span>.<span class="hljs-property">current</span>,
    <span class="hljs-attr">ready</span>: ctx.<span class="hljs-property">ready</span>,
    <span class="hljs-attr">size</span>: ctx.<span class="hljs-property">size</span>,
  };
}

<span class="hljs-comment">// Namespace export for the API shape you want</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">P5</span> = {
  <span class="hljs-title class_">ContextProvider</span>,
  <span class="hljs-title class_">Canvas</span>,
  <span class="hljs-title class_">Setup</span>,
  <span class="hljs-title class_">Draw</span>,
};
</code></pre>
<h3>Notes / options</h3>
<ul>
<li>
<p><strong>Resize without flicker:</strong> If you want <code>width/height</code> changes to call <code>p5.resizeCanvas()</code> instead of full recreate, detect size-only changes inside <code>Canvas</code> and call a new context method like <code>resizeCanvas(width, height)</code>. Keep full recreate for <code>renderer</code> changes and <code>Setup</code> changes.</p>
</li>
<li>
<p><strong>Multiple canvases:</strong> Easiest path is “one provider per canvas.” If you need one provider → multiple canvases, you’ll want to add an ID prop to <code>&lt;P5.Canvas id="foo" /&gt;</code> and make all context methods take that ID (registry of instances).</p>
</li>
<li>
<p><strong>StrictMode:</strong> Dev double-mount is handled via <code>inst.remove()</code> in cleanup.</p>
</li>
</ul>
<p>If you want the <strong>resize-only</strong> variant or <strong>multi-canvas registry</strong> next, say the word and I’ll adapt this scaffold.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">OK, let's update this to have multi-instance support out of the box.
We'll embed the Setup and Draw function within the Canvas component directly:

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-handlebars"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"toolbar"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SaveButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SpeedSlider</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"myCanvas"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5)</span> =&gt;</span> { /* one-time init */ }} /&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
      <span class="hljs-attr">params</span>=</span></span><span class="hljs-template-variable">{{ <span class="hljs-name">speed:</span> <span class="hljs-number">0.01</span>, size: <span class="hljs-number">100</span> }}</span><span class="language-xml"><span class="hljs-tag">
      <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> { <span class="hljs-attr">speed</span>, <span class="hljs-attr">size</span> }) =&gt;</span> {
        p5.background(240);
        p5.normalMaterial();
        p5.push();
        p5.rotateZ(p5.frameCount * speed);
        p5.rotateX(p5.frameCount * speed);
        p5.rotateY(p5.frameCount * speed);
        p5.box(size);
        p5.pop();
      }}
    /&gt;
  <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span></code></pre>

And have P5.Canvas register their instances automatically
</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Heck yes—let’s make it multi-instance and nest <code>Setup/Draw</code> <em>inside</em> each <code>Canvas</code>. We’ll also keep a <strong>global provider</strong> so any UI (toolbars, buttons, sliders) anywhere under it can talk to a specific canvas via <code>useP5(id)</code>.</p>
<p>Below is a complete <strong>JavaScript</strong> (no TS) drop-in you can paste into <code>P5.jsx</code>.</p>
<h2>What you get</h2>
<ul>
<li>
<p><code>&lt;P5.ContextProvider&gt;</code> manages a <strong>registry of canvases</strong> (many per provider).</p>
</li>
<li>
<p><code>&lt;P5.Canvas id="sceneA"&gt;…&lt;/P5.Canvas&gt;</code> owns one p5 instance and <strong>registers itself automatically</strong> with the provider.</p>
</li>
<li>
<p><code>&lt;P5.Setup/&gt;</code> and <code>&lt;P5.Draw/&gt;</code> are used <strong>as children of a specific Canvas</strong> (so they target that canvas only).</p>
</li>
<li>
<p><code>useP5(id?)</code> lets any component access a canvas by <code>id</code>. Omit <code>id</code> if there’s exactly one canvas.</p>
</li>
</ul>

<h3><code>P5.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// P5.jsx (multi-instance, JS)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  createContext,
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useRef,
  useState,
  <span class="hljs-title class_">Children</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> p5js <span class="hljs-keyword">from</span> <span class="hljs-string">"p5"</span>;

<span class="hljs-comment">// ---------- Provider (global registry of canvases) ----------</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RegistryCtx</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ContextProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-comment">// registry: id -&gt; { p5Ref, canvasRef, ready, size, setDraw, setSetup, recreate }</span>
  <span class="hljs-keyword">const</span> [registry, setRegistry] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());

  <span class="hljs-keyword">const</span> registerCanvas = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id, api</span>) =&gt;</span> {
    <span class="hljs-title function_">setRegistry</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      next.<span class="hljs-title function_">set</span>(id, api);
      <span class="hljs-keyword">return</span> next;
    });
  }, []);

  <span class="hljs-keyword">const</span> updateCanvas = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id, patch</span>) =&gt;</span> {
    <span class="hljs-title function_">setRegistry</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!prev.<span class="hljs-title function_">has</span>(id)) <span class="hljs-keyword">return</span> prev;
      <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      next.<span class="hljs-title function_">set</span>(id, { ...prev.<span class="hljs-title function_">get</span>(id), ...patch });
      <span class="hljs-keyword">return</span> next;
    });
  }, []);

  <span class="hljs-keyword">const</span> unregisterCanvas = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
    <span class="hljs-title function_">setRegistry</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!prev.<span class="hljs-title function_">has</span>(id)) <span class="hljs-keyword">return</span> prev;
      <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      next.<span class="hljs-title function_">delete</span>(id);
      <span class="hljs-keyword">return</span> next;
    });
  }, []);

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> ({ registry, registerCanvas, updateCanvas, unregisterCanvas }),
    [registry, registerCanvas, updateCanvas, unregisterCanvas]
  );

  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">RegistryCtx.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">RegistryCtx.Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// ---------- Canvas-scoped context (so Setup/Draw target their parent canvas) ----------</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CanvasCtx</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// Helpers</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rendererConst</span>(<span class="hljs-params">p5, renderer</span>) {
  <span class="hljs-keyword">return</span> renderer === <span class="hljs-string">"WEBGL"</span> ? p5.<span class="hljs-property">WEBGL</span> : p5.<span class="hljs-property">P2D</span>;
}

<span class="hljs-comment">// ---------- Canvas ----------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Canvas</span>(<span class="hljs-params">{ id, width, height, renderer = <span class="hljs-string">"P2D"</span>, className, style, children }</span>) {
  <span class="hljs-keyword">const</span> hostDivRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// per-instance refs/state</span>
  <span class="hljs-keyword">const</span> p5Ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> canvasRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> setupSpecRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });
  <span class="hljs-keyword">const</span> drawSpecRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });

  <span class="hljs-keyword">const</span> [ready, setReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [instanceKey, setInstanceKey] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> { registerCanvas, updateCanvas, unregisterCanvas } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>) || {};

  <span class="hljs-keyword">if</span> (!registerCanvas) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Canvas&gt; must be used inside &lt;P5.ContextProvider&gt;."</span>);
  }

  <span class="hljs-keyword">const</span> recreate = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setInstanceKey</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> k + <span class="hljs-number">1</span>), []);

  <span class="hljs-keyword">const</span> setSetupSpec = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">spec</span>) =&gt;</span> {
    setupSpecRef.<span class="hljs-property">current</span> = spec || { <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> };
    <span class="hljs-comment">// contract: changing setup =&gt; full recreate</span>
    <span class="hljs-title function_">recreate</span>();
  }, [recreate]);

  <span class="hljs-keyword">const</span> setDraw = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">fn, params</span>) =&gt;</span> {
    drawSpecRef.<span class="hljs-property">current</span> = { fn, params };
    <span class="hljs-keyword">const</span> inst = p5Ref.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (inst) {
      <span class="hljs-keyword">if</span> (fn) {
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(inst, drawSpecRef.<span class="hljs-property">current</span>.<span class="hljs-property">params</span>);
        inst.<span class="hljs-title function_">loop</span>();
      } <span class="hljs-keyword">else</span> {
        inst.<span class="hljs-title function_">noLoop</span>();
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
      }
    }
  }, []);

  <span class="hljs-comment">// Register with the global registry</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!id) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Canvas&gt; requires an 'id' prop for multi-instance support."</span>);
    <span class="hljs-comment">// initial</span>
    <span class="hljs-title function_">registerCanvas</span>(id, {
      p5Ref,
      canvasRef,
      <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">size</span>: { width, height },
      setDraw,
      setSetupSpec,
      recreate,
    });
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unregisterCanvas</span>(id);
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [id]);

  <span class="hljs-comment">// Keep size updated in registry</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">size</span>: { width, height } });
  }, [id, width, height, updateCanvas]);

  <span class="hljs-comment">// Create/recreate this p5 instance when instanceKey/size/renderer change</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> host = hostDivRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!host) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sketch</span> = (<span class="hljs-params">p</span>) =&gt; {
      p5Ref.<span class="hljs-property">current</span> = p;

      p.<span class="hljs-property">setup</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> cnv = p.<span class="hljs-title function_">createCanvas</span>(width, height, <span class="hljs-title function_">rendererConst</span>(p, renderer));
        canvasRef.<span class="hljs-property">current</span> = cnv.<span class="hljs-property">elt</span>;

        <span class="hljs-keyword">const</span> { <span class="hljs-attr">fn</span>: sfn, <span class="hljs-attr">params</span>: sparams } = setupSpecRef.<span class="hljs-property">current</span> || {};
        <span class="hljs-keyword">if</span> (sfn) <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">sfn</span>(p, sparams)).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);

        <span class="hljs-keyword">const</span> { <span class="hljs-attr">fn</span>: dfn, <span class="hljs-attr">params</span>: dparams } = drawSpecRef.<span class="hljs-property">current</span> || {};
        <span class="hljs-keyword">if</span> (dfn) {
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dfn</span>(p, dparams);
          p.<span class="hljs-title function_">loop</span>();
        } <span class="hljs-keyword">else</span> {
          p.<span class="hljs-title function_">noLoop</span>();
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
        }

        <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">ready</span>: <span class="hljs-literal">true</span> });
      };
    };

    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title function_">p5js</span>(sketch, host);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">false</span>);
      <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span> });
      <span class="hljs-keyword">try</span> { inst.<span class="hljs-title function_">remove</span>(); } <span class="hljs-keyword">catch</span> (_) {}
      <span class="hljs-keyword">if</span> (p5Ref.<span class="hljs-property">current</span> === inst) p5Ref.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      canvasRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [instanceKey, width, height, renderer]);

  <span class="hljs-comment">// By default, change in width/height/renderer =&gt; recreate</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">recreate</span>();
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [width, height, renderer]);

  <span class="hljs-keyword">const</span> canvasCtxValue = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> ({ id, setSetupSpec, setDraw, recreate }),
    [id, setSetupSpec, setDraw, recreate]
  );

  <span class="hljs-comment">// Only accept P5.Setup / P5.Draw as children; anything else is rendered as-is</span>
  <span class="hljs-keyword">const</span> renderedChildren = <span class="hljs-title class_">Children</span>.<span class="hljs-title function_">map</span>(children, <span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> child);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">CanvasCtx.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{canvasCtxValue}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{hostDivRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> <span class="hljs-attr">suppressHydrationWarning</span> /&gt;</span>
      {renderedChildren}
    <span class="hljs-tag">&lt;/<span class="hljs-name">CanvasCtx.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// ---------- Setup / Draw (must be inside a Canvas) ----------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Setup</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">CanvasCtx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Setup&gt; must be used inside &lt;P5.Canvas&gt;."</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setSetupSpec</span>({ fn, params });
    <span class="hljs-comment">// full recreate per contract happens in setSetupSpec -&gt; recreate()</span>
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">CanvasCtx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Draw&gt; must be used inside &lt;P5.Canvas&gt;."</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setDraw</span>(fn, params);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> ctx.<span class="hljs-title function_">setDraw</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>);
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// ---------- Hooks ----------</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> regCtx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>);
  <span class="hljs-keyword">if</span> (!regCtx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5 must be used inside &lt;P5.ContextProvider&gt;."</span>);

  <span class="hljs-keyword">const</span> { registry } = regCtx;

  <span class="hljs-comment">// Auto-pick if exactly one canvas registered</span>
  <span class="hljs-keyword">const</span> entry =
    id != <span class="hljs-literal">null</span>
      ? registry.<span class="hljs-title function_">get</span>(id)
      : (registry.<span class="hljs-property">size</span> === <span class="hljs-number">1</span> ? <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(registry.<span class="hljs-title function_">values</span>())[<span class="hljs-number">0</span>] : <span class="hljs-literal">undefined</span>);

  <span class="hljs-keyword">if</span> (!entry) {
    <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> &amp;&amp; registry.<span class="hljs-property">size</span> &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5(): multiple canvases found; pass an 'id' to select one."</span>);
    }
    <span class="hljs-keyword">return</span> { id, <span class="hljs-attr">p5</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">canvas</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">0</span> } };
  }

  <span class="hljs-keyword">return</span> {
    id,
    <span class="hljs-attr">p5</span>: entry.<span class="hljs-property">p5Ref</span>?.<span class="hljs-property">current</span> || <span class="hljs-literal">null</span>,
    <span class="hljs-attr">canvas</span>: entry.<span class="hljs-property">canvasRef</span>?.<span class="hljs-property">current</span> || <span class="hljs-literal">null</span>,
    <span class="hljs-attr">ready</span>: !!entry.<span class="hljs-property">ready</span>,
    <span class="hljs-attr">size</span>: entry.<span class="hljs-property">size</span>,
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5List</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> regCtx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>);
  <span class="hljs-keyword">if</span> (!regCtx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5List must be used inside &lt;P5.ContextProvider&gt;."</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(regCtx.<span class="hljs-property">registry</span>.<span class="hljs-title function_">keys</span>()), [regCtx.<span class="hljs-property">registry</span>]);
}

<span class="hljs-comment">// ---------- Namespace export ----------</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">P5</span> = {
  <span class="hljs-title class_">ContextProvider</span>,
  <span class="hljs-title class_">Canvas</span>,
  <span class="hljs-title class_">Setup</span>,
  <span class="hljs-title class_">Draw</span>,
};

<span class="hljs-keyword">export</span> { useP5, useP5List };
</code></pre>

<h2>Example usage</h2>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span>, useP5 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./P5"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params">{ targetId }</span>) {
  <span class="hljs-keyword">const</span> { p5, canvas, ready } = <span class="hljs-title function_">useP5</span>(targetId);
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
        if (ready &amp;&amp; p5 &amp;&amp; canvas) p5.saveCanvas(canvas, `${targetId}-frame`, "png");
      }}
    &gt;
      Save {targetId}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [speedA, setSpeedA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0.01</span>);
  <span class="hljs-keyword">const</span> [sizeB, setSizeB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">80</span>);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"toolbar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">SaveButton</span> <span class="hljs-attr">targetId</span>=<span class="hljs-string">"sceneA"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">SaveButton</span> <span class="hljs-attr">targetId</span>=<span class="hljs-string">"sceneB"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Speed A
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span>
            <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"0.05"</span> <span class="hljs-attr">step</span>=<span class="hljs-string">"0.001"</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">{speedA}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setSpeedA(Number(e.target.value))}
          /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Size B
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span>
            <span class="hljs-attr">min</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">step</span>=<span class="hljs-string">"1"</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">{sizeB}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setSizeB(Number(e.target.value))}
          /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sceneA"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{600}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"canvasA"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> { /* one-time init A */ }} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
          <span class="hljs-attr">params</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">speed:</span> <span class="hljs-attr">speedA</span> }}
          <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> { <span class="hljs-attr">speed</span> }) =&gt;</span> {
            p5.background(240);
            p5.normalMaterial();
            p5.push();
            p5.rotateX(p5.frameCount * speed);
            p5.rotateY(p5.frameCount * speed);
            p5.box(100);
            p5.pop();
          }}
        /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sceneB"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{400}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{300}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"P2D"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"canvasB"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5)</span> =&gt;</span> { p5.noStroke(); }} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span>
          <span class="hljs-attr">params</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">size:</span> <span class="hljs-attr">sizeB</span> }}
          <span class="hljs-attr">fn</span>=<span class="hljs-string">{(p5,</span> { <span class="hljs-attr">size</span> }) =&gt;</span> {
            p5.background(255);
            p5.fill(30);
            p5.circle(200, 150, size);
          }}
        /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
  );
}
</code></pre>

<h2>Notes &amp; options</h2>
<ul>
<li>
<p><strong>Why <code>id</code> is required on <code>&lt;P5.Canvas&gt;</code>:</strong> it makes multi-instance predictable and enables <code>useP5(id)</code>. If you prefer, you can auto-generate ids, but explicit ids are nicer for tooling and debugging.</p>
</li>
<li>
<p><strong>Resize vs. recreate:</strong> Right now, changing <code>width/height/renderer</code> triggers a full recreate. If you want <strong>resize without flicker</strong> for size changes, add a <code>resizeOnSizeChange</code> prop on <code>Canvas</code> and, when true, call <code>p5.resizeCanvas(width, height)</code> instead of <code>recreate()</code> (but keep recreate for renderer changes).</p>
</li>
<li>
<p><strong>StrictMode:</strong> dev double-mount is handled via <code>inst.remove()</code> during cleanup.</p>
</li>
<li>
<p><strong>External control:</strong> Since the provider stores <code>setDraw</code>, <code>setSetupSpec</code>, and <code>recreate</code> per canvas, you could add an advanced hook <code>useP5Controls(id)</code> to switch draw functions from outside the canvas tree if you like.</p>
</li>
</ul>
<p>If you want me to add the smooth-resize option or an API to <strong>swap the draw function from outside</strong> the Canvas (e.g., for sketch “scenes”), I can extend this scaffolding cleanly.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Can you suggest a directory structure that split this large file (P5 wrapper components &amp; logic) into multiple files?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Oh totally — right now <code>P5.jsx</code> is doing a <em>lot</em>: global provider, per-canvas lifecycle, setup/draw, hooks, helpers. Splitting it up will make it easier to reason about and test. Here’s a pragmatic React-style directory structure I’d recommend:</p>

<h2>📂 Suggested structure</h2>
<pre class="overflow-visible!"><code class="whitespace-pre! code-block hljs language-awk" style="display: block;" data-highlighted="yes">src<span class="hljs-regexp">/p5/</span>
├── index.js                 <span class="hljs-comment"># Re-exports the public API</span>
├── context/
│   ├── RegistryContext.js    <span class="hljs-comment"># Global provider (ContextProvider) + registry logic</span>
│   └── CanvasContext.js      <span class="hljs-comment"># Canvas-scoped context for Setup/Draw</span>
├── components/
│   ├── P5Canvas.jsx          <span class="hljs-comment"># &lt;P5.Canvas&gt; implementation</span>
│   ├── P5Setup.jsx           <span class="hljs-comment"># &lt;P5.Setup&gt;</span>
│   ├── P5Draw.jsx            <span class="hljs-comment"># &lt;P5.Draw&gt;</span>
│   └── helpers.js            <span class="hljs-comment"># e.g. rendererConst, makeSketch</span>
├── hooks/
│   ├── useP5.js              <span class="hljs-comment"># useP5(id)</span>
│   └── useP5List.js          <span class="hljs-comment"># useP5List()</span>
</code></pre>

<h2>📄 File contents (high-level)</h2>
<h3><code>src/p5/context/RegistryContext.js</code></h3>
<ul>
<li>
<p>Defines <code>RegistryCtx</code></p>
</li>
<li>
<p>Exports <code>&lt;ContextProvider&gt;</code></p>
</li>
<li>
<p>Handles global registry map (<code>id -&gt; { p5Ref, canvasRef, … }</code>)</p>
</li>
<li>
<p>Exposes <code>registerCanvas</code>, <code>updateCanvas</code>, <code>unregisterCanvas</code></p>
</li>
</ul>
<h3><code>src/p5/context/CanvasContext.js</code></h3>
<ul>
<li>
<p>Defines <code>CanvasCtx</code></p>
</li>
<li>
<p>Provides per-canvas context so <code>&lt;P5.Setup&gt;</code> / <code>&lt;P5.Draw&gt;</code> know which canvas they belong to</p>
</li>
</ul>
<h3><code>src/p5/components/P5Canvas.jsx</code></h3>
<ul>
<li>
<p>Implements <code>&lt;P5.Canvas&gt;</code></p>
</li>
<li>
<p>Handles DOM container, instantiation of <code>p5</code>, wiring setup/draw specs</p>
</li>
<li>
<p>Registers/unregisters with <code>RegistryCtx</code></p>
</li>
<li>
<p>Wraps children in <code>CanvasCtx</code></p>
</li>
</ul>
<h3><code>src/p5/components/P5Setup.jsx</code></h3>
<ul>
<li>
<p>Implements <code>&lt;P5.Setup&gt;</code></p>
</li>
<li>
<p>Reads <code>CanvasCtx</code> → calls <code>setSetupSpec</code></p>
</li>
</ul>
<h3><code>src/p5/components/P5Draw.jsx</code></h3>
<ul>
<li>
<p>Implements <code>&lt;P5.Draw&gt;</code></p>
</li>
<li>
<p>Reads <code>CanvasCtx</code> → calls <code>setDraw</code></p>
</li>
</ul>
<h3><code>src/p5/components/helpers.js</code></h3>
<ul>
<li>
<p><code>rendererConst</code></p>
</li>
<li>
<p>(optional) <code>makeP5Sketch</code> if you want to extract that</p>
</li>
</ul>
<h3><code>src/p5/hooks/useP5.js</code></h3>
<ul>
<li>
<p>Reads from <code>RegistryCtx</code></p>
</li>
<li>
<p>Returns <code>{ p5, canvas, ready, size }</code> for a given <code>id</code> (or auto-picks if only one canvas)</p>
</li>
</ul>
<h3><code>src/p5/hooks/useP5List.js</code></h3>
<ul>
<li>
<p>Returns list of canvas IDs currently registered</p>
</li>
</ul>
<h3><code>src/p5/index.js</code></h3>
<p>The “public surface” of your API. Example:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContextProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context/RegistryContext"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Canvas</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/P5Canvas"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setup</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/P5Setup"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Draw</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/P5Draw"</span>;

<span class="hljs-keyword">import</span> { useP5 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./hooks/useP5"</span>;
<span class="hljs-keyword">import</span> { useP5List } <span class="hljs-keyword">from</span> <span class="hljs-string">"./hooks/useP5List"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">P5</span> = {
  <span class="hljs-title class_">ContextProvider</span>,
  <span class="hljs-title class_">Canvas</span>,
  <span class="hljs-title class_">Setup</span>,
  <span class="hljs-title class_">Draw</span>,
};

<span class="hljs-keyword">export</span> { useP5, useP5List };
</code></pre>

<h2>✅ Benefits</h2>
<ul>
<li>
<p><strong>Separation of concerns:</strong> Provider logic, per-canvas lifecycle, and child components live in their own files.</p>
</li>
<li>
<p><strong>Testability:</strong> You can write isolated tests for <code>RegistryContext</code> or <code>P5Canvas</code>.</p>
</li>
<li>
<p><strong>Tree-shakable:</strong> Consumers can import only what they need.</p>
</li>
<li>
<p><strong>Readability:</strong> Each file is ~100 lines or less instead of 500+ lines.</p>
</li>
</ul>

<p>Do you want me to actually <em>split your current big file into these separate files</em> with ready-to-paste code, or just keep the structure suggestion at this level?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Give me each file's content individually now</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>awesome — here’s the split, ready to paste. all JavaScript (no TS).</p>

<h1><code>src/p5/context/RegistryContext.js</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { createContext, useCallback, useMemo, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">RegistryCtx</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">/**
 * Global provider that keeps a registry of canvases.
 * Each entry: id -&gt; { p5Ref, canvasRef, ready, size, setDraw, setSetupSpec, recreate }
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContextProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> [registry, setRegistry] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());

  <span class="hljs-keyword">const</span> registerCanvas = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id, api</span>) =&gt;</span> {
    <span class="hljs-title function_">setRegistry</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      next.<span class="hljs-title function_">set</span>(id, api);
      <span class="hljs-keyword">return</span> next;
    });
  }, []);

  <span class="hljs-keyword">const</span> updateCanvas = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id, patch</span>) =&gt;</span> {
    <span class="hljs-title function_">setRegistry</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!prev.<span class="hljs-title function_">has</span>(id)) <span class="hljs-keyword">return</span> prev;
      <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      next.<span class="hljs-title function_">set</span>(id, { ...prev.<span class="hljs-title function_">get</span>(id), ...patch });
      <span class="hljs-keyword">return</span> next;
    });
  }, []);

  <span class="hljs-keyword">const</span> unregisterCanvas = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
    <span class="hljs-title function_">setRegistry</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!prev.<span class="hljs-title function_">has</span>(id)) <span class="hljs-keyword">return</span> prev;
      <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      next.<span class="hljs-title function_">delete</span>(id);
      <span class="hljs-keyword">return</span> next;
    });
  }, []);

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> ({ registry, registerCanvas, updateCanvas, unregisterCanvas }),
    [registry, registerCanvas, updateCanvas, unregisterCanvas]
  );

  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">RegistryCtx.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">RegistryCtx.Provider</span>&gt;</span></span>;
}
</code></pre>

<h1><code>src/p5/context/CanvasContext.js</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-comment">/**
 * Per-canvas context so &lt;P5.Setup&gt; / &lt;P5.Draw&gt; target their owning canvas.
 * value: { id, setSetupSpec, setDraw, recreate }
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">CanvasCtx</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);
</code></pre>

<h1><code>src/p5/components/helpers.js</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rendererConst</span>(<span class="hljs-params">p5, renderer</span>) {
  <span class="hljs-keyword">return</span> renderer === <span class="hljs-string">"WEBGL"</span> ? p5.<span class="hljs-property">WEBGL</span> : p5.<span class="hljs-property">P2D</span>;
}
</code></pre>

<h1><code>src/p5/components/P5Canvas.jsx</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useRef,
  useState,
  <span class="hljs-title class_">Children</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> p5js <span class="hljs-keyword">from</span> <span class="hljs-string">"p5"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RegistryCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/RegistryContext"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CanvasCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/CanvasContext"</span>;
<span class="hljs-keyword">import</span> { rendererConst } <span class="hljs-keyword">from</span> <span class="hljs-string">"./helpers"</span>;

<span class="hljs-comment">/**
 * &lt;P5.Canvas id width height renderer className style&gt;
 * Children should include &lt;P5.Setup/&gt; and/or &lt;P5.Draw/&gt;, but any children are allowed.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Canvas</span>(<span class="hljs-params">{ id, width, height, renderer = <span class="hljs-string">"P2D"</span>, className, style, children }</span>) {
  <span class="hljs-keyword">const</span> hostDivRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// per-instance refs/state</span>
  <span class="hljs-keyword">const</span> p5Ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> canvasRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> setupSpecRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });
  <span class="hljs-keyword">const</span> drawSpecRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> });

  <span class="hljs-keyword">const</span> [ready, setReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [instanceKey, setInstanceKey] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> { registerCanvas, updateCanvas, unregisterCanvas } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>) || {};

  <span class="hljs-keyword">if</span> (!registerCanvas) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Canvas&gt; must be used inside &lt;P5.ContextProvider&gt;."</span>);
  }
  <span class="hljs-keyword">if</span> (!id) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Canvas&gt; requires an 'id' prop for multi-instance support."</span>);
  }

  <span class="hljs-keyword">const</span> recreate = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setInstanceKey</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> k + <span class="hljs-number">1</span>), []);

  <span class="hljs-keyword">const</span> setSetupSpec = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-function">(<span class="hljs-params">spec</span>) =&gt;</span> {
      setupSpecRef.<span class="hljs-property">current</span> = spec || { <span class="hljs-attr">fn</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">params</span>: <span class="hljs-literal">undefined</span> };
      <span class="hljs-comment">// Contract: setup changes trigger full recreation</span>
      <span class="hljs-title function_">recreate</span>();
    },
    [recreate]
  );

  <span class="hljs-keyword">const</span> setDraw = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">fn, params</span>) =&gt;</span> {
    drawSpecRef.<span class="hljs-property">current</span> = { fn, params };
    <span class="hljs-keyword">const</span> inst = p5Ref.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (inst) {
      <span class="hljs-keyword">if</span> (fn) {
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(inst, drawSpecRef.<span class="hljs-property">current</span>.<span class="hljs-property">params</span>);
        inst.<span class="hljs-title function_">loop</span>();
      } <span class="hljs-keyword">else</span> {
        inst.<span class="hljs-title function_">noLoop</span>();
        inst.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
      }
    }
  }, []);

  <span class="hljs-comment">// Register in global registry on mount; unregister on unmount</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerCanvas</span>(id, {
      p5Ref,
      canvasRef,
      <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">size</span>: { width, height },
      setDraw,
      setSetupSpec,
      recreate,
    });
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unregisterCanvas</span>(id);
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [id]);

  <span class="hljs-comment">// Keep size up to date in registry</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">size</span>: { width, height } });
  }, [id, width, height, updateCanvas]);

  <span class="hljs-comment">// Create/recreate p5 instance when instanceKey/size/renderer change</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> host = hostDivRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!host) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sketch</span> = (<span class="hljs-params">p</span>) =&gt; {
      p5Ref.<span class="hljs-property">current</span> = p;

      p.<span class="hljs-property">setup</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> cnv = p.<span class="hljs-title function_">createCanvas</span>(width, height, <span class="hljs-title function_">rendererConst</span>(p, renderer));
        canvasRef.<span class="hljs-property">current</span> = cnv.<span class="hljs-property">elt</span>;

        <span class="hljs-comment">// run user setup</span>
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">fn</span>: sfn, <span class="hljs-attr">params</span>: sparams } = setupSpecRef.<span class="hljs-property">current</span> || {};
        <span class="hljs-keyword">if</span> (sfn) <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">sfn</span>(p, sparams)).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);

        <span class="hljs-comment">// bind user draw</span>
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">fn</span>: dfn, <span class="hljs-attr">params</span>: dparams } = drawSpecRef.<span class="hljs-property">current</span> || {};
        <span class="hljs-keyword">if</span> (dfn) {
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dfn</span>(p, dparams);
          p.<span class="hljs-title function_">loop</span>();
        } <span class="hljs-keyword">else</span> {
          p.<span class="hljs-title function_">noLoop</span>();
          p.<span class="hljs-property">draw</span> = <span class="hljs-function">() =&gt;</span> {};
        }

        <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">ready</span>: <span class="hljs-literal">true</span> });
      };
    };

    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title function_">p5js</span>(sketch, host);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setReady</span>(<span class="hljs-literal">false</span>);
      <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span> });
      <span class="hljs-keyword">try</span> {
        inst.<span class="hljs-title function_">remove</span>();
      } <span class="hljs-keyword">catch</span> (_) {}
      <span class="hljs-keyword">if</span> (p5Ref.<span class="hljs-property">current</span> === inst) p5Ref.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      canvasRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
    };
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [instanceKey, width, height, renderer]);

  <span class="hljs-comment">// By default, change in width/height/renderer =&gt; recreate</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">recreate</span>();
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [width, height, renderer]);

  <span class="hljs-keyword">const</span> canvasCtxValue = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> ({ id, setSetupSpec, setDraw, recreate }),
    [id, setSetupSpec, setDraw, recreate]
  );

  <span class="hljs-comment">// Let children render (Setup/Draw will hook via CanvasCtx)</span>
  <span class="hljs-keyword">const</span> renderedChildren = <span class="hljs-title class_">Children</span>.<span class="hljs-title function_">map</span>(children, <span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> child);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">CanvasCtx.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{canvasCtxValue}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{hostDivRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> <span class="hljs-attr">suppressHydrationWarning</span> /&gt;</span>
      {renderedChildren}
    <span class="hljs-tag">&lt;/<span class="hljs-name">CanvasCtx.Provider</span>&gt;</span></span>
  );
}
</code></pre>

<h1><code>src/p5/components/P5Setup.jsx</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { useContext, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CanvasCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/CanvasContext"</span>;

<span class="hljs-comment">/** Use inside &lt;P5.Canvas&gt; to define the setup routine (triggers full recreate on change). */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Setup</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">CanvasCtx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Setup&gt; must be used inside &lt;P5.Canvas&gt;."</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setSetupSpec</span>({ fn, params });
    <span class="hljs-comment">// Full recreate happens inside setSetupSpec -&gt; recreate()</span>
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>

<h1><code>src/p5/components/P5Draw.jsx</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { useContext, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CanvasCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/CanvasContext"</span>;

<span class="hljs-comment">/** Use inside &lt;P5.Canvas&gt; to define the draw routine (hot-swappable without recreate). */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">{ fn, params }</span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">CanvasCtx</span>);
  <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"&lt;P5.Draw&gt; must be used inside &lt;P5.Canvas&gt;."</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ctx.<span class="hljs-title function_">setDraw</span>(fn, params);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> ctx.<span class="hljs-title function_">setDraw</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>);
    <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  }, [fn, params]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>

<h1><code>src/p5/hooks/useP5.js</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RegistryCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/RegistryContext"</span>;

<span class="hljs-comment">/**
 * Access a p5 canvas by id. If id is omitted and there is exactly one canvas,
 * returns that one. If multiple exist and id is omitted, throws.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> regCtx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>);
  <span class="hljs-keyword">if</span> (!regCtx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5 must be used inside &lt;P5.ContextProvider&gt;."</span>);

  <span class="hljs-keyword">const</span> { registry } = regCtx;

  <span class="hljs-keyword">const</span> entry =
    id != <span class="hljs-literal">null</span>
      ? registry.<span class="hljs-title function_">get</span>(id)
      : registry.<span class="hljs-property">size</span> === <span class="hljs-number">1</span>
      ? <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(registry.<span class="hljs-title function_">values</span>())[<span class="hljs-number">0</span>]
      : <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (!entry) {
    <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> &amp;&amp; registry.<span class="hljs-property">size</span> &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5(): multiple canvases found; pass an 'id' to select one."</span>);
    }
    <span class="hljs-keyword">return</span> { id, <span class="hljs-attr">p5</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">canvas</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">0</span> } };
  }

  <span class="hljs-keyword">return</span> {
    id,
    <span class="hljs-attr">p5</span>: entry.<span class="hljs-property">p5Ref</span>?.<span class="hljs-property">current</span> || <span class="hljs-literal">null</span>,
    <span class="hljs-attr">canvas</span>: entry.<span class="hljs-property">canvasRef</span>?.<span class="hljs-property">current</span> || <span class="hljs-literal">null</span>,
    <span class="hljs-attr">ready</span>: !!entry.<span class="hljs-property">ready</span>,
    <span class="hljs-attr">size</span>: entry.<span class="hljs-property">size</span>,
  };
}
</code></pre>

<h1><code>src/p5/hooks/useP5List.js</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { useContext, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RegistryCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/RegistryContext"</span>;

<span class="hljs-comment">/** Returns an array of registered canvas IDs. */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5List</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> regCtx = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>);
  <span class="hljs-keyword">if</span> (!regCtx) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"useP5List must be used inside &lt;P5.ContextProvider&gt;."</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(regCtx.<span class="hljs-property">registry</span>.<span class="hljs-title function_">keys</span>()), [regCtx.<span class="hljs-property">registry</span>]);
}
</code></pre>

<h1><code>src/p5/index.js</code></h1>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContextProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context/RegistryContext"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Canvas</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/P5Canvas"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setup</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/P5Setup"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Draw</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/P5Draw"</span>;

<span class="hljs-keyword">import</span> { useP5 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./hooks/useP5"</span>;
<span class="hljs-keyword">import</span> { useP5List } <span class="hljs-keyword">from</span> <span class="hljs-string">"./hooks/useP5List"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">P5</span> = {
  <span class="hljs-title class_">ContextProvider</span>,
  <span class="hljs-title class_">Canvas</span>,
  <span class="hljs-title class_">Setup</span>,
  <span class="hljs-title class_">Draw</span>,
};

<span class="hljs-keyword">export</span> { useP5, useP5List };
</code></pre>

<h2>optional tweaks you can add later</h2>
<ul>
<li>
<p><strong>Smooth resize:</strong> in <code>P5Canvas.jsx</code>, detect width/height changes and call <code>p5.resizeCanvas</code> instead of <code>recreate()</code> if you want to avoid flicker (keep recreate for renderer changes).</p>
</li>
<li>
<p><strong>External scene switching:</strong> since the registry stores <code>setDraw</code>/<code>setSetupSpec</code>, you can expose a <code>useP5Controls(id)</code> hook that lets you swap draw/setup from <em>outside</em> the canvas’ JSX.</p>
</li>
</ul></div>
        </div>
      
        <div class="message user-message">
          <div class="content">just a message to keep the thread alive. no answer required</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>👍 Got it — I’ll keep listening.</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Please add Smoth resize; then expands on what benefits come from <code>External scene switching</code>, and in which case this would be useful</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Perfect, let’s level this up 🚀</p>

<h2>✅ Smooth resize</h2>
<p>Right now in <code>P5Canvas.jsx</code> we <em>always</em> call <code>recreate()</code> when <code>width</code> or <code>height</code> props change. That means we destroy and rebuild the canvas (and p5 instance) → flicker, state loss.</p>
<p>For many use cases (resizing a window, making a responsive layout), it’s better to just call <code>p5.resizeCanvas</code>. That keeps the same p5 instance alive, keeps your state intact, and just updates the drawing surface.</p>
<h3>Implementation</h3>
<p>In <code>P5Canvas.jsx</code>, replace this bit:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// By default, change in width/height/renderer =&gt; recreate</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">recreate</span>();
  <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
}, [width, height, renderer]);
</code></pre>
<p>with:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// Handle resize / renderer change</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> inst = p5Ref.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">if</span> (inst &amp;&amp; <span class="hljs-title function_">rendererConst</span>(inst, renderer) === inst.<span class="hljs-property">_renderer</span>?.<span class="hljs-property">GL</span>?.<span class="hljs-property">RENDERER</span>) {
    <span class="hljs-comment">// same renderer → resize only</span>
    inst.<span class="hljs-title function_">resizeCanvas</span>(width, height);
    <span class="hljs-title function_">updateCanvas</span>(id, { <span class="hljs-attr">size</span>: { width, height } });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// renderer changed → must recreate</span>
    <span class="hljs-title function_">recreate</span>();
  }
  <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
}, [width, height, renderer]);
</code></pre>
<p>This way:</p>
<ul>
<li>
<p>If only <code>width</code>/<code>height</code> change and renderer is unchanged → smooth resize with no flicker.</p>
</li>
<li>
<p>If <code>renderer</code> changes (e.g. <code>"P2D"</code> → <code>"WEBGL"</code>) → full recreate (still necessary).</p>
</li>
</ul>

<h2>🎭 External scene switching</h2>
<p>By default, we define <code>&lt;P5.Setup&gt;</code> and <code>&lt;P5.Draw&gt;</code> as JSX children of a <code>&lt;P5.Canvas&gt;</code>. That’s great for static sketches. But what if you want to <strong>swap whole sketches/scenes at runtime</strong> without unmounting/remounting components?</p>
<h3>What it means</h3>
<ul>
<li>
<p>Each canvas’ registry entry already stores <code>setDraw</code>, <code>setSetupSpec</code>, and <code>recreate</code>.</p>
</li>
<li>
<p>You can expose those through a hook like <code>useP5Controls(id)</code>.</p>
</li>
<li>
<p>From anywhere under <code>&lt;P5.ContextProvider&gt;</code>, you can call <code>controls.setDraw(newFn)</code> or <code>controls.setSetupSpec(newSpec)</code> to swap scenes on the fly.</p>
</li>
</ul>
<h3>Example use cases</h3>
<ol>
<li>
<p><strong>Interactive playground / code editor:</strong>
User edits code in a text area; when they hit “Run,” you replace the canvas’ <code>draw</code> function with their new code.</p>
</li>
<li>
<p><strong>Sketch “scenes” or states:</strong>
Imagine a game-like flow:</p>
<ul>
<li>
<p>Scene 1 = intro animation</p>
</li>
<li>
<p>Scene 2 = gameplay loop</p>
</li>
<li>
<p>Scene 3 = game over screen
You can swap <code>draw</code> functions without blowing away the canvas.</p>
</li>
</ul>
</li>
<li>
<p><strong>Performance optimization:</strong>
If you only need to switch rendering logic (but keep heavy setup assets like images, shaders, or models loaded), you can preserve them in memory and avoid a full teardown.</p>
</li>
<li>
<p><strong>Dynamic composition tools:</strong>
For example, a React UI where a user picks “rotate cube” vs. “draw waves.” Instead of conditionally rendering different <code>&lt;P5.Draw&gt;</code> nodes (which unmount/remount), you push new draw logic via <code>setDraw</code>.</p>
</li>
</ol>
<h3>Example API for external scene switching</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-comment">// hooks/useP5Controls.js</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RegistryCtx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context/RegistryContext"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useP5Controls</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> { registry } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">RegistryCtx</span>);
  <span class="hljs-keyword">const</span> entry = registry.<span class="hljs-title function_">get</span>(id);
  <span class="hljs-keyword">if</span> (!entry) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`No canvas with id=<span class="hljs-subst">${id}</span>`</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">setDraw</span>: entry.<span class="hljs-property">setDraw</span>,
    <span class="hljs-attr">setSetup</span>: entry.<span class="hljs-property">setSetupSpec</span>,
    <span class="hljs-attr">recreate</span>: entry.<span class="hljs-property">recreate</span>,
  };
}
</code></pre>
<p>Usage:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SceneSwitcher</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> controls = <span class="hljs-title function_">useP5Controls</span>(<span class="hljs-string">"sceneA"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> controls.setDraw((p5) =&gt; { p5.background(200); p5.circle(50, 50, 50); })}&gt;
        Circle Scene
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> controls.setDraw((p5) =&gt; { p5.background(0); p5.box(100); })}&gt;
        Box Scene
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>

<h2>🏆 Benefits summary</h2>
<ul>
<li>
<p><strong>Smooth resize:</strong></p>
<ul>
<li>
<p>Prevents flicker and teardown on window resizes.</p>
</li>
<li>
<p>Keeps sketch state (variables, loaded assets) alive.</p>
</li>
<li>
<p>Ideal for responsive layouts or draggable resizable panels.</p>
</li>
</ul>
</li>
<li>
<p><strong>External scene switching:</strong></p>
<ul>
<li>
<p>Lets you orchestrate sketches from higher-level React logic.</p>
</li>
<li>
<p>Keeps assets/state alive between “scenes.”</p>
</li>
<li>
<p>Perfect for editors, demos, games, or interactive storytelling where the sketch changes behavior at runtime.</p>
</li>
</ul>
</li>
</ul>

<p>👉 Want me to actually integrate both <strong>smooth resize</strong> <em>and</em> <code>useP5Controls</code> into the split multi-file version I gave you earlier, so you have the updated code ready to drop in?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Don't we already support updating the draw function through passing a different fn to the &lt;P5.Draw&gt; component without rerendering? I see that <code>drawSpecRef</code> is a React Ref, which are not generally used to determine if a new render is necessary</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>You’re absolutely right 👌 — the way we wired <code>&lt;P5.Draw&gt;</code> already supports hot-swapping the draw function. Let me unpack why:</p>

<h3>🔍 What’s happening now</h3>
<ul>
<li>
<p>Each <code>&lt;P5.Canvas&gt;</code> has a <strong>mutable ref</strong> <code>drawSpecRef</code> that stores <code>{ fn, params }</code>.</p>
</li>
<li>
<p><code>&lt;P5.Draw&gt;</code> calls <code>ctx.setDraw(fn, params)</code> whenever its props change.</p>
</li>
<li>
<p><code>setDraw</code> updates <code>drawSpecRef.current</code> and <strong>replaces <code>p5.draw</code> directly</strong> on the running p5 instance.</p>
</li>
</ul>
<p>Because <code>drawSpecRef</code> is a ref:</p>
<ul>
<li>
<p>Updating it <strong>does not trigger React re-render</strong> (which is what we want).</p>
</li>
<li>
<p>Instead, it mutates the live p5 instance immediately.</p>
</li>
<li>
<p>Result: new draw function is used on the <em>very next animation frame</em> with zero teardown.</p>
</li>
</ul>
<p>So yes — just changing <code>&lt;P5.Draw fn={…} /&gt;</code> already achieves “external scene switching” behavior for draw logic.</p>

<h3>🤔 So why talk about <code>useP5Controls</code>?</h3>
<p>The only difference is <em>where</em> you declare that draw function:</p>
<ul>
<li>
<p><strong>With <code>&lt;P5.Draw&gt;</code></strong>:</p>
<ul>
<li>
<p>It’s colocated in JSX inside the canvas.</p>
</li>
<li>
<p>Great when the sketch is known at render time.</p>
</li>
<li>
<p>But if you want to change the sketch <em>from a toolbar or editor outside that JSX</em>, you’d need to funnel the new fn down through React props.</p>
</li>
</ul>
</li>
<li>
<p><strong>With <code>useP5Controls(id)</code></strong>:</p>
<ul>
<li>
<p>You can grab <code>setDraw</code> directly from context anywhere under the provider.</p>
</li>
<li>
<p>You don’t need a <code>&lt;P5.Draw&gt;</code> component at all.</p>
</li>
<li>
<p>This decouples scene switching from React’s render flow — you can do things like:</p>
<ul>
<li>
<p>Change the sketch on a button click without re-rendering the canvas subtree.</p>
</li>
<li>
<p>Dynamically load scene modules and install them into the running canvas.</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<h3>✅ So what we have now</h3>
<ul>
<li>
<p><strong>Hot-swapping draw logic</strong> via <code>&lt;P5.Draw&gt;</code> ✔️</p>
</li>
<li>
<p><strong>Smooth state preservation</strong> (since the instance doesn’t rebuild) ✔️</p>
</li>
</ul>
<h3>🏆 What <code>useP5Controls</code> adds</h3>
<ul>
<li>
<p>External / imperative access to the same capabilities.</p>
</li>
<li>
<p>Useful if your “scene logic” isn’t nicely expressed as props.</p>
</li>
<li>
<p>Keeps React render cycles cleaner when all you want to do is tell p5 to switch.</p>
</li>
</ul>

<p>👉 Question for you: would you prefer to keep the API <strong>purely declarative</strong> (<code>&lt;P5.Draw&gt;</code> everywhere), or should I extend the split-file version to expose an <strong>optional imperative hook (<code>useP5Controls</code>)</strong> so you can do both styles?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">I mean, I think we are better off having one way to pass the draw function down to avoid having different function references (the one passed to the component vs the one overriden through useP5Controls), and I don't see the value of not having to pass props down to the canvas. Seems to me like a great way to introduce additional errors</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>💯 I’m with you.</p>
<p>You’ve put your finger on the core trade-off: once you expose <em>two different pathways</em> to update the same thing (<code>&lt;P5.Draw fn={…}/&gt;</code> vs <code>useP5Controls(id).setDraw(fn)</code>), you open the door to subtle bugs:</p>
<ul>
<li>
<p><strong>Desync risk:</strong> The <code>&lt;P5.Draw&gt;</code> child and the imperative setter could be pointing to different functions, and only one of them actually “wins.”</p>
</li>
<li>
<p><strong>Mental overhead:</strong> Developers have to remember which API is “in charge.”</p>
</li>
<li>
<p><strong>React convention breakage:</strong> The whole point of using React is to push you toward declarative data flow (props/state) instead of imperative updates.</p>
</li>
</ul>

<h3>Why sticking to <code>&lt;P5.Draw&gt;</code> is enough</h3>
<ul>
<li>
<p>You <em>already</em> get hot-swapping draw functions without tearing down the canvas (thanks to <code>setDraw</code> mutating the instance).</p>
</li>
<li>
<p>You don’t lose any expressive power — external state can still flow down via props to <code>&lt;P5.Draw&gt;</code>.</p>
</li>
<li>
<p>It fits React’s mental model: <strong>state → props → rendering</strong>.</p>
</li>
</ul>
<p>The only scenario where an imperative setter helps is when you want to manipulate the canvas <em>completely outside React’s render cycle</em> (e.g., embedding p5 in a non-React app, or a live coding environment). For a React-only codebase, it’s usually not worth it.</p>

<h3>My recommendation</h3>
<ul>
<li>
<p><strong>Keep a single declarative path</strong>: <code>&lt;P5.Draw fn={…} params={…} /&gt;</code></p>
</li>
<li>
<p><strong>Kill the imperative setter API</strong> (<code>useP5Controls</code>) to avoid split sources of truth.</p>
</li>
<li>
<p>Focus on making <code>&lt;P5.Draw&gt;</code> ergonomic (e.g., support stable params, easy memoization with <code>useCallback</code>).</p>
</li>
<li>
<p>Let React state drive sketch changes — consistent and predictable.</p>
</li>
</ul>

<p>👉 Do you want me to update the split-file version so it drops the <code>setDraw</code> / <code>setSetupSpec</code> exposure from the registry entirely (cleaner surface), leaving <code>&lt;P5.Setup&gt;</code> and <code>&lt;P5.Draw&gt;</code> as the <strong>only supported mechanism</strong>?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">I did not integrate the useP5Controls effect, so no need to do any code changes.</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Perfect 👍 then you’re already in the safe lane:</p>
<ul>
<li>
<p>Declarative only (<code>&lt;P5.Setup&gt;</code> / <code>&lt;P5.Draw&gt;</code>)</p>
</li>
<li>
<p>Single source of truth for sketch logic</p>
</li>
<li>
<p>No risk of desync between imperative + declarative APIs</p>
</li>
</ul>
<p>That’s a very React-idiomatic design, and it’ll scale well as you add features.</p>
<p>If later you decide you <em>do</em> need an escape hatch for an editor / live-coding use case, you could add <code>useP5Controls</code> then — but until that’s a real requirement, simpler is better.</p>
<p>Would you like me to do a quick <strong>recap diagram</strong> of the final architecture (ContextProvider → Canvas → Setup/Draw, hooks for read-only access) so it’s easy to share with collaborators?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, I think we have a pretty solid p5 wrapper. 
Now from what I see however, we are no longer using @p5-wrapper/react?
Did we reinvent something that could have been simpler using p5-wrapper/react, exposing the same interface, or was it too complex to wrap p5-wrapper/react in a way that produced the desired api?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>That’s a really insightful question 👌</p>

<h2>Where we started</h2>
<ul>
<li>
<p><code>@p5-wrapper/react</code> gives you <code>&lt;ReactP5Wrapper sketch={sketch} /&gt;</code>.</p>
</li>
<li>
<p>You pass a function <code>sketch(p5)</code> which defines <code>p5.setup</code> and <code>p5.draw</code>.</p>
</li>
<li>
<p>It supports prop updates via <code>updateWithProps</code>.</p>
</li>
</ul>
<p>It’s great for simple, single-sketch cases, but your design goals were:</p>
<ol>
<li>
<p><strong>Declarative JSX API</strong> (<code>&lt;P5.Setup&gt;</code> / <code>&lt;P5.Draw&gt;</code>)</p>
</li>
<li>
<p><strong>Multi-canvas support with IDs</strong></p>
</li>
<li>
<p><strong>Smooth resize vs. full recreate</strong></p>
</li>
<li>
<p><strong>Context + hooks</strong> so React state and buttons can interact with the same p5 instance</p>
</li>
</ol>

<h2>Could we have wrapped <code>@p5-wrapper/react</code>?</h2>
<p>In theory yes, but in practice it would be awkward:</p>
<ul>
<li>
<p><strong>Canvas lifecycle</strong>:
<code>@p5-wrapper/react</code> controls the instance. To “recreate” on <code>&lt;P5.Setup&gt;</code> changes, you’d have to remount <code>&lt;ReactP5Wrapper&gt;</code> completely. We wanted fine-grained control (resize vs. recreate) that wrapper doesn’t expose.</p>
</li>
<li>
<p><strong>Multi-instance registry</strong>:
<code>@p5-wrapper/react</code> doesn’t keep a global registry. You’d have to layer one on top anyway.</p>
</li>
<li>
<p><strong>Declarative children</strong>:
Their API is <code>sketch(p5)</code>. To translate <code>&lt;P5.Draw fn={…}/&gt;</code> into that, you’d need a transformer function that rebuilds the sketch whenever props change. That means reattaching <code>p5.draw</code> imperatively anyway — which is exactly what we already wrote.</p>
</li>
<li>
<p><strong>Context + hooks</strong>:
<code>@p5-wrapper/react</code> doesn’t export instance refs. You can only use the <code>p5</code> argument inside your sketch. So you can’t easily expose <code>useP5()</code> for external buttons, unless you hack in a ref forwarding layer.</p>
</li>
</ul>

<h2>Why reinventing made sense here</h2>
<ul>
<li>
<p>We wanted <strong>precise control over lifecycle</strong>: resize vs. teardown, renderer changes, hot-swapping draw.</p>
</li>
<li>
<p>We wanted <strong>contextual access</strong>: <code>useP5(id)</code> for buttons/toolbars.</p>
</li>
<li>
<p>We wanted a <strong>React-native declarative API</strong> with <code>&lt;P5.Setup&gt;</code> and <code>&lt;P5.Draw&gt;</code> components.</p>
</li>
</ul>
<p><code>@p5-wrapper/react</code> is optimized for “just give me a sketch function.” Once you want multi-canvas registry + context + JSX children → it’s simpler to own the lifecycle.</p>

<h2>What we <em>did keep</em></h2>
<p>We didn’t reinvent p5 itself — we’re still using the core <code>p5</code> class directly.
Our wrapper is essentially a <strong>higher-level abstraction</strong> over the same mechanism that <code>@p5-wrapper/react</code> uses internally (creating and destroying a <code>new p5()</code> instance).</p>

<h3>✅ Conclusion</h3>
<ul>
<li>
<p>For <strong>quick sketches</strong>: <code>@p5-wrapper/react</code> is great.</p>
</li>
<li>
<p>For <strong>React-style composition, context, multiple canvases, smooth resize</strong>: our custom wrapper is the right tool.</p>
</li>
</ul>
<p>So no, we didn’t overcomplicate it — we built something <code>@p5-wrapper/react</code> can’t provide out of the box.</p>

<p>Do you want me to write a short “migration note” for your repo’s README? Something like: <em>“Why we don’t use <code>@p5-wrapper/react</code>, and how this wrapper differs”</em> — so future contributors know why the choice was made?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great. 
Note that I've moved the code written under src/lib/p5.
With this in mind, can you:

1. Give me instructions to setup a jest test suite (from scratch; assume vite is used for packaging, but beyond that you can use unit tests directly on the lib/p5 directory. Assume all non-test deps are installed)
2. List smoke tests (in english, not code) that would be pertinent to ensure the basic functionalities of the lib you've just written

?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Perfect 👌 let’s lock this in.</p>

<h1>1️⃣ Setting up Jest from scratch (with Vite project, testing <code>src/lib/p5</code>)</h1>
<p>Assuming you’ve got a Vite + React project already running, and your wrapper lives in <code>src/lib/p5</code>.</p>
<h3>Step 1. Install dependencies</h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-bash code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-comment"># Jest core</span>
npm install --save-dev jest @testing-library/react @testing-library/jest-dom

<span class="hljs-comment"># For JSX/ESM support</span>
npm install --save-dev babel-jest @babel/preset-env @babel/preset-react

<span class="hljs-comment"># (optional but common if you use hooks) </span>
npm install --save-dev @testing-library/user-event
</code></pre>
<h3>Step 2. Configure Babel (so Jest can transform JSX)</h3>
<p>Create (or extend) <code>babel.config.js</code> at the project root:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">presets</span>: [
    [<span class="hljs-string">"@babel/preset-env"</span>, { <span class="hljs-attr">targets</span>: { <span class="hljs-attr">node</span>: <span class="hljs-string">"current"</span> } }],
    [<span class="hljs-string">"@babel/preset-react"</span>, { <span class="hljs-attr">runtime</span>: <span class="hljs-string">"automatic"</span> }],
  ],
};
</code></pre>
<h3>Step 3. Configure Jest</h3>
<p>Create <code>jest.config.js</code> at the project root:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">"jsdom"</span>,        <span class="hljs-comment">// required for React DOM testing</span>
  <span class="hljs-attr">roots</span>: [<span class="hljs-string">"&lt;rootDir&gt;/src/lib/p5"</span>], <span class="hljs-comment">// only look inside your p5 wrapper folder</span>
  <span class="hljs-attr">moduleFileExtensions</span>: [<span class="hljs-string">"js"</span>, <span class="hljs-string">"jsx"</span>],
  <span class="hljs-attr">transform</span>: {
    <span class="hljs-string">"^.+\\.(js|jsx)$"</span>: <span class="hljs-string">"babel-jest"</span>,
  },
  <span class="hljs-attr">setupFilesAfterEnv</span>: [<span class="hljs-string">"@testing-library/jest-dom"</span>],
};
</code></pre>
<h3>Step 4. Add scripts to <code>package.json</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-json code-block hljs" style="display: block;" data-highlighted="yes"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:watch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest --watch"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3>Step 5. Run your first test</h3>
<p>Create <code>src/lib/p5/__tests__/basic.test.jsx</code> with something trivial (e.g., render a provider + canvas, assert the canvas div exists). Then:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-bash code-block hljs" style="display: block;" data-highlighted="yes">npm run <span class="hljs-built_in">test</span>
</code></pre>

<h1>2️⃣ Smoke test list (English descriptions)</h1>
<p>These aren’t detailed test cases yet — they’re “smoke tests” that ensure your wrapper isn’t fundamentally broken.</p>
<h3>A. Context &amp; Rendering</h3>
<ul>
<li>
<p><strong>Provider renders without crash</strong>: <code>&lt;P5.ContextProvider&gt;</code> can mount with no canvases.</p>
</li>
<li>
<p><strong>Canvas mounts and creates DOM</strong>: <code>&lt;P5.Canvas&gt;</code> produces a container <code>&lt;div&gt;</code>.</p>
</li>
<li>
<p><strong>Setup &amp; Draw mount without crash</strong>: <code>&lt;P5.Setup&gt;</code> and <code>&lt;P5.Draw&gt;</code> can be children of a canvas.</p>
</li>
</ul>
<h3>B. Lifecycle</h3>
<ul>
<li>
<p><strong>Canvas registers in registry</strong>: When <code>&lt;P5.Canvas id="foo" /&gt;</code> mounts, it’s discoverable via <code>useP5("foo")</code>.</p>
</li>
<li>
<p><strong>Canvas unregisters</strong>: When the canvas unmounts, it disappears from the registry.</p>
</li>
<li>
<p><strong>Multiple canvases</strong>: Two canvases with different IDs can mount simultaneously and both appear in the registry.</p>
</li>
</ul>
<h3>C. Draw &amp; Setup logic</h3>
<ul>
<li>
<p><strong>Draw function updates live</strong>: Changing <code>&lt;P5.Draw fn={...} /&gt;</code> swaps the draw function without tearing down the canvas.</p>
</li>
<li>
<p><strong>Setup change triggers recreate</strong>: Changing <code>&lt;P5.Setup fn={...} /&gt;</code> causes a new instance to be created.</p>
</li>
<li>
<p><strong>Params propagate</strong>: Values passed to <code>&lt;P5.Draw params={…} /&gt;</code> are visible in the draw function.</p>
</li>
</ul>
<h3>D. Resize behavior</h3>
<ul>
<li>
<p><strong>Width/height change resizes</strong>: Updating <code>width</code> or <code>height</code> on <code>&lt;P5.Canvas&gt;</code> resizes the canvas without teardown.</p>
</li>
<li>
<p><strong>Renderer change recreates</strong>: Updating <code>renderer</code> (<code>P2D</code> ↔ <code>WEBGL</code>) tears down and recreates the instance.</p>
</li>
</ul>
<h3>E. Hooks</h3>
<ul>
<li>
<p><strong>useP5 works</strong>: Inside a child component, <code>useP5("foo")</code> returns <code>{ p5, canvas, ready }</code> once the canvas is ready.</p>
</li>
<li>
<p><strong>useP5List works</strong>: Returns all registered canvas IDs.</p>
</li>
<li>
<p><strong>useP5 error states</strong>: Throws descriptive errors if called outside a provider, or with no ID when multiple canvases exist.</p>
</li>
</ul>
<h3>F. Basic interactivity</h3>
<ul>
<li>
<p><strong>p5 methods usable externally</strong>: Call a method (like <code>p5.noLoop()</code>) from a button using <code>useP5("foo")</code> and confirm it doesn’t throw.</p>
</li>
</ul>

<p>✅ With just those smoke tests, you’ll know if:</p>
<ul>
<li>
<p>Context wiring works</p>
</li>
<li>
<p>Canvas lifecycle works</p>
</li>
<li>
<p>Draw/setup updates behave as intended</p>
</li>
<li>
<p>Resize vs. recreate logic is respected</p>
</li>
<li>
<p>Hooks return the right information</p>
</li>
</ul>

<p>Do you want me to <strong>sketch out one or two concrete test files</strong> (using Testing Library + JSDOM) to bootstrap the suite, or would you prefer to keep it at this “smoke test plan” level for now?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">npm run test gives the following error:

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-stata">npm <span class="hljs-keyword">run</span> <span class="hljs-keyword">test</span>

&gt; art-jam-i@0.0.0 <span class="hljs-keyword">test</span>
&gt; jest

● Validation <span class="hljs-keyword">Error</span>:

  <span class="hljs-keyword">Test</span> environment jest-environment-jsdom cannot be found. Make sure the testEnvironment configuration option points to <span class="hljs-keyword">an</span> existing node module.

  Configuration Documentation:
  https:<span class="hljs-comment">//jestjs.io/docs/configuration</span>


<span class="hljs-keyword">As</span> of Jest 28 <span class="hljs-string">"jest-environment-jsdom"</span> is <span class="hljs-keyword">no</span> longer shipped <span class="hljs-keyword">by</span> default, make sure to install it separately.</code></pre>

Any configuration necessary in the current jest.config.js?

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-pgsql">module.exports = {
  testEnvironment: "jsdom",        // required <span class="hljs-keyword">for</span> React DOM testing
  roots: ["&lt;rootDir&gt;/src/lib/p5"], // <span class="hljs-keyword">only</span> look inside your p5 <span class="hljs-keyword">wrapper</span> folder
  moduleFileExtensions: ["js", "jsx"],
  <span class="hljs-keyword">transform</span>: {
    "^.+\\.(js|jsx)$": "babel-jest",
  },
  setupFilesAfterEnv: ["@testing-library/jest-dom"],
};</code></pre></div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Ah yep — that’s the change in <strong>Jest 28+</strong>: the <code>jsdom</code> environment was split out of core.</p>
<h3>✅ Fix</h3>
<p>Install the separate package:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-bash code-block hljs" style="display: block;" data-highlighted="yes">npm install --save-dev jest-environment-jsdom
</code></pre>
<p>That’s it — your current <code>jest.config.js</code> is already pointing to <code>"jsdom"</code>, which will resolve correctly once the environment is installed.</p>

<h3>🔎 Extra checks</h3>
<ol>
<li>
<p>Make sure <code>package.json</code> scripts don’t override it — <code>jest</code> will read your <code>jest.config.js</code>.</p>
</li>
<li>
<p>If you want to be explicit, you can write:</p>
</li>
</ol>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">"jest-environment-jsdom"</span>,
</code></pre>
<p>instead of just <code>"jsdom"</code>. Both work once the package is installed.</p>

<p>So your final <code>jest.config.js</code> can stay as-is, or you can make it explicit:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">"jest-environment-jsdom"</span>,
  <span class="hljs-attr">roots</span>: [<span class="hljs-string">"&lt;rootDir&gt;/src/lib/p5"</span>],
  <span class="hljs-attr">moduleFileExtensions</span>: [<span class="hljs-string">"js"</span>, <span class="hljs-string">"jsx"</span>],
  <span class="hljs-attr">transform</span>: {
    <span class="hljs-string">"^.+\\.(js|jsx)$"</span>: <span class="hljs-string">"babel-jest"</span>,
  },
  <span class="hljs-attr">setupFilesAfterEnv</span>: [<span class="hljs-string">"@testing-library/jest-dom"</span>],
};
</code></pre>

<p>👉 Want me to also show you how to stub <code>p5</code> in the test environment (so tests don’t try to actually draw to a canvas in JSDOM)?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Great, now we get the expected outcome:

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-awk">npm run test                   

&gt; art-jam-i@<span class="hljs-number">0.0</span>.<span class="hljs-number">0</span> test
&gt; jest

No tests found, exiting with code <span class="hljs-number">1</span>
Run with `--passWithNoTests` to <span class="hljs-keyword">exit</span> with code <span class="hljs-number">0</span>
In <span class="hljs-regexp">/Users/</span>philippe<span class="hljs-regexp">/Documents/</span>GitHub<span class="hljs-regexp">/concordia/</span>cu-cart253<span class="hljs-regexp">/projects/</span>art-jam-i
  <span class="hljs-number">8</span> files checked.
  testMatch: **<span class="hljs-regexp">/__tests__/</span>**<span class="hljs-regexp">/*.?([mc])[jt]s?(x), **/</span>?(*.)+(spec|test).?([mc])[jt]s?(x) - <span class="hljs-number">0</span> matches
  testPathIgnorePatterns: <span class="hljs-regexp">/node_modules/</span> - <span class="hljs-number">8</span> matches
  testRegex:  - <span class="hljs-number">0</span> matches
Pattern:  - <span class="hljs-number">0</span> matches</code></pre>

I agree with the tests proposed.
How do you intend to structure your test directories?</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Awesome 🎉 we’ve got Jest running, now let’s give it a home for tests.</p>

<h2>📂 Suggested test structure</h2>
<p>Keep tests close to the code they cover (so they’re easier to discover &amp; maintain), but still inside <code>src/lib/p5</code> since that’s the library you’re testing.</p>
<pre class="overflow-visible!"><code class="whitespace-pre! code-block hljs language-x86asm" style="display: block;" data-highlighted="yes">src/
└── lib/
    └── p5/
        ├── __tests__/                # all <span class="hljs-keyword">test</span> files live here
        │   ├── context<span class="hljs-number">.</span><span class="hljs-keyword">test</span><span class="hljs-number">.</span>jsx      # RegistryCtx &amp; CanvasCtx behavior
        │   ├── canvas-lifecycle<span class="hljs-number">.</span><span class="hljs-keyword">test</span><span class="hljs-number">.</span>jsx
        │   ├── draw-setup<span class="hljs-number">.</span><span class="hljs-keyword">test</span><span class="hljs-number">.</span>jsx
        │   ├── resize<span class="hljs-number">.</span><span class="hljs-keyword">test</span><span class="hljs-number">.</span>jsx
        │   └── hooks<span class="hljs-number">.</span><span class="hljs-keyword">test</span><span class="hljs-number">.</span>jsx
        ├── components/
        │   ├── P5Canvas<span class="hljs-number">.</span>jsx
        │   ├── P5Draw<span class="hljs-number">.</span>jsx
        │   ├── P5Setup<span class="hljs-number">.</span>jsx
        │   └── helpers<span class="hljs-number">.</span><span class="hljs-keyword">js</span>
        ├── context/
        │   ├── RegistryContext<span class="hljs-number">.</span><span class="hljs-keyword">js</span>
        │   └── CanvasContext<span class="hljs-number">.</span><span class="hljs-keyword">js</span>
        ├── hooks/
        │   ├── useP5<span class="hljs-number">.</span><span class="hljs-keyword">js</span>
        │   └── useP5List<span class="hljs-number">.</span><span class="hljs-keyword">js</span>
        └── index<span class="hljs-number">.</span><span class="hljs-keyword">js</span>
</code></pre>

<h2>🧪 How tests map to code</h2>
<ul>
<li>
<p><strong><code>context.test.jsx</code></strong></p>
<ul>
<li>
<p>Provider renders without crashing</p>
</li>
<li>
<p>Canvas registers/unregisters in registry</p>
</li>
<li>
<p>Multiple canvases tracked correctly</p>
</li>
</ul>
</li>
<li>
<p><strong><code>canvas-lifecycle.test.jsx</code></strong></p>
<ul>
<li>
<p><code>&lt;P5.Canvas&gt;</code> creates a div in the DOM</p>
</li>
<li>
<p>Unmount cleans up properly</p>
</li>
</ul>
</li>
<li>
<p><strong><code>draw-setup.test.jsx</code></strong></p>
<ul>
<li>
<p>Changing <code>&lt;P5.Draw fn={…}&gt;</code> updates draw function immediately</p>
</li>
<li>
<p>Changing <code>&lt;P5.Setup fn={…}&gt;</code> triggers a recreate</p>
</li>
</ul>
</li>
<li>
<p><strong><code>resize.test.jsx</code></strong></p>
<ul>
<li>
<p>Width/height prop changes → calls <code>p5.resizeCanvas</code> (no flicker)</p>
</li>
<li>
<p>Renderer change → tears down and recreates instance</p>
</li>
</ul>
</li>
<li>
<p><strong><code>hooks.test.jsx</code></strong></p>
<ul>
<li>
<p><code>useP5("foo")</code> returns instance refs and ready status</p>
</li>
<li>
<p><code>useP5List()</code> returns list of registered canvas IDs</p>
</li>
<li>
<p>Errors thrown when hooks are misused (outside provider, or no ID with &gt;1 canvas)</p>
</li>
</ul>
</li>
</ul>

<h2>📝 Naming conventions</h2>
<ul>
<li>
<p>Put all tests in <code>__tests__</code> so Jest picks them up automatically (<code>*.test.jsx</code>).</p>
</li>
<li>
<p>Match test filenames to the feature being tested, not necessarily 1:1 with file names (helps group related functionality).</p>
</li>
</ul>

<p>✅ With this structure:</p>
<ul>
<li>
<p>Tests are discoverable (<code>__tests__</code> right next to lib code).</p>
</li>
<li>
<p>Easy to expand later (add more test files, e.g., <code>interactivity.test.jsx</code>).</p>
</li>
<li>
<p>Keeps unit tests scoped to your wrapper without mixing with the main app.</p>
</li>
</ul>

<p>Would you like me to <strong>scaffold one actual test file</strong> (say <code>canvas-lifecycle.test.jsx</code>) showing how to render <code>&lt;P5.ContextProvider&gt;</code> + <code>&lt;P5.Canvas&gt;</code> and assert the canvas div exists, so you’ve got a working starting point?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Can you provide me a directory structure that follows the following tree:


<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-mipsasm">├── src
│   ├── lib
│   │   └── p5
│   │       ├── components
│   │       │   ├── P5Canvas.<span class="hljs-keyword">jsx
</span>│   │       │   ├── P5Draw.<span class="hljs-keyword">jsx
</span>│   │       │   └── P5Setup.<span class="hljs-keyword">jsx
</span>│   │       ├── <span class="hljs-built_in">context</span>
│   │       │   ├── CanvasContext.<span class="hljs-keyword">jsx
</span>│   │       │   └── RegistryContext.<span class="hljs-keyword">jsx
</span>│   │       ├── hooks
│   │       │   ├── useP5.<span class="hljs-keyword">js
</span>│   │       │   └── useP5List.<span class="hljs-keyword">js
</span>│   │       └── index.<span class="hljs-keyword">js
</span>├── tests
│   └── lib
│       └── p5
│           ├── integration
│           └── unit
│               ├── components
│               ├── <span class="hljs-built_in">context</span>
│               └── hooks</code></pre>

test files have not been created, only directories under tests/lib/p5</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Perfect, that’s a really clean separation: library code under <code>src/lib/p5</code>, and tests mirrored under <code>tests/lib/p5</code> with <code>unit</code> vs <code>integration</code>.</p>
<p>Here’s the structure in full with your requested layout:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! code-block hljs language-mipsasm" style="display: block;" data-highlighted="yes">├── src
│   ├── lib
│   │   └── p5
│   │       ├── components
│   │       │   ├── P5Canvas.<span class="hljs-keyword">jsx
</span>│   │       │   ├── P5Draw.<span class="hljs-keyword">jsx
</span>│   │       │   └── P5Setup.<span class="hljs-keyword">jsx
</span>│   │       ├── <span class="hljs-built_in">context</span>
│   │       │   ├── CanvasContext.<span class="hljs-keyword">jsx
</span>│   │       │   └── RegistryContext.<span class="hljs-keyword">jsx
</span>│   │       ├── hooks
│   │       │   ├── useP5.<span class="hljs-keyword">js
</span>│   │       │   └── useP5List.<span class="hljs-keyword">js
</span>│   │       └── index.<span class="hljs-keyword">js
</span>├── tests
│   └── lib
│       └── p5
│           ├── integration
│           │   └── (integration test files go here, e.g. <span class="hljs-keyword">multi-canvas </span><span class="hljs-keyword">scenarios)
</span>│           └── unit
│               ├── components
│               │   └── (unit test files for P5Canvas, P5Draw, P5Setup)
│               ├── <span class="hljs-built_in">context</span>
│               │   └── (unit test files for RegistryContext, CanvasContext)
│               └── hooks
│                   └── (unit test files for useP5, useP5List)
</code></pre>

<h3>📌 Notes</h3>
<ul>
<li>
<p><strong>Unit tests</strong> mirror the structure of <code>src/lib/p5</code> → easy to see where each test belongs.</p>
</li>
<li>
<p><strong>Integration tests</strong> live at <code>tests/lib/p5/integration</code> → for scenarios like “two canvases with different IDs work together,” “changing Setup triggers recreate,” “external button calls useP5 and interacts with canvas.”</p>
</li>
<li>
<p>You don’t need <code>__tests__</code> folders anymore, because you’re already controlling test discovery via directory layout and naming. Jest will still pick them up if you name them <code>*.test.js(x)</code> or <code>*.spec.js(x)</code>.</p>
</li>
<li>
<p>In <code>jest.config.js</code>, you’ll want to update the <code>roots</code> entry so Jest knows to look in <code>tests</code> as well, not just <code>src</code>:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">"jest-environment-jsdom"</span>,
  <span class="hljs-attr">roots</span>: [<span class="hljs-string">"&lt;rootDir&gt;/tests"</span>],  <span class="hljs-comment">// only run tests from /tests</span>
  <span class="hljs-attr">moduleFileExtensions</span>: [<span class="hljs-string">"js"</span>, <span class="hljs-string">"jsx"</span>],
  <span class="hljs-attr">transform</span>: {
    <span class="hljs-string">"^.+\\.(js|jsx)$"</span>: <span class="hljs-string">"babel-jest"</span>,
  },
  <span class="hljs-attr">setupFilesAfterEnv</span>: [<span class="hljs-string">"@testing-library/jest-dom"</span>],
};
</code></pre>
</li>
</ul>

<p>Do you want me to <strong>scaffold empty test files</strong> inside each <code>unit</code> subfolder (with just <code>describe()</code> + <code>it.todo()</code> blocks) so you can <code>npm run test</code> and see them all being discovered?</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Give me the file names for the integration and unit tests, and write the tests you've proposed in the appropriate files</div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Got it ✅ Let’s scaffold <strong>all the test files</strong> under your <code>tests/lib/p5</code> tree, drop in the smoke tests we discussed earlier, and split them into <strong>unit</strong> vs <strong>integration</strong>.</p>

<h1>📂 File tree with test files</h1>
<pre class="overflow-visible!"><code class="whitespace-pre! code-block hljs language-stylus" style="display: block;" data-highlighted="yes">tests
└── lib
    └── p5
        ├── integration
        │   └── multi-<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
        └── unit
            ├── components
            │   ├── P5Canvas<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
            │   ├── P5Draw<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
            │   └── P5Setup<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
            ├── context
            │   └── RegistryContext<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
            └── hooks
                ├── useP5<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
                └── useP5List<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.jsx</span>
</code></pre>

<h1>🧪 Unit tests</h1>
<h3><code>tests/lib/p5/unit/components/P5Canvas.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { render, screen, cleanup } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../../../src/lib/p5"</span>;

<span class="hljs-title function_">afterEach</span>(cleanup);

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"&lt;P5.Canvas&gt;"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"renders a div container"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-keyword">const</span> div = screen.<span class="hljs-title function_">getByRole</span>(<span class="hljs-string">"generic"</span>);
    <span class="hljs-title function_">expect</span>(div).<span class="hljs-title function_">toBeInTheDocument</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"unmounts cleanly"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { unmount } = <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-title function_">expect</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unmount</span>()).<span class="hljs-property">not</span>.<span class="hljs-title function_">toThrow</span>();
  });
});
</code></pre>

<h3><code>tests/lib/p5/unit/components/P5Setup.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../../../src/lib/p5"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"&lt;P5.Setup&gt;"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"mounts without crashing inside a canvas"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Setup</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );
  });
});
</code></pre>

<h3><code>tests/lib/p5/unit/components/P5Draw.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../../../src/lib/p5"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"&lt;P5.Draw&gt;"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"mounts without crashing inside a canvas"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );
  });
});
</code></pre>

<h3><code>tests/lib/p5/unit/context/RegistryContext.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../../src/lib/p5"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"RegistryContext"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"allows provider to render with no canvases"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>ok<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>);
  });
});
</code></pre>

<h3><code>tests/lib/p5/unit/hooks/useP5.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { renderHook } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span>, useP5 } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../../src/lib/p5"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"useP5 hook"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"throws if used outside provider"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { result } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-string">"foo"</span>));
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">error</span>).<span class="hljs-title function_">toBeTruthy</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"returns defaults if no canvas with id"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">wrapper</span> = (<span class="hljs-params">{ children }</span>) =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>;
    <span class="hljs-keyword">const</span> { result } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useP5</span>(<span class="hljs-string">"missing"</span>), { wrapper });
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>.<span class="hljs-property">ready</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);
  });
});
</code></pre>

<h3><code>tests/lib/p5/unit/hooks/useP5List.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { renderHook } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span>, useP5List } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../../src/lib/p5"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"useP5List hook"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"throws if used outside provider"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { result } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useP5List</span>());
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">error</span>).<span class="hljs-title function_">toBeTruthy</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"returns [] with no canvases"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">wrapper</span> = (<span class="hljs-params">{ children }</span>) =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>;
    <span class="hljs-keyword">const</span> { result } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useP5List</span>(), { wrapper });
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>).<span class="hljs-title function_">toEqual</span>([]);
  });
});
</code></pre>

<h1>🧪 Integration test</h1>
<h3><code>tests/lib/p5/integration/multi-canvas.test.jsx</code></h3>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span>, useP5List } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../src/lib/p5"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ListIds</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> ids = <span class="hljs-title function_">useP5List</span>();
  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-testid</span>=<span class="hljs-string">"ids"</span>&gt;</span>{ids.join(",")}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"integration: multiple canvases"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"registers multiple canvases in registry"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { getByTestId } = <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"a"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"b"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{200}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ListIds</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-keyword">const</span> ids = <span class="hljs-title function_">getByTestId</span>(<span class="hljs-string">"ids"</span>).<span class="hljs-property">textContent</span>;
    <span class="hljs-title function_">expect</span>(ids).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">"a"</span>);
    <span class="hljs-title function_">expect</span>(ids).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">"b"</span>);
  });
});
</code></pre>

<h2>✅ Notes</h2>
<ul>
<li>
<p>These tests are <strong>smoke-level</strong>: check mounting, registry, hook basics, multiple canvases.</p>
</li>
<li>
<p>They don’t attempt to inspect <em>actual p5 rendering</em>, since JSDOM doesn’t support <code>&lt;canvas&gt;</code> rendering anyway.</p>
</li>
<li>
<p>They confirm that context wiring, registration, and component APIs behave correctly.</p>
</li>
</ul>

<p>👉 Would you like me to also add a <strong>resize.test.jsx</strong> integration file, to specifically check that width/height prop changes call <code>resizeCanvas</code> instead of recreating? (We’d need to stub <code>p5.resizeCanvas</code> for that).</p></div>
        </div>
      
        <div class="message user-message">
          <div class="content">Please provide resize.test.jsx content and full path.
Then we need to address that jest cannot find the tests when run from the root dir (where tests, src, package.json are located):

<pre class="overflow-x-auto"><code data-highlighted="yes" class="hljs language-awk">npm run test

&gt; art-jam-i@<span class="hljs-number">0.0</span>.<span class="hljs-number">0</span> test
&gt; jest

No tests found, exiting with code <span class="hljs-number">1</span>
Run with `--passWithNoTests` to <span class="hljs-keyword">exit</span> with code <span class="hljs-number">0</span>
In <span class="hljs-regexp">/Users/</span>philippe<span class="hljs-regexp">/Documents/</span>GitHub<span class="hljs-regexp">/concordia/</span>cu-cart253<span class="hljs-regexp">/projects/</span>art-jam-i
  <span class="hljs-number">8</span> files checked.
  testMatch: **<span class="hljs-regexp">/__tests__/</span>**<span class="hljs-regexp">/*.?([mc])[jt]s?(x), **/</span>?(*.)+(spec|test).?([mc])[jt]s?(x) - <span class="hljs-number">0</span> matches
  testPathIgnorePatterns: <span class="hljs-regexp">/node_modules/</span> - <span class="hljs-number">8</span> matches
  testRegex:  - <span class="hljs-number">0</span> matches
Pattern:  - <span class="hljs-number">0</span> matches</code></pre></div>
        </div>
      
        <div class="message assistant-message">
          <div class="content"><p>Great — let’s tackle both parts:</p>

<h1>1️⃣ <code>resize.test.jsx</code></h1>
<p><strong>Full path:</strong></p>
<pre class="overflow-visible!"><code class="whitespace-pre! code-block hljs language-awk" style="display: block;" data-highlighted="yes">tests<span class="hljs-regexp">/lib/</span>p5<span class="hljs-regexp">/integration/</span>resize.test.jsx
</code></pre>
<p><strong>Content:</strong></p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-jsx code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { render, act } <span class="hljs-keyword">from</span> <span class="hljs-string">"@testing-library/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">P5</span>, useP5 } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../src/lib/p5"</span>;

<span class="hljs-comment">// Test helper: display size info from useP5</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ShowSize</span>(<span class="hljs-params">{ id }</span>) {
  <span class="hljs-keyword">const</span> { size } = <span class="hljs-title function_">useP5</span>(id);
  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-testid</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">size-</span>${<span class="hljs-attr">id</span>}`}&gt;</span>{`${size.width}x${size.height}`}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"integration: resize behavior"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"updates canvas size when width/height change"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { rerender, getByTestId } = <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ShowSize</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-comment">// initial size</span>
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">getByTestId</span>(<span class="hljs-string">"size-foo"</span>).<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"100x100"</span>);

    <span class="hljs-comment">// change width/height props</span>
    <span class="hljs-title function_">rerender</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{150}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ShowSize</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-comment">// should update without error</span>
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">getByTestId</span>(<span class="hljs-string">"size-foo"</span>).<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"200x150"</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"recreates canvas when renderer changes"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { rerender, getByTestId } = <span class="hljs-title function_">render</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"P2D"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ShowSize</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">getByTestId</span>(<span class="hljs-string">"size-foo"</span>).<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"100x100"</span>);

    <span class="hljs-comment">// Switch to WEBGL -&gt; should trigger recreate, but still ends up with new size</span>
    <span class="hljs-title function_">rerender</span>(
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">P5.ContextProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">P5.Canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">"WEBGL"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">P5.Draw</span> <span class="hljs-attr">fn</span>=<span class="hljs-string">{()</span> =&gt;</span> {}} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">P5.Canvas</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ShowSize</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"foo"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">P5.ContextProvider</span>&gt;</span></span>
    );

    <span class="hljs-comment">// We can only assert that size info is still valid after recreate</span>
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">getByTestId</span>(<span class="hljs-string">"size-foo"</span>).<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"100x100"</span>);
  });
});
</code></pre>
<p>This test checks:</p>
<ul>
<li>
<p>Width/height change updates the <code>size</code> reported by <code>useP5</code>.</p>
</li>
<li>
<p>Renderer change recreates the instance (we don’t check the actual teardown, but we confirm size info survives).</p>
</li>
</ul>

<h1>2️⃣ Why Jest didn’t find your tests</h1>
<p>By default Jest searches for files matching <code>*.test.js(x)</code> or <code>*.spec.js(x)</code> <strong>inside your project root</strong>.
Your tests are under <code>tests/…</code>, but your config currently says:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-attr">roots</span>: [<span class="hljs-string">"&lt;rootDir&gt;/src/lib/p5"</span>]
</code></pre>
<p>That tells Jest to only look inside <code>src/lib/p5</code>. That’s why it reports “0 matches.”</p>

<h1>3️⃣ Fix: Update <code>jest.config.js</code></h1>
<p>Change <code>roots</code> so it includes your <code>tests</code> folder:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">"jest-environment-jsdom"</span>,
  <span class="hljs-attr">roots</span>: [<span class="hljs-string">"&lt;rootDir&gt;/tests"</span>],   <span class="hljs-comment">// &lt;── only search under tests/</span>
  <span class="hljs-attr">moduleFileExtensions</span>: [<span class="hljs-string">"js"</span>, <span class="hljs-string">"jsx"</span>],
  <span class="hljs-attr">transform</span>: {
    <span class="hljs-string">"^.+\\.(js|jsx)$"</span>: <span class="hljs-string">"babel-jest"</span>,
  },
  <span class="hljs-attr">setupFilesAfterEnv</span>: [<span class="hljs-string">"@testing-library/jest-dom"</span>],
};
</code></pre>
<p>If you prefer Jest to also run any inline tests under <code>src/</code>, you can include both:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-js code-block hljs language-javascript" style="display: block;" data-highlighted="yes"><span class="hljs-attr">roots</span>: [<span class="hljs-string">"&lt;rootDir&gt;/tests"</span>, <span class="hljs-string">"&lt;rootDir&gt;/src"</span>],
</code></pre>

<h1>4️⃣ Verify</h1>
<p>Run:</p>
<pre class="overflow-visible!"><code class="whitespace-pre! language-bash code-block hljs" style="display: block;" data-highlighted="yes">npm run <span class="hljs-built_in">test</span>
</code></pre>
<p>Now Jest should discover files like:</p>
<ul>
<li>
<p><code>tests/lib/p5/unit/components/P5Canvas.test.jsx</code></p>
</li>
<li>
<p><code>tests/lib/p5/integration/resize.test.jsx</code></p>
</li>
</ul>
<p>and execute them.</p>

<p>👉 Do you want me to also show you how to <strong>mock/stub <code>p5.resizeCanvas</code></strong> in the resize test, so you can explicitly assert that it was called (instead of only checking <code>size</code> from context)?</p></div>
        </div>
      
          </div>
        </body>
      </html>
    